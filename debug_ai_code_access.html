<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIåŠ©æ•™ä»£ç¢¼ç²å–èª¿è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
    </style>
</head>
<body>
    <h1>ğŸ” AIåŠ©æ•™ä»£ç¢¼ç²å–èª¿è©¦å·¥å…·</h1>
    
    <div class="debug-section">
        <h2>ğŸ“‹ ç’°å¢ƒæª¢æŸ¥</h2>
        <button class="btn-primary" onclick="checkEnvironment()">æª¢æŸ¥ç’°å¢ƒ</button>
        <div id="envResults"></div>
    </div>
    
    <div class="debug-section">
        <h2>ğŸ”§ ä»£ç¢¼ç²å–æ¸¬è©¦</h2>
        <button class="btn-success" onclick="testCodeRetrieval()">æ¸¬è©¦ä»£ç¢¼ç²å–</button>
        <div id="codeResults"></div>
    </div>
    
    <div class="debug-section">
        <h2>ğŸ¤– AIåŠ©æ•™æ¨¡æ“¬æ¸¬è©¦</h2>
        <button class="btn-warning" onclick="simulateAIRequest()">æ¨¡æ“¬AIè«‹æ±‚</button>
        <div id="aiResults"></div>
    </div>
    
    <div class="debug-section">
        <h2>ğŸ“Š å¯¦æ™‚ç›£æ§</h2>
        <button class="btn-primary" onclick="startMonitoring()">é–‹å§‹ç›£æ§</button>
        <button class="btn-warning" onclick="stopMonitoring()">åœæ­¢ç›£æ§</button>
        <div id="monitorResults"></div>
    </div>

    <script>
        let monitoringInterval;
        
        function log(container, message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `[${timestamp}] ${message}`;
            document.getElementById(container).appendChild(div);
        }
        
        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }
        
        function checkEnvironment() {
            clearResults('envResults');
            
            // æª¢æŸ¥åŸºæœ¬å…¨åŸŸç‰©ä»¶
            log('envResults', `ğŸ” æª¢æŸ¥å…¨åŸŸç‰©ä»¶...`, 'info');
            log('envResults', `â€¢ window.Editor: ${!!window.Editor}`, window.Editor ? 'success' : 'error');
            log('envResults', `â€¢ window.editor: ${!!window.editor}`, window.editor ? 'success' : 'warning');
            log('envResults', `â€¢ window.wsManager: ${!!window.wsManager}`, window.wsManager ? 'success' : 'error');
            log('envResults', `â€¢ window.AutoLogin: ${!!window.AutoLogin}`, window.AutoLogin ? 'success' : 'warning');
            
            // æª¢æŸ¥Editoræ–¹æ³•
            if (window.Editor) {
                log('envResults', `ğŸ”§ æª¢æŸ¥Editoræ–¹æ³•...`, 'info');
                log('envResults', `â€¢ Editor.getCode: ${typeof window.Editor.getCode}`, 
                    typeof window.Editor.getCode === 'function' ? 'success' : 'error');
                log('envResults', `â€¢ Editor.setCode: ${typeof window.Editor.setCode}`, 
                    typeof window.Editor.setCode === 'function' ? 'success' : 'warning');
                log('envResults', `â€¢ Editor.editor: ${!!window.Editor.editor}`, 
                    window.Editor.editor ? 'success' : 'warning');
            }
            
            // æª¢æŸ¥DOMå…ƒç´ 
            log('envResults', `ğŸ–¼ï¸ æª¢æŸ¥DOMå…ƒç´ ...`, 'info');
            const codeMirror = document.querySelector('.CodeMirror');
            const codeEditor = document.querySelector('#codeEditor');
            const textareas = document.querySelectorAll('textarea');
            
            log('envResults', `â€¢ .CodeMirror: ${!!codeMirror}`, codeMirror ? 'success' : 'warning');
            log('envResults', `â€¢ #codeEditor: ${!!codeEditor}`, codeEditor ? 'success' : 'warning');
            log('envResults', `â€¢ textarea å…ƒç´ : ${textareas.length} å€‹`, textareas.length > 0 ? 'success' : 'warning');
            
            // æª¢æŸ¥localStorage
            log('envResults', `ğŸ’¾ æª¢æŸ¥localStorage...`, 'info');
            try {
                const keys = Object.keys(localStorage).filter(key => 
                    key.includes('code') || key.includes('python')
                );
                log('envResults', `â€¢ ç›¸é—œéµå€¼: ${keys.join(', ')}`, keys.length > 0 ? 'success' : 'warning');
            } catch (error) {
                log('envResults', `â€¢ localStorageéŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        function testCodeRetrieval() {
            clearResults('codeResults');
            
            log('codeResults', `ğŸ” é–‹å§‹ä»£ç¢¼ç²å–æ¸¬è©¦...`, 'info');
            
            // æ–¹æ¡ˆ1: window.Editor.getCode()
            if (window.Editor && typeof window.Editor.getCode === 'function') {
                try {
                    const code1 = window.Editor.getCode();
                    log('codeResults', `âœ… æ–¹æ¡ˆ1 window.Editor.getCode(): ${code1.length} å­—ç¬¦`, 'success');
                    if (code1.length > 0) {
                        log('codeResults', `<pre>${code1.substring(0, 100)}${code1.length > 100 ? '...' : ''}</pre>`, 'info');
                    }
                } catch (error) {
                    log('codeResults', `âŒ æ–¹æ¡ˆ1å¤±æ•—: ${error.message}`, 'error');
                }
            } else {
                log('codeResults', `âŒ æ–¹æ¡ˆ1ä¸å¯ç”¨: window.Editor.getCode ä¸å­˜åœ¨`, 'error');
            }
            
            // æ–¹æ¡ˆ2: window.editor.getValue()
            if (window.editor && typeof window.editor.getValue === 'function') {
                try {
                    const code2 = window.editor.getValue();
                    log('codeResults', `âœ… æ–¹æ¡ˆ2 window.editor.getValue(): ${code2.length} å­—ç¬¦`, 'success');
                    if (code2.length > 0) {
                        log('codeResults', `<pre>${code2.substring(0, 100)}${code2.length > 100 ? '...' : ''}</pre>`, 'info');
                    }
                } catch (error) {
                    log('codeResults', `âŒ æ–¹æ¡ˆ2å¤±æ•—: ${error.message}`, 'error');
                }
            } else {
                log('codeResults', `âš ï¸ æ–¹æ¡ˆ2ä¸å¯ç”¨: window.editor.getValue ä¸å­˜åœ¨`, 'warning');
            }
            
            // æ–¹æ¡ˆ3: DOM CodeMirror
            const codeMirror = document.querySelector('.CodeMirror');
            if (codeMirror && codeMirror.CodeMirror) {
                try {
                    const code3 = codeMirror.CodeMirror.getValue();
                    log('codeResults', `âœ… æ–¹æ¡ˆ3 DOM CodeMirror: ${code3.length} å­—ç¬¦`, 'success');
                    if (code3.length > 0) {
                        log('codeResults', `<pre>${code3.substring(0, 100)}${code3.length > 100 ? '...' : ''}</pre>`, 'info');
                    }
                } catch (error) {
                    log('codeResults', `âŒ æ–¹æ¡ˆ3å¤±æ•—: ${error.message}`, 'error');
                }
            } else {
                log('codeResults', `âš ï¸ æ–¹æ¡ˆ3ä¸å¯ç”¨: DOM CodeMirror ä¸å­˜åœ¨`, 'warning');
            }
            
            // æ–¹æ¡ˆ4: localStorage
            try {
                const roomId = (window.wsManager && window.wsManager.currentRoom) || 'general-room';
                const savedCode = localStorage.getItem(`python_code_${roomId}`) || 
                                localStorage.getItem('python_code') ||
                                localStorage.getItem('lastSavedCode');
                if (savedCode) {
                    log('codeResults', `âœ… æ–¹æ¡ˆ4 localStorage: ${savedCode.length} å­—ç¬¦`, 'success');
                    log('codeResults', `<pre>${savedCode.substring(0, 100)}${savedCode.length > 100 ? '...' : ''}</pre>`, 'info');
                } else {
                    log('codeResults', `âš ï¸ æ–¹æ¡ˆ4: localStorageä¸­ç„¡ç›¸é—œä»£ç¢¼`, 'warning');
                }
            } catch (error) {
                log('codeResults', `âŒ æ–¹æ¡ˆ4å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        async function simulateAIRequest() {
            clearResults('aiResults');
            
            log('aiResults', `ğŸ¤– æ¨¡æ“¬AIåŠ©æ•™è«‹æ±‚...`, 'info');
            
            // å˜—è©¦ç²å–ä»£ç¢¼
            let code = '';
            if (window.Editor && typeof window.Editor.getCode === 'function') {
                try {
                    code = window.Editor.getCode();
                    log('aiResults', `ğŸ“– ç²å–åˆ°ä»£ç¢¼: ${code.length} å­—ç¬¦`, 'success');
                } catch (error) {
                    log('aiResults', `âŒ ä»£ç¢¼ç²å–å¤±æ•—: ${error.message}`, 'error');
                    return;
                }
            } else {
                log('aiResults', `âŒ ç„¡æ³•ç²å–ä»£ç¢¼: window.Editor.getCode ä¸å¯ç”¨`, 'error');
                return;
            }
            
            if (!code || code.trim() === '') {
                log('aiResults', `âš ï¸ ä»£ç¢¼ç‚ºç©ºï¼Œç„¡æ³•é€²è¡ŒAIåˆ†æ`, 'warning');
                return;
            }
            
            // æ¨¡æ“¬AIè«‹æ±‚
            try {
                log('aiResults', `ğŸ“¡ ç™¼é€AIåˆ†æè«‹æ±‚...`, 'info');
                
                const response = await fetch('/api/ai.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'analyze',
                        code: code,
                        requestId: `debug_${Date.now()}`,
                        user_id: 1,
                        username: 'DebugUser'
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log('aiResults', `âœ… AIè«‹æ±‚æˆåŠŸ`, 'success');
                    log('aiResults', `â€¢ æ¨¡å¼: ${result.mode}`, 'info');
                    log('aiResults', `â€¢ ç‹€æ…‹: ${result.success}`, result.success ? 'success' : 'error');
                    
                    if (result.response) {
                        log('aiResults', `ğŸ“ AIå›æ‡‰é è¦½:`, 'info');
                        log('aiResults', `<pre>${result.response.substring(0, 200)}...</pre>`, 'info');
                    }
                } else {
                    log('aiResults', `âŒ AIè«‹æ±‚å¤±æ•—: HTTP ${response.status}`, 'error');
                    const errorText = await response.text();
                    log('aiResults', `éŒ¯èª¤è©³æƒ…: ${errorText}`, 'error');
                }
            } catch (error) {
                log('aiResults', `âŒ AIè«‹æ±‚ç•°å¸¸: ${error.message}`, 'error');
            }
        }
        
        function startMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
            
            clearResults('monitorResults');
            log('monitorResults', `ğŸ”„ é–‹å§‹å¯¦æ™‚ç›£æ§...`, 'info');
            
            monitoringInterval = setInterval(() => {
                const timestamp = new Date().toLocaleTimeString();
                
                // ç›£æ§ä»£ç¢¼é•·åº¦è®ŠåŒ–
                let codeLength = 0;
                if (window.Editor && typeof window.Editor.getCode === 'function') {
                    try {
                        const code = window.Editor.getCode();
                        codeLength = code.length;
                    } catch (error) {
                        // å¿½ç•¥éŒ¯èª¤
                    }
                }
                
                // ç›£æ§é€£æ¥ç‹€æ…‹
                const isConnected = window.wsManager ? window.wsManager.isConnected() : false;
                
                log('monitorResults', 
                    `[${timestamp}] ä»£ç¢¼: ${codeLength} å­—ç¬¦, é€£æ¥: ${isConnected ? 'âœ…' : 'âŒ'}`, 
                    'info');
            }, 2000);
        }
        
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                log('monitorResults', `â¹ï¸ ç›£æ§å·²åœæ­¢`, 'warning');
            }
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥ç’°å¢ƒ
        window.addEventListener('load', () => {
            setTimeout(checkEnvironment, 1000);
        });
    </script>
</body>
</html> 