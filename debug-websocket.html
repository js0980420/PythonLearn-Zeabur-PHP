<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket èª¿è©¦å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        #log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .info-box {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .info-box h4 {
            margin-top: 0;
            color: #495057;
        }
        .info-item {
            margin: 5px 0;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” WebSocket èª¿è©¦å·¥å…·</h1>
        
        <div class="grid">
            <div class="info-box">
                <h4>ğŸŒ ç’°å¢ƒä¿¡æ¯</h4>
                <div class="info-item">å”è­°: <span id="protocol"></span></div>
                <div class="info-item">ä¸»æ©Ÿ: <span id="hostname"></span></div>
                <div class="info-item">ç«¯å£: <span id="port"></span></div>
                <div class="info-item">å®Œæ•´ URL: <span id="fullUrl"></span></div>
                <div class="info-item">ç”¨æˆ¶ä»£ç†: <span id="userAgent"></span></div>
            </div>
            
            <div class="info-box">
                <h4>ğŸ”Œ WebSocket ä¿¡æ¯</h4>
                <div class="info-item">ç›®æ¨™ URL: <span id="wsUrl"></span></div>
                <div class="info-item">é€£æ¥ç‹€æ…‹: <span id="wsState">æœªé€£æ¥</span></div>
                <div class="info-item">æ”¯æ´ WebSocket: <span id="wsSupport"></span></div>
                <div class="info-item">æœ€å¾ŒéŒ¯èª¤: <span id="lastError">ç„¡</span></div>
            </div>
        </div>
        
        <div id="connectionStatus" class="status warning">
            â³ æº–å‚™é€£æ¥
        </div>
        
        <div>
            <button id="connectBtn" onclick="testConnection()">ğŸ”Œ æ¸¬è©¦é€£æ¥</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>ğŸ”Œ æ–·é–‹é€£æ¥</button>
            <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ</button>
            <button onclick="testMultipleUrls()">ğŸ”„ æ¸¬è©¦å¤šå€‹ URL</button>
        </div>
    </div>
    
    <div class="container">
        <h3>ğŸ“‹ è©³ç´°æ—¥èªŒ</h3>
        <div id="log"></div>
    </div>

    <script>
        let ws = null;
        let connectionStartTime = null;

        // åˆå§‹åŒ–é é¢ä¿¡æ¯
        function initializeInfo() {
            document.getElementById('protocol').textContent = window.location.protocol;
            document.getElementById('hostname').textContent = window.location.hostname;
            document.getElementById('port').textContent = window.location.port || '(é»˜èª)';
            document.getElementById('fullUrl').textContent = window.location.href;
            document.getElementById('userAgent').textContent = navigator.userAgent;
            
            // æª¢æŸ¥ WebSocket æ”¯æ´
            const wsSupported = 'WebSocket' in window;
            document.getElementById('wsSupport').textContent = wsSupported ? 'âœ… æ”¯æ´' : 'âŒ ä¸æ”¯æ´';
            document.getElementById('wsSupport').style.color = wsSupported ? 'green' : 'red';
            
            // è¨ˆç®— WebSocket URL
            const wsUrl = calculateWebSocketUrl();
            document.getElementById('wsUrl').textContent = wsUrl;
        }

        function calculateWebSocketUrl() {
            const hostname = window.location.hostname;
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return `ws://${hostname}:8081`;
            } else if (hostname.includes('replit.dev') || hostname.includes('repl.co')) {
                return `${protocol}//${hostname.replace(/:\d+/, '')}:8081`;
            } else {
                return `${protocol}//${hostname}/ws`;
            }
        }

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('log');
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(message, type) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        function updateButtons(connected) {
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
        }

        function updateWebSocketState(state) {
            const stateNames = {
                0: 'CONNECTING',
                1: 'OPEN',
                2: 'CLOSING',
                3: 'CLOSED'
            };
            document.getElementById('wsState').textContent = stateNames[state] || 'æœªçŸ¥';
        }

        function testConnection() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('WebSocket å·²ç¶“é€£æ¥', 'warning');
                return;
            }

            const wsUrl = calculateWebSocketUrl();
            log(`é–‹å§‹é€£æ¥æ¸¬è©¦...`);
            log(`ç›®æ¨™ URL: ${wsUrl}`);
            connectionStartTime = Date.now();
            
            try {
                // æª¢æŸ¥ WebSocket æ”¯æ´
                if (!('WebSocket' in window)) {
                    throw new Error('ç€è¦½å™¨ä¸æ”¯æ´ WebSocket');
                }

                log(`å‰µå»º WebSocket å°è±¡...`);
                ws = new WebSocket(wsUrl);
                updateWebSocketState(ws.readyState);

                // è¨­ç½®è¶…æ™‚
                const timeout = setTimeout(() => {
                    if (ws.readyState === WebSocket.CONNECTING) {
                        log('é€£æ¥è¶…æ™‚ (10ç§’)', 'error');
                        ws.close();
                        updateStatus('âŒ é€£æ¥è¶…æ™‚', 'error');
                        document.getElementById('lastError').textContent = 'é€£æ¥è¶…æ™‚';
                    }
                }, 10000);

                ws.onopen = function(event) {
                    clearTimeout(timeout);
                    const connectionTime = Date.now() - connectionStartTime;
                    log(`WebSocket é€£æ¥æˆåŠŸï¼è€—æ™‚: ${connectionTime}ms`, 'success');
                    log(`é€£æ¥äº‹ä»¶è©³æƒ…: ${JSON.stringify({
                        type: event.type,
                        target: event.target.constructor.name,
                        readyState: event.target.readyState
                    })}`, 'info');
                    
                    updateStatus('âœ… é€£æ¥æˆåŠŸ', 'success');
                    updateButtons(true);
                    updateWebSocketState(ws.readyState);
                    document.getElementById('lastError').textContent = 'ç„¡';
                    
                    // ç™¼é€æ¸¬è©¦æ¶ˆæ¯
                    setTimeout(() => {
                        sendTestMessage();
                    }, 1000);
                };

                ws.onmessage = function(event) {
                    log(`æ”¶åˆ°æ¶ˆæ¯: ${event.data}`, 'success');
                    try {
                        const data = JSON.parse(event.data);
                        log(`è§£æå¾Œçš„æ¶ˆæ¯: ${JSON.stringify(data, null, 2)}`, 'info');
                    } catch (e) {
                        log(`ç„¡æ³•è§£æç‚º JSON: ${e.message}`, 'warning');
                    }
                };

                ws.onclose = function(event) {
                    clearTimeout(timeout);
                    log(`WebSocket é€£æ¥é—œé–‰`, 'warning');
                    log(`é—œé–‰è©³æƒ…: ä»£ç¢¼=${event.code}, åŸå› ="${event.reason}", ä¹¾æ·¨é—œé–‰=${event.wasClean}`, 'info');
                    
                    updateStatus('ğŸ”Œ é€£æ¥å·²é—œé–‰', 'warning');
                    updateButtons(false);
                    updateWebSocketState(ws.readyState);
                    
                    // å¸¸è¦‹éŒ¯èª¤ä»£ç¢¼èªªæ˜
                    const errorCodes = {
                        1000: 'æ­£å¸¸é—œé–‰',
                        1001: 'ç«¯é»é›¢é–‹',
                        1002: 'å”è­°éŒ¯èª¤',
                        1003: 'ä¸æ”¯æ´çš„æ•¸æ“šé¡å‹',
                        1006: 'ç•°å¸¸é—œé–‰ (é€šå¸¸æ˜¯ç¶²è·¯å•é¡Œ)',
                        1011: 'æœå‹™å™¨éŒ¯èª¤',
                        1015: 'TLS æ¡æ‰‹å¤±æ•—'
                    };
                    
                    const errorDesc = errorCodes[event.code] || 'æœªçŸ¥éŒ¯èª¤';
                    log(`éŒ¯èª¤ä»£ç¢¼èªªæ˜: ${errorDesc}`, 'info');
                    document.getElementById('lastError').textContent = `${event.code}: ${errorDesc}`;
                };

                ws.onerror = function(error) {
                    clearTimeout(timeout);
                    log(`WebSocket éŒ¯èª¤äº‹ä»¶è§¸ç™¼`, 'error');
                    log(`éŒ¯èª¤å°è±¡: ${JSON.stringify(error)}`, 'error');
                    
                    updateStatus('âŒ é€£æ¥éŒ¯èª¤', 'error');
                    updateButtons(false);
                    updateWebSocketState(ws.readyState);
                    document.getElementById('lastError').textContent = 'WebSocket éŒ¯èª¤äº‹ä»¶';
                };

            } catch (error) {
                log(`å‰µå»º WebSocket å¤±æ•—: ${error.message}`, 'error');
                log(`éŒ¯èª¤å †ç–Š: ${error.stack}`, 'error');
                updateStatus('âŒ å‰µå»ºå¤±æ•—', 'error');
                document.getElementById('lastError').textContent = error.message;
            }
        }

        function sendTestMessage() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const testMessage = {
                    type: 'ping',
                    timestamp: Date.now(),
                    test: true
                };
                
                log(`ç™¼é€æ¸¬è©¦æ¶ˆæ¯: ${JSON.stringify(testMessage)}`, 'info');
                ws.send(JSON.stringify(testMessage));
            } else {
                log('ç„¡æ³•ç™¼é€æ¸¬è©¦æ¶ˆæ¯ï¼šWebSocket æœªé€£æ¥', 'error');
            }
        }

        function disconnect() {
            if (ws) {
                log('æ‰‹å‹•æ–·é–‹é€£æ¥...', 'info');
                ws.close(1000, 'ç”¨æˆ¶æ‰‹å‹•æ–·é–‹');
            }
        }

        function testMultipleUrls() {
            const urls = [
                'ws://localhost:8081',
                'ws://127.0.0.1:8081',
                'ws://localhost:8080',
                'ws://127.0.0.1:8080'
            ];
            
            log('é–‹å§‹æ¸¬è©¦å¤šå€‹ URL...', 'info');
            
            urls.forEach((url, index) => {
                setTimeout(() => {
                    log(`æ¸¬è©¦ URL ${index + 1}/${urls.length}: ${url}`, 'info');
                    testSingleUrl(url);
                }, index * 2000);
            });
        }

        function testSingleUrl(url) {
            const testWs = new WebSocket(url);
            const startTime = Date.now();
            
            const timeout = setTimeout(() => {
                testWs.close();
                log(`${url} - è¶…æ™‚`, 'error');
            }, 5000);
            
            testWs.onopen = function() {
                clearTimeout(timeout);
                const time = Date.now() - startTime;
                log(`${url} - é€£æ¥æˆåŠŸ (${time}ms)`, 'success');
                testWs.close();
            };
            
            testWs.onerror = function() {
                clearTimeout(timeout);
                log(`${url} - é€£æ¥å¤±æ•—`, 'error');
            };
            
            testWs.onclose = function(event) {
                if (event.code !== 1000) {
                    log(`${url} - é—œé–‰ (ä»£ç¢¼: ${event.code})`, 'warning');
                }
            };
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.onload = function() {
            initializeInfo();
            log('WebSocket èª¿è©¦å·¥å…·å·²è¼‰å…¥', 'info');
            log('é»æ“Š "æ¸¬è©¦é€£æ¥" é–‹å§‹è¨ºæ–·', 'info');
        };
    </script>
</body>
</html> 