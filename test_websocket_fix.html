<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket å”è­°ä¿®å¾©æ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .log { height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin: 10px 0; background: #f8f9fa; font-family: monospace; font-size: 12px; }
        button { margin: 5px; padding: 8px 16px; }
        input { margin: 5px; padding: 5px; }
        .user-list { background: #e9ecef; padding: 10px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ WebSocket å”è­°ä¿®å¾©æ¸¬è©¦</h1>
        
        <div class="status" id="connectionStatus">
            â³ æº–å‚™é€£æ¥...
        </div>
        
        <div>
            <label>æˆ¿é–“åç¨±: <input type="text" id="roomName" value="test_room_1" /></label>
            <label>ç”¨æˆ¶åç¨±: <input type="text" id="userName" value="æ¸¬è©¦ç”¨æˆ¶1" /></label>
            <button onclick="connect()">é€£æ¥</button>
            <button onclick="disconnect()">æ–·é–‹</button>
        </div>
        
        <div>
            <h3>ğŸ“‹ æ¸¬è©¦æ“ä½œ</h3>
            <button onclick="testJoinRoom()">æ¸¬è©¦åŠ å…¥æˆ¿é–“</button>
            <button onclick="testCodeChange()">æ¸¬è©¦ä»£ç¢¼è®Šæ›´</button>
            <button onclick="testSaveCode()">æ¸¬è©¦ä¿å­˜ä»£ç¢¼</button>
            <button onclick="testLoadCode()">æ¸¬è©¦è¼‰å…¥ä»£ç¢¼</button>
            <button onclick="testHeartbeat()">æ¸¬è©¦å¿ƒè·³</button>
            <button onclick="testAIRequest()">æ¸¬è©¦AIè«‹æ±‚</button>
        </div>
        
        <div class="user-list" id="userList">
            <strong>åœ¨ç·šç”¨æˆ¶:</strong> <span id="onlineUsers">ç„¡</span>
        </div>
        
        <div>
            <h3>ğŸ“ å¯¦æ™‚æ—¥èªŒ</h3>
            <div class="log" id="logContainer"></div>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥èªŒ</button>
        </div>
    </div>

    <script>
        let ws = null;
        let currentRoom = null;
        let currentUser = null;
        
        // è¨˜éŒ„å‡½æ•¸
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('logContainer');
            const logItem = document.createElement('div');
            logItem.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'black';
            logItem.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logItem);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        // æ›´æ–°é€£æ¥ç‹€æ…‹
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `status ${type}`;
            statusEl.innerHTML = message;
        }
        
        // é€£æ¥WebSocket
        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('âŒ å·²ç¶“é€£æ¥ï¼Œè«‹å…ˆæ–·é–‹', 'warning');
                return;
            }
            
            currentRoom = document.getElementById('roomName').value;
            currentUser = document.getElementById('userName').value;
            
            if (!currentRoom || !currentUser) {
                log('âŒ è«‹è¼¸å…¥æˆ¿é–“åç¨±å’Œç”¨æˆ¶åç¨±', 'error');
                return;
            }
            
            log('ğŸ”Œ æ­£åœ¨é€£æ¥ WebSocket...', 'info');
            updateStatus('â³ æ­£åœ¨é€£æ¥...', 'warning');
            
            try {
                ws = new WebSocket('ws://localhost:8080');
                
                ws.onopen = function(event) {
                    log('âœ… WebSocket é€£æ¥æˆåŠŸ', 'success');
                    updateStatus('âœ… å·²é€£æ¥', 'success');
                    
                    // è‡ªå‹•åŠ å…¥æˆ¿é–“
                    testJoinRoom();
                };
                
                ws.onmessage = function(event) {
                    try {
                        const message = JSON.parse(event.data);
                        handleMessage(message);
                    } catch (error) {
                        log(`âŒ è§£ææ¶ˆæ¯å¤±æ•—: ${error.message}`, 'error');
                        log(`åŸå§‹æ•¸æ“š: ${event.data}`, 'error');
                    }
                };
                
                ws.onclose = function(event) {
                    log(`ğŸ”Œ WebSocket é€£æ¥é—œé–‰: ${event.code} - ${event.reason}`, 'warning');
                    updateStatus('âŒ é€£æ¥å·²é—œé–‰', 'error');
                };
                
                ws.onerror = function(error) {
                    log(`âŒ WebSocket éŒ¯èª¤: ${error}`, 'error');
                    updateStatus('âŒ é€£æ¥éŒ¯èª¤', 'error');
                };
                
            } catch (error) {
                log(`âŒ å»ºç«‹é€£æ¥å¤±æ•—: ${error.message}`, 'error');
                updateStatus('âŒ é€£æ¥å¤±æ•—', 'error');
            }
        }
        
        // æ–·é–‹é€£æ¥
        function disconnect() {
            if (ws) {
                ws.close(1000, 'ç”¨æˆ¶ä¸»å‹•æ–·é–‹');
                ws = null;
                log('ğŸ‘‹ å·²æ–·é–‹é€£æ¥', 'info');
                updateStatus('âŒ å·²æ–·é–‹', 'info');
            }
        }
        
        // ç™¼é€æ¶ˆæ¯
        function sendMessage(message) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('âŒ WebSocket æœªé€£æ¥', 'error');
                return false;
            }
            
            try {
                ws.send(JSON.stringify(message));
                log(`ğŸ“¤ ç™¼é€æ¶ˆæ¯: ${message.type}`, 'info');
                log(`ğŸ“¤ æ¶ˆæ¯å…§å®¹: ${JSON.stringify(message, null, 2)}`, 'info');
                return true;
            } catch (error) {
                log(`âŒ ç™¼é€æ¶ˆæ¯å¤±æ•—: ${error.message}`, 'error');
                return false;
            }
        }
        
        // è™•ç†æ”¶åˆ°çš„æ¶ˆæ¯
        function handleMessage(message) {
            log(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${message.type}`, 'success');
            log(`ğŸ“¨ æ¶ˆæ¯å…§å®¹: ${JSON.stringify(message, null, 2)}`, 'success');
            
            switch (message.type) {
                case 'room_joined':
                    updateStatus(`âœ… å·²åŠ å…¥æˆ¿é–“: ${message.room_id}`, 'success');
                    updateUserList(message.users);
                    break;
                
                case 'join_room_error':
                    log(`âŒ åŠ å…¥æˆ¿é–“å¤±æ•—: ${message.message}`, 'error');
                    break;
                
                case 'user_joined':
                    log(`ğŸ‘¤ ç”¨æˆ¶åŠ å…¥: ${message.username}`, 'info');
                    updateUserList(message.users);
                    break;
                
                case 'user_left':
                    log(`ğŸ‘‹ ç”¨æˆ¶é›¢é–‹: ${message.user_id}`, 'info');
                    updateUserList(message.users);
                    break;
                
                case 'code_change':
                    log(`ğŸ“ ä»£ç¢¼è®Šæ›´: ${message.username}`, 'info');
                    break;
                
                case 'code_saved':
                    log(`ğŸ’¾ ä»£ç¢¼ä¿å­˜æˆåŠŸ: ${message.save_name}`, 'success');
                    break;
                
                case 'code_loaded':
                    log(`ğŸ“‚ ä»£ç¢¼è¼‰å…¥æˆåŠŸ`, 'success');
                    break;
                
                case 'pong':
                    log(`ğŸ’“ æ”¶åˆ°å¿ƒè·³å›æ‡‰`, 'success');
                    break;
                
                case 'ai_response':
                    log(`ğŸ¤– AI å›æ‡‰: ${message.success ? 'æˆåŠŸ' : 'å¤±æ•—'}`, message.success ? 'success' : 'error');
                    break;
                
                case 'error':
                    log(`âŒ æœå‹™å™¨éŒ¯èª¤: ${message.message}`, 'error');
                    break;
                
                default:
                    log(`âš ï¸ æœªçŸ¥æ¶ˆæ¯é¡å‹: ${message.type}`, 'warning');
            }
        }
        
        // æ›´æ–°ç”¨æˆ¶åˆ—è¡¨
        function updateUserList(users) {
            const onlineUsersEl = document.getElementById('onlineUsers');
            if (!users || users.length === 0) {
                onlineUsersEl.textContent = 'ç„¡';
                return;
            }
            
            const userNames = users.map(user => user.userName || user.username || user.name || 'åŒ¿åç”¨æˆ¶');
            onlineUsersEl.textContent = userNames.join(', ');
            log(`ğŸ‘¥ ç”¨æˆ¶åˆ—è¡¨æ›´æ–°: ${userNames.join(', ')}`, 'info');
        }
        
        // æ¸¬è©¦å‡½æ•¸
        function testJoinRoom() {
            sendMessage({
                type: 'join_room',
                room_id: currentRoom,
                user_id: currentUser,
                username: currentUser
            });
        }
        
        function testCodeChange() {
            sendMessage({
                type: 'code_change',
                room_id: currentRoom,
                user_id: currentUser,
                username: currentUser,
                code: `# æ¸¬è©¦ä»£ç¢¼è®Šæ›´ ${new Date().toLocaleTimeString()}\nprint("Hello from ${currentUser}!")`,
                timestamp: Date.now()
            });
        }
        
        function testSaveCode() {
            sendMessage({
                type: 'save_code',
                room_id: currentRoom,
                user_id: currentUser,
                code: `# æ¸¬è©¦ä¿å­˜ ${new Date().toLocaleTimeString()}\nprint("Saved by ${currentUser}")`,
                save_name: `æ¸¬è©¦ä¿å­˜_${new Date().toLocaleTimeString()}`
            });
        }
        
        function testLoadCode() {
            sendMessage({
                type: 'load_code',
                room_id: currentRoom,
                user_id: currentUser,
                current_version: 1
            });
        }
        
        function testHeartbeat() {
            sendMessage({
                type: 'ping'
            });
        }
        
        function testAIRequest() {
            sendMessage({
                type: 'ai_request',
                room_id: currentRoom,
                user_id: currentUser,
                action: 'analyze',
                code: 'print("Hello, AI!")',
                message: 'è«‹å¹«æˆ‘åˆ†æé€™æ®µä»£ç¢¼'
            });
        }
        
        // æ¸…ç©ºæ—¥èªŒ
        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
        }
        
        // é é¢è¼‰å…¥æ™‚çš„åˆå§‹åŒ–
        window.onload = function() {
            log('ğŸš€ æ¸¬è©¦é é¢å·²è¼‰å…¥', 'info');
            log('ğŸ“‹ è«‹é»æ“Šã€Œé€£æ¥ã€é–‹å§‹æ¸¬è©¦', 'info');
        };
    </script>
</body>
</html> 