<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket å…¨é¢æ¸¬è©¦ - å”è­°ä¿®å¾©é©—è­‰</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .log-area { height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-connected { background-color: #28a745; }
        .status-disconnected { background-color: #dc3545; }
        .status-connecting { background-color: #ffc107; }
        .user-info { background: #e3f2fd; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .message-count { font-weight: bold; color: #007bff; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>ğŸ”§ WebSocket å”è­°ä¿®å¾©å…¨é¢æ¸¬è©¦</h1>
        <p class="text-muted">æ¸¬è©¦ä¿®å¾©å¾Œçš„ WebSocket å”è­°ä¸€è‡´æ€§å’Œç”¨æˆ¶åˆ—è¡¨åŠŸèƒ½</p>

        <!-- é€£æ¥ç‹€æ…‹å€åŸŸ -->
        <div class="test-section">
            <h3>ğŸ“¡ é€£æ¥ç‹€æ…‹</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-3">
                        <span id="connectionStatus" class="status-indicator status-disconnected"></span>
                        <span>WebSocket ç‹€æ…‹: <span id="statusText">æœªé€£æ¥</span></span>
                    </div>
                    
                    <div class="input-group mb-3">
                        <input type="text" id="roomNameInput" class="form-control" placeholder="æˆ¿é–“åç¨±" value="test_room_123">
                        <input type="text" id="userNameInput" class="form-control" placeholder="ç”¨æˆ¶åç¨±" value="æ¸¬è©¦ç”¨æˆ¶_1">
                        <button class="btn btn-primary" onclick="connectToRoom()">åŠ å…¥æˆ¿é–“</button>
                    </div>
                    
                    <button class="btn btn-secondary me-2" onclick="disconnect()">æ–·é–‹é€£æ¥</button>
                    <button class="btn btn-info me-2" onclick="sendHeartbeat()">æ¸¬è©¦å¿ƒè·³</button>
                    <button class="btn btn-warning" onclick="clearLogs()">æ¸…ç©ºæ—¥èªŒ</button>
                </div>
                
                <div class="col-md-6">
                    <div class="user-info">
                        <h6>æˆ¿é–“ä¿¡æ¯</h6>
                        <div>æˆ¿é–“ID: <span id="currentRoom">-</span></div>
                        <div>ç•¶å‰ç”¨æˆ¶: <span id="currentUser">-</span></div>
                        <div>é€£æ¥æ™‚é–“: <span id="connectionTime">-</span></div>
                        <div>æ¶ˆæ¯è¨ˆæ•¸: <span id="messageCount" class="message-count">0</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç”¨æˆ¶åˆ—è¡¨æ¸¬è©¦å€åŸŸ -->
        <div class="test-section">
            <h3>ğŸ‘¥ ç”¨æˆ¶åˆ—è¡¨æ¸¬è©¦</h3>
            <div class="row">
                <div class="col-md-6">
                    <h6>åœ¨ç·šç”¨æˆ¶åˆ—è¡¨</h6>
                    <div id="userListDisplay" class="border p-3 mb-3" style="min-height: 100px; background: #f8f9fa;">
                        <em class="text-muted">ç­‰å¾…ç”¨æˆ¶æ•¸æ“š...</em>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="requestUserList()">åˆ·æ–°ç”¨æˆ¶åˆ—è¡¨</button>
                        <button class="btn btn-sm btn-outline-info" onclick="simulateUserJoin()">æ¨¡æ“¬ç”¨æˆ¶åŠ å…¥</button>
                        <button class="btn btn-sm btn-outline-warning" onclick="simulateUserLeave()">æ¨¡æ“¬ç”¨æˆ¶é›¢é–‹</button>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <h6>ç”¨æˆ¶æ•¸æ“šçµæ§‹åˆ†æ</h6>
                    <div id="userDataAnalysis" class="border p-3" style="min-height: 100px; background: #f0f8ff; font-family: monospace; font-size: 12px;">
                        <em class="text-muted">ç­‰å¾…ç”¨æˆ¶æ•¸æ“š...</em>
                    </div>
                </div>
            </div>
        </div>

        <!-- åŠŸèƒ½æ¸¬è©¦å€åŸŸ -->
        <div class="test-section">
            <h3>ğŸ§ª åŠŸèƒ½æ¸¬è©¦</h3>
            <div class="row">
                <div class="col-md-6">
                    <h6>ä»£ç¢¼æ“ä½œæ¸¬è©¦</h6>
                    <textarea id="testCode" class="form-control mb-2" rows="4" placeholder="æ¸¬è©¦ä»£ç¢¼...">print("Hello from WebSocket test!")</textarea>
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-sm btn-success" onclick="testCodeChange()">ç™¼é€ä»£ç¢¼è®Šæ›´</button>
                        <button class="btn btn-sm btn-info" onclick="testSaveCode()">æ¸¬è©¦ä¿å­˜ä»£ç¢¼</button>
                        <button class="btn btn-sm btn-secondary" onclick="testLoadCode()">æ¸¬è©¦è¼‰å…¥ä»£ç¢¼</button>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <h6>AI åŠ©æ•™æ¸¬è©¦</h6>
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-sm btn-outline-primary" onclick="testAIExplain()">è§£é‡‹ä»£ç¢¼</button>
                        <button class="btn btn-sm btn-outline-success" onclick="testAICheck()">éŒ¯èª¤æª¢æŸ¥</button>
                        <button class="btn btn-sm btn-outline-info" onclick="testAIImprove()">æ”¹é€²å»ºè­°</button>
                    </div>
                    
                    <h6>éŒ¯èª¤æ¸¬è©¦</h6>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-danger" onclick="testInvalidMessage()">ç„¡æ•ˆæ¶ˆæ¯</button>
                        <button class="btn btn-sm btn-outline-warning" onclick="testMissingParams()">ç¼ºå°‘åƒæ•¸</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¯¦æ™‚æ—¥èªŒå€åŸŸ -->
        <div class="test-section">
            <h3>ğŸ“ å¯¦æ™‚æ—¥èªŒ</h3>
            <div id="logOutput" class="log-area"></div>
        </div>
    </div>

    <script>
        let websocket = null;
        let messageCount = 0;
        let connectionStartTime = null;
        let currentRoomId = null;
        let currentUserId = null;

        // æ·»åŠ æ—¥èªŒ
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('logOutput');
            const colorClass = {
                'info': 'text-primary',
                'success': 'text-success', 
                'warning': 'text-warning',
                'error': 'text-danger'
            }[type] || 'text-dark';
            
            logArea.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
        function updateStatus(status, text) {
            const indicator = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            indicator.className = `status-indicator status-${status}`;
            statusText.textContent = text;
        }

        // æ›´æ–°æ¶ˆæ¯è¨ˆæ•¸
        function updateMessageCount() {
            messageCount++;
            document.getElementById('messageCount').textContent = messageCount;
        }

        // é€£æ¥åˆ°æˆ¿é–“
        function connectToRoom() {
            const roomName = document.getElementById('roomNameInput').value.trim();
            const userName = document.getElementById('userNameInput').value.trim();
            
            if (!roomName || !userName) {
                addLog('âŒ è«‹å¡«å¯«æˆ¿é–“åç¨±å’Œç”¨æˆ¶åç¨±', 'error');
                return;
            }

            if (websocket && websocket.readyState === WebSocket.OPEN) {
                addLog('âš ï¸ WebSocket å·²é€£æ¥ï¼Œå…ˆæ–·é–‹ç¾æœ‰é€£æ¥', 'warning');
                websocket.close();
            }

            addLog(`ğŸ”„ æ­£åœ¨é€£æ¥åˆ° WebSocket æœå‹™å™¨...`, 'info');
            updateStatus('connecting', 'é€£æ¥ä¸­...');

            try {
                websocket = new WebSocket('ws://localhost:8080');
                
                websocket.onopen = function() {
                    addLog('âœ… WebSocket é€£æ¥æˆåŠŸ', 'success');
                    updateStatus('connected', 'å·²é€£æ¥');
                    connectionStartTime = new Date();
                    document.getElementById('connectionTime').textContent = connectionStartTime.toLocaleTimeString();
                    
                    // ç™¼é€åŠ å…¥æˆ¿é–“æ¶ˆæ¯
                    const joinMessage = {
                        type: 'join_room',
                        room_id: roomName,
                        user_id: userName,
                        username: userName
                    };
                    
                    addLog(`ğŸ“¤ ç™¼é€åŠ å…¥æˆ¿é–“æ¶ˆæ¯: ${JSON.stringify(joinMessage)}`, 'info');
                    websocket.send(JSON.stringify(joinMessage));
                    
                    currentRoomId = roomName;
                    currentUserId = userName;
                    document.getElementById('currentRoom').textContent = roomName;
                    document.getElementById('currentUser').textContent = userName;
                };

                websocket.onmessage = function(event) {
                    updateMessageCount();
                    
                    try {
                        const message = JSON.parse(event.data);
                        addLog(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${message.type}`, 'success');
                        addLog(`ğŸ“‹ å®Œæ•´å…§å®¹: ${JSON.stringify(message, null, 2)}`, 'info');
                        
                        // è™•ç†ç‰¹å®šæ¶ˆæ¯é¡å‹
                        handleSpecificMessage(message);
                        
                    } catch (e) {
                        addLog(`âŒ è§£ææ¶ˆæ¯å¤±æ•—: ${e.message}`, 'error');
                        addLog(`ğŸ“„ åŸå§‹æ•¸æ“š: ${event.data}`, 'error');
                    }
                };

                websocket.onerror = function(error) {
                    addLog(`âŒ WebSocket éŒ¯èª¤: ${error}`, 'error');
                    updateStatus('disconnected', 'é€£æ¥éŒ¯èª¤');
                };

                websocket.onclose = function(event) {
                    addLog(`ğŸ”Œ WebSocket é€£æ¥é—œé–‰ (ä»£ç¢¼: ${event.code}, åŸå› : ${event.reason || 'æœªçŸ¥'})`, 'warning');
                    updateStatus('disconnected', 'å·²æ–·é–‹');
                    currentRoomId = null;
                    currentUserId = null;
                    document.getElementById('currentRoom').textContent = '-';
                    document.getElementById('currentUser').textContent = '-';
                };

            } catch (error) {
                addLog(`âŒ å‰µå»º WebSocket é€£æ¥å¤±æ•—: ${error.message}`, 'error');
                updateStatus('disconnected', 'é€£æ¥å¤±æ•—');
            }
        }

        // è™•ç†ç‰¹å®šæ¶ˆæ¯é¡å‹
        function handleSpecificMessage(message) {
            switch (message.type) {
                case 'room_joined':
                    addLog(`ğŸ‰ æˆåŠŸåŠ å…¥æˆ¿é–“ ${message.room_id}`, 'success');
                    if (message.users) {
                        updateUserList(message.users);
                        addLog(`ğŸ‘¥ æˆ¿é–“å…§ç”¨æˆ¶æ•¸: ${message.users.length}`, 'info');
                    }
                    if (message.current_code) {
                        document.getElementById('testCode').value = message.current_code;
                        addLog(`ğŸ“ è¼‰å…¥æˆ¿é–“ä»£ç¢¼ (${message.current_code.length} å­—ç¬¦)`, 'info');
                    }
                    break;

                case 'user_joined':
                    addLog(`ğŸ‘¤ ç”¨æˆ¶ ${message.username} åŠ å…¥æˆ¿é–“`, 'info');
                    if (message.users) {
                        updateUserList(message.users);
                    }
                    break;

                case 'user_left':
                    addLog(`ğŸ‘‹ ç”¨æˆ¶ ${message.user_id} é›¢é–‹æˆ¿é–“`, 'info');
                    if (message.users) {
                        updateUserList(message.users);
                    }
                    break;

                case 'error':
                    addLog(`âŒ æœå‹™å™¨éŒ¯èª¤: ${message.error}`, 'error');
                    if (message.details) {
                        addLog(`ğŸ“‹ éŒ¯èª¤è©³æƒ…: ${message.details}`, 'error');
                    }
                    break;

                case 'pong':
                    addLog(`ğŸ’“ å¿ƒè·³éŸ¿æ‡‰æ­£å¸¸`, 'success');
                    break;

                case 'ai_response':
                    if (message.success) {
                        addLog(`ğŸ¤– AI éŸ¿æ‡‰æˆåŠŸ`, 'success');
                    } else {
                        addLog(`ğŸ¤– AI éŸ¿æ‡‰å¤±æ•—: ${message.error}`, 'error');
                    }
                    break;

                default:
                    addLog(`ğŸ“ å…¶ä»–æ¶ˆæ¯é¡å‹: ${message.type}`, 'info');
            }
        }

        // æ›´æ–°ç”¨æˆ¶åˆ—è¡¨é¡¯ç¤º
        function updateUserList(users) {
            const userListDiv = document.getElementById('userListDisplay');
            const analysisDiv = document.getElementById('userDataAnalysis');
            
            if (!users || users.length === 0) {
                userListDiv.innerHTML = '<em class="text-muted">æˆ¿é–“å…§æš«ç„¡å…¶ä»–ç”¨æˆ¶</em>';
                analysisDiv.innerHTML = '<em class="text-muted">ç„¡ç”¨æˆ¶æ•¸æ“š</em>';
                return;
            }

            // é¡¯ç¤ºç”¨æˆ¶åˆ—è¡¨
            let userListHTML = '<strong>æˆ¿é–“å…§ç”¨æˆ¶:</strong><br>';
            users.forEach((user, index) => {
                const status = 'ğŸŸ¢'; // åœ¨ç·šç‹€æ…‹
                const userName = user.username || user.userName || user.name || 'æœªçŸ¥ç”¨æˆ¶';
                userListHTML += `${status} ${userName} (${user.user_id})<br>`;
            });
            userListDiv.innerHTML = userListHTML;

            // é¡¯ç¤ºæ•¸æ“šçµæ§‹åˆ†æ
            const analysisHTML = users.map((user, index) => {
                return `ç”¨æˆ¶ ${index + 1}:
  user_id: "${user.user_id}"
  username: "${user.username}"
  join_time: ${user.join_time}`;
            }).join('\n\n');
            
            analysisDiv.innerHTML = `<pre>${analysisHTML}</pre>`;
            
            addLog(`ğŸ‘¥ ç”¨æˆ¶åˆ—è¡¨å·²æ›´æ–°: ${users.length} å€‹ç”¨æˆ¶`, 'success');
        }

        // æ¸¬è©¦å‡½æ•¸
        function sendHeartbeat() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                addLog('âŒ WebSocket æœªé€£æ¥', 'error');
                return;
            }
            
            const pingMessage = { type: 'ping' };
            addLog(`ğŸ’“ ç™¼é€å¿ƒè·³: ${JSON.stringify(pingMessage)}`, 'info');
            websocket.send(JSON.stringify(pingMessage));
        }

        function testCodeChange() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                addLog('âŒ WebSocket æœªé€£æ¥', 'error');
                return;
            }
            
            const code = document.getElementById('testCode').value;
            const message = {
                type: 'code_change',
                room_id: currentRoomId,
                user_id: currentUserId,
                username: currentUserId,
                code: code
            };
            
            addLog(`ğŸ“ ç™¼é€ä»£ç¢¼è®Šæ›´: ${JSON.stringify(message)}`, 'info');
            websocket.send(JSON.stringify(message));
        }

        function testSaveCode() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                addLog('âŒ WebSocket æœªé€£æ¥', 'error');
                return;
            }
            
            const code = document.getElementById('testCode').value;
            const message = {
                type: 'save_code',
                room_id: currentRoomId,
                user_id: currentUserId,
                code: code
            };
            
            addLog(`ğŸ’¾ ç™¼é€ä¿å­˜ä»£ç¢¼: ${JSON.stringify(message)}`, 'info');
            websocket.send(JSON.stringify(message));
        }

        function testLoadCode() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                addLog('âŒ WebSocket æœªé€£æ¥', 'error');
                return;
            }
            
            const message = {
                type: 'load_code',
                room_id: currentRoomId,
                user_id: currentUserId
            };
            
            addLog(`ğŸ“‚ ç™¼é€è¼‰å…¥ä»£ç¢¼: ${JSON.stringify(message)}`, 'info');
            websocket.send(JSON.stringify(message));
        }

        function testInvalidMessage() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                addLog('âŒ WebSocket æœªé€£æ¥', 'error');
                return;
            }
            
            const message = { type: 'invalid_message_type', test: 'data' };
            addLog(`ğŸ§ª ç™¼é€ç„¡æ•ˆæ¶ˆæ¯æ¸¬è©¦: ${JSON.stringify(message)}`, 'warning');
            websocket.send(JSON.stringify(message));
        }

        function testMissingParams() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                addLog('âŒ WebSocket æœªé€£æ¥', 'error');
                return;
            }
            
            const message = { type: 'save_code' }; // ç¼ºå°‘å¿…è¦åƒæ•¸
            addLog(`ğŸ§ª ç™¼é€ç¼ºå°‘åƒæ•¸æ¸¬è©¦: ${JSON.stringify(message)}`, 'warning');
            websocket.send(JSON.stringify(message));
        }

        function testAIExplain() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                addLog('âŒ WebSocket æœªé€£æ¥', 'error');
                return;
            }
            
            const code = document.getElementById('testCode').value;
            const message = {
                type: 'ai_request',
                action: 'explain',
                requestId: 'test_' + Date.now(),
                data: { code: code }
            };
            
            addLog(`ğŸ¤– ç™¼é€ AI è§£é‡‹è«‹æ±‚: ${JSON.stringify(message)}`, 'info');
            websocket.send(JSON.stringify(message));
        }

        function testAICheck() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                addLog('âŒ WebSocket æœªé€£æ¥', 'error');
                return;
            }
            
            const code = document.getElementById('testCode').value;
            const message = {
                type: 'ai_request',
                action: 'check_errors',
                requestId: 'test_' + Date.now(),
                data: { code: code }
            };
            
            addLog(`ğŸ¤– ç™¼é€ AI éŒ¯èª¤æª¢æŸ¥è«‹æ±‚: ${JSON.stringify(message)}`, 'info');
            websocket.send(JSON.stringify(message));
        }

        function testAIImprove() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                addLog('âŒ WebSocket æœªé€£æ¥', 'error');
                return;
            }
            
            const code = document.getElementById('testCode').value;
            const message = {
                type: 'ai_request',
                action: 'suggest_improvements',
                requestId: 'test_' + Date.now(),
                data: { code: code }
            };
            
            addLog(`ğŸ¤– ç™¼é€ AI æ”¹é€²å»ºè­°è«‹æ±‚: ${JSON.stringify(message)}`, 'info');
            websocket.send(JSON.stringify(message));
        }

        function disconnect() {
            if (websocket) {
                websocket.close(1000, 'ç”¨æˆ¶ä¸»å‹•æ–·é–‹');
                addLog('ğŸ”Œ ä¸»å‹•æ–·é–‹ WebSocket é€£æ¥', 'info');
            }
        }

        function clearLogs() {
            document.getElementById('logOutput').innerHTML = '';
            messageCount = 0;
            document.getElementById('messageCount').textContent = '0';
            addLog('ğŸ§¹ æ—¥èªŒå·²æ¸…ç©º', 'info');
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ğŸš€ WebSocket æ¸¬è©¦é é¢å·²è¼‰å…¥', 'info');
            addLog('ğŸ’¡ è«‹å¡«å¯«æˆ¿é–“åç¨±å’Œç”¨æˆ¶åç¨±ï¼Œç„¶å¾Œé»æ“Š"åŠ å…¥æˆ¿é–“"é–‹å§‹æ¸¬è©¦', 'info');
        });
    </script>
</body>
</html> 