<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PythonLearn æ ¸å¿ƒåŠŸèƒ½é›†æˆæª¢æŸ¥</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .check-card { margin-bottom: 15px; }
        .status-icon { font-size: 1.2em; margin-right: 8px; }
        .status-pass { color: #28a745; }
        .status-fail { color: #dc3545; }
        .status-warning { color: #ffc107; }
        .detail-box { background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .console-output { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; font-family: monospace; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-4">
                    <i class="fas fa-cogs"></i> PythonLearn æ ¸å¿ƒåŠŸèƒ½é›†æˆæª¢æŸ¥
                    <button class="btn btn-primary ms-3" onclick="runAllChecks()">
                        <i class="fas fa-play"></i> åŸ·è¡Œå…¨é¢æª¢æŸ¥
                    </button>
                    <button class="btn btn-success ms-2" onclick="clearResults()">
                        <i class="fas fa-trash"></i> æ¸…é™¤çµæœ
                    </button>
                </h2>
                
                <!-- ç¸½é«”ç‹€æ…‹ -->
                <div class="alert alert-info" id="overallStatus">
                    <i class="fas fa-info-circle"></i> æº–å‚™åŸ·è¡Œæ ¸å¿ƒåŠŸèƒ½æª¢æŸ¥...
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- å·¦å´ï¼šæ ¸å¿ƒæ¨¡çµ„æª¢æŸ¥ -->
            <div class="col-md-6">
                <h4>ğŸ”§ æ ¸å¿ƒæ¨¡çµ„æª¢æŸ¥</h4>
                
                <!-- 1. ç”¨æˆ¶ç®¡ç†å™¨ -->
                <div class="card check-card">
                    <div class="card-header">
                        <span id="userManager-status" class="status-icon">â³</span>
                        ç”¨æˆ¶ç®¡ç†å™¨ (UserManager)
                    </div>
                    <div class="card-body" id="userManager-details">
                        <button class="btn btn-sm btn-outline-primary" onclick="checkUserManager()">æª¢æŸ¥</button>
                    </div>
                </div>
                
                <!-- 2. HTTPè¼ªè©¢ç®¡ç†å™¨ -->
                <div class="card check-card">
                    <div class="card-header">
                        <span id="httpPolling-status" class="status-icon">â³</span>
                        HTTPè¼ªè©¢ç®¡ç†å™¨ (HttpPollingManager)
                    </div>
                    <div class="card-body" id="httpPolling-details">
                        <button class="btn btn-sm btn-outline-primary" onclick="checkHttpPolling()">æª¢æŸ¥</button>
                    </div>
                </div>
                
                <!-- 3. ç·¨è¼¯å™¨ç®¡ç†å™¨ -->
                <div class="card check-card">
                    <div class="card-header">
                        <span id="editor-status" class="status-icon">â³</span>
                        ç·¨è¼¯å™¨ç®¡ç†å™¨ (Editor)
                    </div>
                    <div class="card-body" id="editor-details">
                        <button class="btn btn-sm btn-outline-primary" onclick="checkEditor()">æª¢æŸ¥</button>
                    </div>
                </div>
                
                <!-- 4. ä¿å­˜è¼‰å…¥ç®¡ç†å™¨ -->
                <div class="card check-card">
                    <div class="card-header">
                        <span id="saveLoad-status" class="status-icon">â³</span>
                        ä¿å­˜è¼‰å…¥ç®¡ç†å™¨ (SaveLoadManager)
                    </div>
                    <div class="card-body" id="saveLoad-details">
                        <button class="btn btn-sm btn-outline-primary" onclick="checkSaveLoad()">æª¢æŸ¥</button>
                    </div>
                </div>
                
                <!-- 5. AIåŠ©æ•™ -->
                <div class="card check-card">
                    <div class="card-header">
                        <span id="aiAssistant-status" class="status-icon">â³</span>
                        AIåŠ©æ•™ (AIAssistant)
                    </div>
                    <div class="card-body" id="aiAssistant-details">
                        <button class="btn btn-sm btn-outline-primary" onclick="checkAIAssistant()">æª¢æŸ¥</button>
                    </div>
                </div>
                
                <!-- 6. èŠå¤©ç®¡ç†å™¨ -->
                <div class="card check-card">
                    <div class="card-header">
                        <span id="chat-status" class="status-icon">â³</span>
                        èŠå¤©ç®¡ç†å™¨ (Chat)
                    </div>
                    <div class="card-body" id="chat-details">
                        <button class="btn btn-sm btn-outline-primary" onclick="checkChat()">æª¢æŸ¥</button>
                    </div>
                </div>
                
                <!-- 7. è¡çªè§£æ±ºå™¨ -->
                <div class="card check-card">
                    <div class="card-header">
                        <span id="conflict-status" class="status-icon">â³</span>
                        è¡çªè§£æ±ºå™¨ (ConflictResolver)
                    </div>
                    <div class="card-body" id="conflict-details">
                        <button class="btn btn-sm btn-outline-primary" onclick="checkConflictResolver()">æª¢æŸ¥</button>
                    </div>
                </div>
                
                <!-- 8. UIç®¡ç†å™¨ -->
                <div class="card check-card">
                    <div class="card-header">
                        <span id="ui-status" class="status-icon">â³</span>
                        UIç®¡ç†å™¨ (UI)
                    </div>
                    <div class="card-body" id="ui-details">
                        <button class="btn btn-sm btn-outline-primary" onclick="checkUI()">æª¢æŸ¥</button>
                    </div>
                </div>
            </div>
            
            <!-- å³å´ï¼šæ•¸æ“šäº¤äº’æª¢æŸ¥ -->
            <div class="col-md-6">
                <h4>ğŸ”„ æ•¸æ“šäº¤äº’æª¢æŸ¥</h4>
                
                <!-- API é€£æ¥æ¸¬è©¦ -->
                <div class="card check-card">
                    <div class="card-header">
                        <span id="api-status" class="status-icon">â³</span>
                        API é€£æ¥æ¸¬è©¦
                    </div>
                    <div class="card-body" id="api-details">
                        <button class="btn btn-sm btn-outline-primary" onclick="checkAPI()">æª¢æŸ¥</button>
                    </div>
                </div>
                
                <!-- å…¨å±€å‡½æ•¸æ˜ å°„ -->
                <div class="card check-card">
                    <div class="card-header">
                        <span id="global-status" class="status-icon">â³</span>
                        å…¨å±€å‡½æ•¸æ˜ å°„
                    </div>
                    <div class="card-body" id="global-details">
                        <button class="btn btn-sm btn-outline-primary" onclick="checkGlobalFunctions()">æª¢æŸ¥</button>
                    </div>
                </div>
                
                <!-- æ¨¡çµ„é–“é€šä¿¡ -->
                <div class="card check-card">
                    <div class="card-header">
                        <span id="communication-status" class="status-icon">â³</span>
                        æ¨¡çµ„é–“é€šä¿¡
                    </div>
                    <div class="card-body" id="communication-details">
                        <button class="btn btn-sm btn-outline-primary" onclick="checkModuleCommunication()">æª¢æŸ¥</button>
                    </div>
                </div>
                
                <!-- äº‹ä»¶ç›£è½å™¨ -->
                <div class="card check-card">
                    <div class="card-header">
                        <span id="events-status" class="status-icon">â³</span>
                        äº‹ä»¶ç›£è½å™¨
                    </div>
                    <div class="card-body" id="events-details">
                        <button class="btn btn-sm btn-outline-primary" onclick="checkEventListeners()">æª¢æŸ¥</button>
                    </div>
                </div>
                
                <!-- æ§åˆ¶å°è¼¸å‡º -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-terminal"></i> æª¢æŸ¥æ—¥èªŒ
                        <button class="btn btn-sm btn-outline-secondary float-end" onclick="clearConsole()">
                            <i class="fas fa-trash"></i> æ¸…é™¤
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="console" class="console-output"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ§åˆ¶å°è¼¸å‡ºç®¡ç†
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#3182ce',
                success: '#38a169',
                warning: '#d69e2e',
                error: '#e53e3e'
            };
            
            const entry = document.createElement('div');
            entry.innerHTML = `<span style="color: #a0aec0">[${timestamp}]</span> <span style="color: ${colors[type]}">${message}</span>`;
            console.appendChild(entry);
            console.scrollTop = console.scrollHeight;
        }
        
        function clearConsole() {
            document.getElementById('console').innerHTML = '';
        }
        
        function clearResults() {
            const statusIcons = document.querySelectorAll('[id$="-status"]');
            const details = document.querySelectorAll('[id$="-details"]');
            
            statusIcons.forEach(icon => {
                icon.textContent = 'â³';
                icon.className = 'status-icon';
            });
            
            details.forEach(detail => {
                const button = detail.querySelector('button');
                if (button) {
                    detail.innerHTML = '';
                    detail.appendChild(button);
                }
            });
            
            clearConsole();
            document.getElementById('overallStatus').innerHTML = '<i class="fas fa-info-circle"></i> æº–å‚™åŸ·è¡Œæ ¸å¿ƒåŠŸèƒ½æª¢æŸ¥...';
            document.getElementById('overallStatus').className = 'alert alert-info';
        }
        
        // è¨­ç½®æª¢æŸ¥çµæœ
        function setCheckResult(moduleId, passed, details = '', data = null) {
            const statusIcon = document.getElementById(`${moduleId}-status`);
            const detailsDiv = document.getElementById(`${moduleId}-details`);
            
            if (passed) {
                statusIcon.textContent = 'âœ…';
                statusIcon.className = 'status-icon status-pass';
                log(`${moduleId} æª¢æŸ¥é€šé`, 'success');
            } else {
                statusIcon.textContent = 'âŒ';
                statusIcon.className = 'status-icon status-fail';
                log(`${moduleId} æª¢æŸ¥å¤±æ•—: ${details}`, 'error');
            }
            
            if (details) {
                const detailBox = document.createElement('div');
                detailBox.className = 'detail-box';
                detailBox.innerHTML = `<small>${details}</small>`;
                if (data) {
                    detailBox.innerHTML += `<pre style="font-size: 10px; margin-top: 5px;">${JSON.stringify(data, null, 2)}</pre>`;
                }
                detailsDiv.appendChild(detailBox);
            }
        }
        
        // 1. æª¢æŸ¥ç”¨æˆ¶ç®¡ç†å™¨
        function checkUserManager() {
            log('æª¢æŸ¥ç”¨æˆ¶ç®¡ç†å™¨...', 'info');
            
            try {
                const exists = typeof window.UserManager !== 'undefined';
                if (!exists) {
                    setCheckResult('userManager', false, 'window.UserManager ä¸å­˜åœ¨');
                    return;
                }
                
                const methods = ['setCurrentUser', 'getCurrentUser', 'updateOnlineUsers', 'cleanup'];
                const missingMethods = methods.filter(method => typeof window.UserManager[method] !== 'function');
                
                if (missingMethods.length > 0) {
                    setCheckResult('userManager', false, `ç¼ºå°‘æ–¹æ³•: ${missingMethods.join(', ')}`);
                    return;
                }
                
                setCheckResult('userManager', true, 'æ‰€æœ‰å¿…è¦æ–¹æ³•éƒ½å­˜åœ¨', {
                    methods: methods.filter(method => typeof window.UserManager[method] === 'function'),
                    isInitialized: window.UserManager.isInitialized
                });
            } catch (error) {
                setCheckResult('userManager', false, `æª¢æŸ¥éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
            }
        }
        
        // 2. æª¢æŸ¥HTTPè¼ªè©¢ç®¡ç†å™¨
        function checkHttpPolling() {
            log('æª¢æŸ¥HTTPè¼ªè©¢ç®¡ç†å™¨...', 'info');
            
            try {
                const exists = typeof window.wsManager !== 'undefined';
                if (!exists) {
                    setCheckResult('httpPolling', false, 'window.wsManager ä¸å­˜åœ¨');
                    return;
                }
                
                const methods = ['connect', 'disconnect', 'sendMessage', 'isConnected'];
                const missingMethods = methods.filter(method => typeof window.wsManager[method] !== 'function');
                
                if (missingMethods.length > 0) {
                    setCheckResult('httpPolling', false, `ç¼ºå°‘æ–¹æ³•: ${missingMethods.join(', ')}`);
                    return;
                }
                
                setCheckResult('httpPolling', true, 'æ‰€æœ‰å¿…è¦æ–¹æ³•éƒ½å­˜åœ¨', {
                    methods: methods.filter(method => typeof window.wsManager[method] === 'function'),
                    isConnected: window.wsManager.isConnected ? window.wsManager.isConnected() : false
                });
            } catch (error) {
                setCheckResult('httpPolling', false, `æª¢æŸ¥éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
            }
        }
        
        // 3. æª¢æŸ¥ç·¨è¼¯å™¨ç®¡ç†å™¨
        function checkEditor() {
            log('æª¢æŸ¥ç·¨è¼¯å™¨ç®¡ç†å™¨...', 'info');
            
            try {
                const exists = typeof window.Editor !== 'undefined';
                if (!exists) {
                    setCheckResult('editor', false, 'window.Editor ä¸å­˜åœ¨');
                    return;
                }
                
                const methods = ['getCode', 'setCode', 'setupConflictDetection'];
                const missingMethods = methods.filter(method => typeof window.Editor[method] !== 'function');
                
                if (missingMethods.length > 0) {
                    setCheckResult('editor', false, `ç¼ºå°‘æ–¹æ³•: ${missingMethods.join(', ')}`);
                    return;
                }
                
                setCheckResult('editor', true, 'æ‰€æœ‰å¿…è¦æ–¹æ³•éƒ½å­˜åœ¨', {
                    methods: methods.filter(method => typeof window.Editor[method] === 'function'),
                    hasCodeMirror: typeof window.Editor.editor !== 'undefined'
                });
            } catch (error) {
                setCheckResult('editor', false, `æª¢æŸ¥éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
            }
        }
        
        // 4. æª¢æŸ¥ä¿å­˜è¼‰å…¥ç®¡ç†å™¨
        function checkSaveLoad() {
            log('æª¢æŸ¥ä¿å­˜è¼‰å…¥ç®¡ç†å™¨...', 'info');
            
            try {
                const exists = typeof window.SaveLoadManager !== 'undefined';
                if (!exists) {
                    setCheckResult('saveLoad', false, 'window.SaveLoadManager ä¸å­˜åœ¨');
                    return;
                }
                
                const methods = ['init', 'saveCode', 'loadCode', 'checkInitialized'];
                const missingMethods = methods.filter(method => typeof window.SaveLoadManager[method] !== 'function');
                
                if (missingMethods.length > 0) {
                    setCheckResult('saveLoad', false, `ç¼ºå°‘æ–¹æ³•: ${missingMethods.join(', ')}`);
                    return;
                }
                
                setCheckResult('saveLoad', true, 'æ‰€æœ‰å¿…è¦æ–¹æ³•éƒ½å­˜åœ¨', {
                    methods: methods.filter(method => typeof window.SaveLoadManager[method] === 'function'),
                    isInitialized: window.SaveLoadManager.isInitialized
                });
            } catch (error) {
                setCheckResult('saveLoad', false, `æª¢æŸ¥éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
            }
        }
        
        // 5. æª¢æŸ¥AIåŠ©æ•™
        function checkAIAssistant() {
            log('æª¢æŸ¥AIåŠ©æ•™...', 'info');
            
            try {
                const exists = typeof window.AIAssistant !== 'undefined';
                if (!exists) {
                    setCheckResult('aiAssistant', false, 'window.AIAssistant ä¸å­˜åœ¨');
                    return;
                }
                
                const methods = ['initialize', 'processMessage'];
                const missingMethods = methods.filter(method => typeof window.AIAssistant[method] !== 'function');
                
                const globalFunctions = ['askAI', 'globalAskAI'];
                const missingGlobalFunctions = globalFunctions.filter(func => typeof window[func] !== 'function');
                
                if (missingMethods.length > 0 || missingGlobalFunctions.length > 0) {
                    setCheckResult('aiAssistant', false, `ç¼ºå°‘æ–¹æ³•: ${[...missingMethods, ...missingGlobalFunctions].join(', ')}`);
                    return;
                }
                
                setCheckResult('aiAssistant', true, 'æ‰€æœ‰å¿…è¦æ–¹æ³•éƒ½å­˜åœ¨', {
                    methods: methods.filter(method => typeof window.AIAssistant[method] === 'function'),
                    globalFunctions: globalFunctions.filter(func => typeof window[func] === 'function')
                });
            } catch (error) {
                setCheckResult('aiAssistant', false, `æª¢æŸ¥éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
            }
        }
        
        // 6. æª¢æŸ¥èŠå¤©ç®¡ç†å™¨
        function checkChat() {
            log('æª¢æŸ¥èŠå¤©ç®¡ç†å™¨...', 'info');
            
            try {
                const exists = typeof window.Chat !== 'undefined';
                if (!exists) {
                    setCheckResult('chat', false, 'window.Chat ä¸å­˜åœ¨');
                    return;
                }
                
                const methods = ['sendMessage', 'addMessage'];
                const missingMethods = methods.filter(method => typeof window.Chat[method] !== 'function');
                
                const globalFunctions = ['globalSendChat'];
                const missingGlobalFunctions = globalFunctions.filter(func => typeof window[func] !== 'function');
                
                if (missingMethods.length > 0 || missingGlobalFunctions.length > 0) {
                    setCheckResult('chat', false, `ç¼ºå°‘æ–¹æ³•: ${[...missingMethods, ...missingGlobalFunctions].join(', ')}`);
                    return;
                }
                
                setCheckResult('chat', true, 'æ‰€æœ‰å¿…è¦æ–¹æ³•éƒ½å­˜åœ¨', {
                    methods: methods.filter(method => typeof window.Chat[method] === 'function'),
                    globalFunctions: globalFunctions.filter(func => typeof window[func] === 'function')
                });
            } catch (error) {
                setCheckResult('chat', false, `æª¢æŸ¥éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
            }
        }
        
        // 7. æª¢æŸ¥è¡çªè§£æ±ºå™¨
        function checkConflictResolver() {
            log('æª¢æŸ¥è¡çªè§£æ±ºå™¨...', 'info');
            
            try {
                const exists = typeof window.ConflictResolver !== 'undefined';
                if (!exists) {
                    setCheckResult('conflict', false, 'window.ConflictResolver ä¸å­˜åœ¨');
                    return;
                }
                
                const methods = ['detectConflict', 'resolveConflict'];
                const missingMethods = methods.filter(method => typeof window.ConflictResolver[method] !== 'function');
                
                const globalFunctions = ['resolveConflict'];
                const missingGlobalFunctions = globalFunctions.filter(func => typeof window[func] !== 'function');
                
                if (missingMethods.length > 0 || missingGlobalFunctions.length > 0) {
                    setCheckResult('conflict', false, `ç¼ºå°‘æ–¹æ³•: ${[...missingMethods, ...missingGlobalFunctions].join(', ')}`);
                    return;
                }
                
                setCheckResult('conflict', true, 'æ‰€æœ‰å¿…è¦æ–¹æ³•éƒ½å­˜åœ¨', {
                    methods: methods.filter(method => typeof window.ConflictResolver[method] === 'function'),
                    globalFunctions: globalFunctions.filter(func => typeof window[func] === 'function')
                });
            } catch (error) {
                setCheckResult('conflict', false, `æª¢æŸ¥éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
            }
        }
        
        // 8. æª¢æŸ¥UIç®¡ç†å™¨
        function checkUI() {
            log('æª¢æŸ¥UIç®¡ç†å™¨...', 'info');
            
            try {
                const exists = typeof window.UI !== 'undefined';
                if (!exists) {
                    setCheckResult('ui', false, 'window.UI ä¸å­˜åœ¨');
                    return;
                }
                
                const methods = ['showToast', 'showErrorToast', 'showSuccessToast'];
                const missingMethods = methods.filter(method => typeof window.UI[method] !== 'function');
                
                if (missingMethods.length > 0) {
                    setCheckResult('ui', false, `ç¼ºå°‘æ–¹æ³•: ${missingMethods.join(', ')}`);
                    return;
                }
                
                setCheckResult('ui', true, 'æ‰€æœ‰å¿…è¦æ–¹æ³•éƒ½å­˜åœ¨', {
                    methods: methods.filter(method => typeof window.UI[method] === 'function')
                });
            } catch (error) {
                setCheckResult('ui', false, `æª¢æŸ¥éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
            }
        }
        
        // API é€£æ¥æ¸¬è©¦
        async function checkAPI() {
            log('æª¢æŸ¥APIé€£æ¥...', 'info');
            
            try {
                const response = await fetch('/api.php?action=poll&room_id=test&user_id=check&timestamp=0');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                if (data.success) {
                    setCheckResult('api', true, 'API é€£æ¥æ­£å¸¸', {
                        action: data.action,
                        timestamp: data.timestamp,
                        room_id: data.room_id
                    });
                } else {
                    setCheckResult('api', false, `API å›æ‡‰éŒ¯èª¤: ${data.error || 'æœªçŸ¥éŒ¯èª¤'}`);
                }
            } catch (error) {
                setCheckResult('api', false, `API é€£æ¥å¤±æ•—: ${error.message}`);
            }
        }
        
        // å…¨å±€å‡½æ•¸æ˜ å°„æª¢æŸ¥
        function checkGlobalFunctions() {
            log('æª¢æŸ¥å…¨å±€å‡½æ•¸æ˜ å°„...', 'info');
            
            const requiredGlobalFunctions = [
                'globalJoinRoom',
                'globalSendChat', 
                'globalAskAI',
                'globalImportCode',
                'globalOpenTeacherDashboard'
            ];
            
            const missing = requiredGlobalFunctions.filter(func => typeof window[func] !== 'function');
            
            if (missing.length > 0) {
                setCheckResult('global', false, `ç¼ºå°‘å…¨å±€å‡½æ•¸: ${missing.join(', ')}`);
            } else {
                setCheckResult('global', true, 'æ‰€æœ‰å¿…è¦çš„å…¨å±€å‡½æ•¸éƒ½å­˜åœ¨', {
                    functions: requiredGlobalFunctions
                });
            }
        }
        
        // æ¨¡çµ„é–“é€šä¿¡æª¢æŸ¥
        function checkModuleCommunication() {
            log('æª¢æŸ¥æ¨¡çµ„é–“é€šä¿¡...', 'info');
            
            const issues = [];
            
            // æª¢æŸ¥ç”¨æˆ¶ç®¡ç†å™¨èˆ‡å…¶ä»–æ¨¡çµ„çš„é€šä¿¡
            if (window.UserManager && window.SaveLoadManager) {
                if (typeof window.UserManager.notifyUserChange !== 'function') {
                    issues.push('UserManager.notifyUserChange æ–¹æ³•ç¼ºå¤±');
                }
            }
            
            // æª¢æŸ¥ç·¨è¼¯å™¨èˆ‡è¡çªæª¢æ¸¬çš„é€šä¿¡
            if (window.Editor && window.ConflictResolver) {
                if (typeof window.Editor.setupConflictDetection !== 'function') {
                    issues.push('Editor.setupConflictDetection æ–¹æ³•ç¼ºå¤±');
                }
            }
            
            if (issues.length > 0) {
                setCheckResult('communication', false, issues.join('; '));
            } else {
                setCheckResult('communication', true, 'æ¨¡çµ„é–“é€šä¿¡æ­£å¸¸');
            }
        }
        
        // äº‹ä»¶ç›£è½å™¨æª¢æŸ¥
        function checkEventListeners() {
            log('æª¢æŸ¥äº‹ä»¶ç›£è½å™¨...', 'info');
            
            const checkResults = [];
            
            // æª¢æŸ¥é é¢å¸è¼‰äº‹ä»¶
            const hasBeforeUnload = window.onbeforeunload !== null || 
                                   window.addEventListener.toString().includes('beforeunload');
            checkResults.push(`beforeunload: ${hasBeforeUnload ? 'âœ“' : 'âœ—'}`);
            
            // æª¢æŸ¥å¯è¦‹æ€§è®ŠåŒ–äº‹ä»¶
            const hasVisibilityChange = document.addEventListener.toString().includes('visibilitychange');
            checkResults.push(`visibilitychange: ${hasVisibilityChange ? 'âœ“' : 'âœ—'}`);
            
            setCheckResult('events', true, checkResults.join(', '));
        }
        
        // åŸ·è¡Œå…¨é¢æª¢æŸ¥
        async function runAllChecks() {
            log('é–‹å§‹åŸ·è¡Œå…¨é¢æª¢æŸ¥...', 'info');
            clearResults();
            
            const checks = [
                checkUserManager,
                checkHttpPolling,
                checkEditor,
                checkSaveLoad,
                checkAIAssistant,
                checkChat,
                checkConflictResolver,
                checkUI,
                checkAPI,
                checkGlobalFunctions,
                checkModuleCommunication,
                checkEventListeners
            ];
            
            for (const check of checks) {
                try {
                    await check();
                    await new Promise(resolve => setTimeout(resolve, 100)); // å°å»¶é²
                } catch (error) {
                    log(`æª¢æŸ¥éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
                }
            }
            
            // è¨ˆç®—ç¸½é«”çµæœ
            const statusIcons = document.querySelectorAll('[id$="-status"]');
            let passed = 0, failed = 0;
            
            statusIcons.forEach(icon => {
                if (icon.textContent === 'âœ…') passed++;
                else if (icon.textContent === 'âŒ') failed++;
            });
            
            const overallStatus = document.getElementById('overallStatus');
            if (failed === 0) {
                overallStatus.innerHTML = `<i class="fas fa-check-circle"></i> å…¨é¢æª¢æŸ¥å®Œæˆï¼æ‰€æœ‰ ${passed} é …æª¢æŸ¥éƒ½é€šé`;
                overallStatus.className = 'alert alert-success';
                log(`å…¨é¢æª¢æŸ¥å®Œæˆï¼é€šé: ${passed}, å¤±æ•—: ${failed}`, 'success');
            } else {
                overallStatus.innerHTML = `<i class="fas fa-exclamation-triangle"></i> æª¢æŸ¥å®Œæˆï¼š${passed} é …é€šéï¼Œ${failed} é …å¤±æ•—`;
                overallStatus.className = 'alert alert-warning';
                log(`æª¢æŸ¥å®Œæˆï¼šé€šé: ${passed}, å¤±æ•—: ${failed}`, 'warning');
            }
        }
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œè‡ªå‹•æª¢æŸ¥
        document.addEventListener('DOMContentLoaded', () => {
            log('æ ¸å¿ƒåŠŸèƒ½æª¢æŸ¥é é¢å·²è¼‰å…¥', 'info');
            log('é»æ“Š"åŸ·è¡Œå…¨é¢æª¢æŸ¥"é–‹å§‹æª¢æ¸¬æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½', 'info');
        });
    </script>
</body>
</html>