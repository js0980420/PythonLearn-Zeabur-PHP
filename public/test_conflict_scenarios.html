<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜ç´šè¡çªæª¢æ¸¬ç³»çµ±æ¸¬è©¦</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .test-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .scenario-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .scenario-card:hover {
            border-color: #007bff;
            box-shadow: 0 5px 15px rgba(0,123,255,0.2);
        }
        
        .scenario-card.active {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        
        .log-area {
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-ready { background-color: #28a745; }
        .status-testing { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        
        .user-simulator {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .conflict-preview {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="test-container">
                    <h1 class="text-center mb-4">
                        <i class="fas fa-shield-alt text-primary"></i>
                        é«˜ç´šè¡çªæª¢æ¸¬ç³»çµ±æ¸¬è©¦
                    </h1>
                    
                    <!-- ç³»çµ±ç‹€æ…‹ -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h6>ç³»çµ±ç‹€æ…‹</h6>
                                    <span class="status-indicator" id="systemStatus"></span>
                                    <span id="systemStatusText">åˆå§‹åŒ–ä¸­...</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h6>WebSocketé€£æ¥</h6>
                                    <span class="status-indicator" id="wsStatus"></span>
                                    <span id="wsStatusText">æœªé€£æ¥</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h6>è¡çªæª¢æ¸¬å™¨</h6>
                                    <span class="status-indicator" id="detectorStatus"></span>
                                    <span id="detectorStatusText">æœªå°±ç·’</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç”¨æˆ¶æ¨¡æ“¬å™¨ -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="user-simulator">
                                <h6><i class="fas fa-user-edit"></i> ä¸»æ”¹æ–¹ (Alex Wang)</h6>
                                <div class="mb-2">
                                    <label class="form-label">ç•¶å‰ä»£ç¢¼:</label>
                                    <textarea class="form-control" id="mainUserCode" rows="4" placeholder="ä¸»æ”¹æ–¹çš„ä»£ç¢¼...">
# Python å­¸ç¿’ç¯„ä¾‹
print("Hello, World!")
x = 10
y = 20
print(f"x + y = {x + y}")
                                    </textarea>
                                </div>
                                <button class="btn btn-primary btn-sm" onclick="setAsMainEditor()">
                                    <i class="fas fa-crown"></i> è¨­ç‚ºä¸»æ”¹æ–¹
                                </button>
                                <button class="btn btn-success btn-sm" onclick="simulateCodeChange()">
                                    <i class="fas fa-edit"></i> æ¨¡æ“¬ä»£ç¢¼è®Šæ›´
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="user-simulator">
                                <h6><i class="fas fa-users"></i> å…¶ä»–å”ä½œè€…</h6>
                                <div class="mb-2">
                                    <label class="form-label">å”ä½œè€…ä»£ç¢¼:</label>
                                    <textarea class="form-control" id="otherUserCode" rows="4" placeholder="å…¶ä»–ç”¨æˆ¶çš„ä»£ç¢¼...">
# Python å­¸ç¿’ç¯„ä¾‹ - ä¿®æ”¹ç‰ˆ
print("Hello, Python!")
x = 15
y = 25
print(f"çµæœ: {x + y}")
                                    </textarea>
                                </div>
                                <button class="btn btn-info btn-sm" onclick="addCollaborator()">
                                    <i class="fas fa-user-plus"></i> æ·»åŠ å”ä½œè€…
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="simulateConflict()">
                                    <i class="fas fa-exclamation-triangle"></i> æ¨¡æ“¬è¡çª
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ¸¬è©¦å ´æ™¯ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="fas fa-flask"></i> æ¸¬è©¦å ´æ™¯</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="scenario-card" onclick="testScenario('paste')">
                                        <h6><i class="fas fa-clipboard"></i> å¤§é‡è²¼ä¸Šæ“ä½œ</h6>
                                        <p class="text-muted mb-0">æ¨¡æ“¬ç”¨æˆ¶è²¼ä¸Šå¤§é‡ä»£ç¢¼çš„æƒ…æ³</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="scenario-card" onclick="testScenario('import')">
                                        <h6><i class="fas fa-download"></i> å°å…¥æ“ä½œ</h6>
                                        <p class="text-muted mb-0">æ¨¡æ“¬ç”¨æˆ¶å°å…¥å¤–éƒ¨ä»£ç¢¼çš„æƒ…æ³</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="scenario-card" onclick="testScenario('mass_delete')">
                                        <h6><i class="fas fa-trash"></i> å¤§é‡åˆªé™¤</h6>
                                        <p class="text-muted mb-0">æ¨¡æ“¬ç”¨æˆ¶åˆªé™¤å¤§é‡ä»£ç¢¼çš„æƒ…æ³</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="scenario-card" onclick="testScenario('same_line')">
                                        <h6><i class="fas fa-code"></i> åŒè¡Œè¡çª</h6>
                                        <p class="text-muted mb-0">æ¨¡æ“¬å¤šç”¨æˆ¶ä¿®æ”¹åŒä¸€è¡Œä»£ç¢¼</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è¡çªè§£æ±ºé¸é …æ¸¬è©¦ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="fas fa-tools"></i> è¡çªè§£æ±ºé¸é …æ¸¬è©¦</h5>
                            <div class="btn-group" role="group">
                                <button class="btn btn-danger" onclick="testResolution('force')">
                                    <i class="fas fa-bolt"></i> å¼·åˆ¶ä¿®æ”¹
                                </button>
                                <button class="btn btn-primary" onclick="testResolution('vote')">
                                    <i class="fas fa-vote-yea"></i> æŠ•ç¥¨ç³»çµ±
                                </button>
                                <button class="btn btn-info" onclick="testResolution('chat')">
                                    <i class="fas fa-comments"></i> èŠå¤©è¨è«–
                                </button>
                                <button class="btn btn-success" onclick="testResolution('ai')">
                                    <i class="fas fa-robot"></i> AIå”åŠ©
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è¡çªé è¦½ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="fas fa-eye"></i> è¡çªé è¦½</h5>
                            <div class="conflict-preview" id="conflictPreview">
                                <p class="mb-0 text-muted">é¸æ“‡æ¸¬è©¦å ´æ™¯ä»¥æŸ¥çœ‹è¡çªé è¦½...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ¸¬è©¦æ—¥èªŒ -->
                    <div class="row">
                        <div class="col-12">
                            <h5><i class="fas fa-terminal"></i> æ¸¬è©¦æ—¥èªŒ</h5>
                            <div class="log-area" id="testLog"></div>
                            <div class="mt-2">
                                <button class="btn btn-secondary btn-sm" onclick="clearLog()">
                                    <i class="fas fa-broom"></i> æ¸…ç©ºæ—¥èªŒ
                                </button>
                                <button class="btn btn-info btn-sm" onclick="exportLog()">
                                    <i class="fas fa-download"></i> å°å‡ºæ—¥èªŒ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- é«˜ç´šè¡çªæª¢æ¸¬å™¨ -->
    <script src="js/advanced-conflict-detector.js"></script>
    
    <script>
        // æ¸¬è©¦ç³»çµ±ç‹€æ…‹
        let testState = {
            systemReady: false,
            wsConnected: false,
            detectorReady: false,
            isMainEditor: false,
            collaborators: [],
            currentScenario: null
        };
        
        // æ—¥èªŒå‡½æ•¸
        function log(message, type = 'info') {
            const logArea = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            
            const typeColors = {
                info: '#4299e1',
                success: '#48bb78',
                warning: '#ed8936',
                error: '#f56565'
            };
            
            logEntry.innerHTML = `
                <span style="color: #a0aec0;">[${timestamp}]</span>
                <span style="color: ${typeColors[type] || typeColors.info};">${message}</span>
            `;
            
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        // æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºå™¨
        function updateStatus(element, status, text) {
            const indicator = document.getElementById(element);
            const textElement = document.getElementById(element + 'Text');
            
            indicator.className = 'status-indicator status-' + status;
            textElement.textContent = text;
        }
        
        // åˆå§‹åŒ–ç³»çµ±
        function initializeSystem() {
            log('ğŸš€ é–‹å§‹åˆå§‹åŒ–é«˜ç´šè¡çªæª¢æ¸¬æ¸¬è©¦ç³»çµ±...', 'info');
            
            // æª¢æŸ¥ AdvancedConflictDetector
            if (window.AdvancedConflictDetector) {
                testState.detectorReady = true;
                updateStatus('detectorStatus', 'ready', 'å·²å°±ç·’');
                log('âœ… AdvancedConflictDetector å·²è¼‰å…¥', 'success');
                
                // è¨­ç‚ºä¸»æ”¹æ–¹
                testState.isMainEditor = true;
                window.AdvancedConflictDetector.setMainEditor(true);
                log('ğŸ‘‘ å·²è¨­ç½®ç‚ºä¸»æ”¹æ–¹', 'success');
                
                // æ·»åŠ æ¨¡æ“¬å”ä½œè€…
                testState.collaborators = [
                    { username: 'å­¸ç”Ÿ123', userId: 'å­¸ç”Ÿ123', isActive: true },
                    { username: 'å­¸ç”Ÿ456', userId: 'å­¸ç”Ÿ456', isActive: true }
                ];
                log('ğŸ‘¥ å·²æ·»åŠ æ¨¡æ“¬å”ä½œè€…', 'info');
                
            } else {
                updateStatus('detectorStatus', 'error', 'æœªè¼‰å…¥');
                log('âŒ AdvancedConflictDetector æœªæ‰¾åˆ°', 'error');
            }
            
            // æ¨¡æ“¬ WebSocket é€£æ¥
            setTimeout(() => {
                testState.wsConnected = true;
                updateStatus('wsStatus', 'ready', 'å·²é€£æ¥');
                log('âœ… WebSocket é€£æ¥æ¨¡æ“¬æˆåŠŸ', 'success');
                
                // ç³»çµ±å°±ç·’
                testState.systemReady = true;
                updateStatus('systemStatus', 'ready', 'ç³»çµ±å°±ç·’');
                log('ğŸ¯ æ¸¬è©¦ç³»çµ±åˆå§‹åŒ–å®Œæˆ', 'success');
            }, 1000);
        }
        
        // è¨­ç‚ºä¸»æ”¹æ–¹
        function setAsMainEditor() {
            if (!testState.detectorReady) {
                log('âŒ è¡çªæª¢æ¸¬å™¨æœªå°±ç·’', 'error');
                return;
            }
            
            testState.isMainEditor = true;
            window.AdvancedConflictDetector.setMainEditor(true);
            log('ğŸ‘‘ å·²è¨­ç½®ç‚ºä¸»æ”¹æ–¹', 'success');
        }
        
        // æ·»åŠ å”ä½œè€…
        function addCollaborator() {
            const collaboratorName = `å­¸ç”Ÿ${Math.floor(Math.random() * 1000)}`;
            testState.collaborators.push({
                username: collaboratorName,
                userId: collaboratorName,
                isActive: true
            });
            log(`ğŸ‘¤ æ·»åŠ å”ä½œè€…: ${collaboratorName}`, 'info');
        }
        
        // æ¨¡æ“¬ä»£ç¢¼è®Šæ›´
        function simulateCodeChange() {
            if (!testState.detectorReady) {
                log('âŒ è¡çªæª¢æ¸¬å™¨æœªå°±ç·’', 'error');
                return;
            }
            
            const oldCode = document.getElementById('mainUserCode').value;
            const newCode = oldCode + '\n# æ–°å¢çš„ä»£ç¢¼\nprint("æ–°åŠŸèƒ½")';
            
            document.getElementById('mainUserCode').value = newCode;
            
            // æ›´æ–°ä»£ç¢¼å¿«ç…§
            window.AdvancedConflictDetector.updateCodeSnapshot(newCode);
            log('ğŸ“ æ¨¡æ“¬ä»£ç¢¼è®Šæ›´å®Œæˆ', 'info');
        }
        
        // æ¨¡æ“¬è¡çª
        function simulateConflict() {
            if (!testState.isMainEditor) {
                log('âš ï¸ è«‹å…ˆè¨­ç½®ç‚ºä¸»æ”¹æ–¹', 'warning');
                return;
            }
            
            if (testState.collaborators.length === 0) {
                log('âš ï¸ è«‹å…ˆæ·»åŠ å”ä½œè€…', 'warning');
                return;
            }
            
            const oldCode = window.AdvancedConflictDetector.lastCodeSnapshot || '';
            const newCode = document.getElementById('mainUserCode').value;
            
            // æª¢æ¸¬è¡çª
            const shouldTrigger = window.AdvancedConflictDetector.shouldTriggerConflictWarning(
                oldCode, newCode, testState.collaborators
            );
            
            if (shouldTrigger) {
                const changeInfo = window.AdvancedConflictDetector.detectChangeType(oldCode, newCode);
                window.AdvancedConflictDetector.showMainEditorConflictWarning(changeInfo, testState.collaborators);
                log('ğŸš¨ è¡çªè­¦å‘Šå·²è§¸ç™¼', 'warning');
            } else {
                log('â„¹ï¸ æœªæª¢æ¸¬åˆ°éœ€è¦è­¦å‘Šçš„è¡çª', 'info');
            }
        }
        
        // æ¸¬è©¦å ´æ™¯
        function testScenario(scenario) {
            // ç§»é™¤ä¹‹å‰çš„æ´»èºç‹€æ…‹
            document.querySelectorAll('.scenario-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // è¨­ç½®ç•¶å‰å ´æ™¯ç‚ºæ´»èº
            event.target.closest('.scenario-card').classList.add('active');
            testState.currentScenario = scenario;
            
            log(`ğŸ§ª é–‹å§‹æ¸¬è©¦å ´æ™¯: ${scenario}`, 'info');
            
            let oldCode = '# åŸå§‹ä»£ç¢¼\nprint("Hello")';
            let newCode = '';
            let description = '';
            
            switch (scenario) {
                case 'paste':
                    newCode = oldCode + `
# å¤§é‡è²¼ä¸Šçš„ä»£ç¢¼
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt

def complex_function():
    data = np.random.randn(1000)
    df = pd.DataFrame(data, columns=['values'])
    plt.figure(figsize=(10, 6))
    plt.hist(df['values'], bins=50)
    plt.title('Random Data Distribution')
    plt.show()
    return df

result = complex_function()
print(result.describe())`;
                    description = 'æª¢æ¸¬åˆ°å¤§é‡è²¼ä¸Šæ“ä½œ (è¶…é100å­—ç¬¦)';
                    break;
                    
                case 'import':
                    newCode = `import tensorflow as tf
import keras
from sklearn import datasets
${oldCode}`;
                    description = 'æª¢æ¸¬åˆ°å°å…¥æ“ä½œ (åŒ…å«importèªå¥)';
                    break;
                    
                case 'mass_delete':
                    newCode = '# åªå‰©é€™ä¸€è¡Œ';
                    description = 'æª¢æ¸¬åˆ°å¤§é‡åˆªé™¤æ“ä½œ (ä»£ç¢¼æ¸›å°‘50%ä»¥ä¸Š)';
                    break;
                    
                case 'same_line':
                    // æ¨¡æ“¬åŒè¡Œè¡çª
                    const myCode = 'print("æˆ‘çš„ç‰ˆæœ¬")';
                    const otherCode = 'print("å…¶ä»–äººçš„ç‰ˆæœ¬")';
                    window.AdvancedConflictDetector.updateCodeSnapshot('print("åŸå§‹ç‰ˆæœ¬")');
                    const conflicts = window.AdvancedConflictDetector.detectSameLineConflict(
                        myCode, otherCode, { username: 'å­¸ç”Ÿ123' }
                    );
                    description = conflicts ? 'æª¢æ¸¬åˆ°åŒè¡Œè¡çª' : 'æœªæª¢æ¸¬åˆ°åŒè¡Œè¡çª';
                    log(`ğŸ” åŒè¡Œè¡çªæª¢æ¸¬çµæœ: ${conflicts ? 'æœ‰è¡çª' : 'ç„¡è¡çª'}`, conflicts ? 'warning' : 'info');
                    return;
            }
            
            // åŸ·è¡Œæª¢æ¸¬
            window.AdvancedConflictDetector.updateCodeSnapshot(oldCode);
            const changeInfo = window.AdvancedConflictDetector.detectChangeType(oldCode, newCode);
            log(`ğŸ“Š è®Šæ›´åˆ†æ: é¡å‹=${changeInfo.type}, åš´é‡æ€§=${changeInfo.severity}, å½±éŸ¿è¡Œæ•¸=${changeInfo.affectedLines.length}`, 'info');
            
            if (testState.isMainEditor && testState.collaborators.length > 0) {
                const shouldTrigger = window.AdvancedConflictDetector.shouldTriggerConflictWarning(
                    oldCode, newCode, testState.collaborators
                );
                
                if (shouldTrigger) {
                    setTimeout(() => {
                        window.AdvancedConflictDetector.showMainEditorConflictWarning(changeInfo, testState.collaborators);
                    }, 500);
                    log('ğŸš¨ è¡çªè­¦å‘Šå·²è§¸ç™¼', 'warning');
                } else {
                    log('â„¹ï¸ æœªé”åˆ°è¡çªè­¦å‘Šé–¾å€¼', 'info');
                }
            }
        }
        
        // æ¸¬è©¦è§£æ±ºæ–¹æ¡ˆ
        function testResolution(type) {
            log(`ğŸ”§ æ¸¬è©¦è§£æ±ºæ–¹æ¡ˆ: ${type}`, 'info');
            
            // å‰µå»ºæ¨¡æ“¬çš„è¡çªæ•¸æ“š
            const mockConflictData = {
                type: 'paste',
                severity: 'high',
                affectedLines: 10,
                otherUsers: testState.collaborators,
                timestamp: Date.now()
            };
            
            switch (type) {
                case 'force':
                    log('âš¡ åŸ·è¡Œå¼·åˆ¶ä¿®æ”¹...', 'warning');
                    // æ¨¡æ“¬å¼·åˆ¶ä¿®æ”¹
                    setTimeout(() => {
                        log('âœ… å¼·åˆ¶ä¿®æ”¹å·²å®Œæˆ', 'success');
                    }, 1000);
                    break;
                    
                case 'vote':
                    log('ğŸ—³ï¸ å•Ÿå‹•æŠ•ç¥¨ç³»çµ±...', 'info');
                    // æ¨¡æ“¬æŠ•ç¥¨
                    setTimeout(() => {
                        log('ğŸ“Š æŠ•ç¥¨è«‹æ±‚å·²ç™¼é€çµ¦å”ä½œè€…', 'info');
                        setTimeout(() => {
                            log('âœ… æŠ•ç¥¨é€šéï¼Œä¿®æ”¹å·²æ‡‰ç”¨', 'success');
                        }, 2000);
                    }, 1000);
                    break;
                    
                case 'chat':
                    log('ğŸ’¬ åˆ†äº«åˆ°èŠå¤©å®¤...', 'info');
                    setTimeout(() => {
                        log('ğŸ“¤ è¡çªä¿¡æ¯å·²åˆ†äº«åˆ°èŠå¤©å®¤', 'success');
                    }, 500);
                    break;
                    
                case 'ai':
                    log('ğŸ¤– è«‹æ±‚AIå”åŠ©...', 'info');
                    setTimeout(() => {
                        log('ğŸ§  AIåˆ†æä¸­...', 'info');
                        setTimeout(() => {
                            log('ğŸ’¡ AIå»ºè­°: å»ºè­°ä¿ç•™å…©å€‹ç‰ˆæœ¬çš„åŠŸèƒ½ï¼Œä¸¦é€²è¡Œåˆä½µ', 'success');
                        }, 2000);
                    }, 1000);
                    break;
            }
        }
        
        // æ¸…ç©ºæ—¥èªŒ
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
            log('ğŸ§¹ æ—¥èªŒå·²æ¸…ç©º', 'info');
        }
        
        // å°å‡ºæ—¥èªŒ
        function exportLog() {
            const logContent = document.getElementById('testLog').textContent;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `conflict-test-log-${new Date().toISOString().slice(0, 19)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            log('ğŸ“¥ æ—¥èªŒå·²å°å‡º', 'success');
        }
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ“„ é é¢è¼‰å…¥å®Œæˆ', 'info');
            initializeSystem();
        });
    </script>
</body>
</html> 