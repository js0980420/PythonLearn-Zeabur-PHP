<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ é é¢é›¢é–‹æ©Ÿåˆ¶èª¿è©¦å·¥å…·</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .log-container {
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: #1e1e1e;
            color: #f0f0f0;
            padding: 10px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .log-info { background: rgba(0, 123, 255, 0.2); }
        .log-success { background: rgba(40, 167, 69, 0.2); }
        .log-warning { background: rgba(255, 193, 7, 0.2); }
        .log-error { background: rgba(220, 53, 69, 0.2); }
    </style>
</head>
<body>
    <div class="container mt-3">
        <h3>ğŸ”§ é é¢é›¢é–‹æ©Ÿåˆ¶èª¿è©¦å·¥å…·</h3>
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">ç”¨æˆ¶ID</label>
                            <input type="text" id="testUserId" class="form-control" value="æ¸¬è©¦ç”¨æˆ¶Debug">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">æˆ¿é–“ID</label>
                            <input type="text" id="testRoomId" class="form-control" value="general-room">
                        </div>
                        <button class="btn btn-primary" onclick="simulateJoinRoom()">æ¨¡æ“¬åŠ å…¥æˆ¿é–“</button>
                        <button class="btn btn-warning" onclick="testLeave()">æ¸¬è©¦é›¢é–‹</button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5>æ—¥èªŒ</h5>
                        <div id="logContainer" style="height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function addLog(message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            logContainer.innerHTML += `[${timestamp}] ${message}<br>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        async function simulateJoinRoom() {
            const userId = document.getElementById('testUserId').value;
            const roomId = document.getElementById('testRoomId').value;
            
            addLog(`åŠ å…¥æˆ¿é–“: ${roomId} ç”¨æˆ¶: ${userId}`);
            
            // å‰µå»ºæ¨¡æ“¬çš„ wsManager
            window.wsManager = {
                currentUser: userId,
                currentRoom: roomId,
                isConnectedState: true,
                isConnected: () => true,
                stopPolling: () => addLog('åœæ­¢è¼ªè©¢')
            };
            
            const formData = new FormData();
            formData.append('action', 'join');
            formData.append('room_id', roomId);
            formData.append('user_id', userId);
            formData.append('username', userId);
            
            try {
                const response = await fetch('/api.php', { method: 'POST', body: formData });
                const result = await response.json();
                addLog(`åŠ å…¥çµæœ: ${JSON.stringify(result)}`);
            } catch (error) {
                addLog(`åŠ å…¥éŒ¯èª¤: ${error.message}`);
            }
        }

        function testLeave() {
            addLog('æ¸¬è©¦é›¢é–‹æˆ¿é–“...');
            
            if (!window.wsManager) {
                addLog('éŒ¯èª¤: è«‹å…ˆæ¨¡æ“¬åŠ å…¥æˆ¿é–“');
                return;
            }
            
            const formData = new FormData();
            formData.append('action', 'leave');
            formData.append('room_id', window.wsManager.currentRoom);
            formData.append('user_id', window.wsManager.currentUser);
            
            const success = navigator.sendBeacon('/api.php', formData);
            addLog(`sendBeacon çµæœ: ${success}`);
        }

        // å®‰è£ beforeunload ç›£è½å™¨
        window.addEventListener('beforeunload', (event) => {
            addLog('é é¢å³å°‡å¸è¼‰');
            
            if (window.wsManager && window.wsManager.currentUser) {
                const formData = new FormData();
                formData.append('action', 'leave');
                formData.append('room_id', window.wsManager.currentRoom);
                formData.append('user_id', window.wsManager.currentUser);
                
                const success = navigator.sendBeacon('/api.php', formData);
                addLog(`beforeunload sendBeacon: ${success}`);
            }
        });

        addLog('èª¿è©¦å·¥å…·å·²è¼‰å…¥');
    </script>
</body>
</html> 