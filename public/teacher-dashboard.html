<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“º æ•™å¸«ç›£æ§å¾Œå° - Pythonå¤šäººå”ä½œæ•™å­¸å¹³å°</title>
    
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --monitor-bg: #1a1a1a;
            --code-bg: #2d3748;
            --active-student: #48bb78;
            --inactive-student: #718096;
            --error-highlight: #f56565;
            --success-highlight: #68d391;
            --panel-bg: #2a2a2a;
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--monitor-bg);
            color: var(--text-primary);
            font-family: 'Microsoft YaHei', sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        /* ä¸»ä½ˆå±€ */
        .monitor-container {
            display: grid;
            grid-template-areas: 
                "controls controls"
                "sidebar monitor"
                "logs logs";
            grid-template-rows: 60px 1fr 150px;
            grid-template-columns: 350px 1fr;
            height: 100vh;
            gap: 10px;
            padding: 10px;
        }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            grid-area: controls;
            background: var(--panel-bg);
            border-radius: 8px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #4a5568;
        }

        .monitor-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--active-student);
        }

        .monitor-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            background: #4a5568;
            border: none;
            color: var(--text-primary);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            display: inline-block !important;
            visibility: visible !important;
        }

        .control-btn:hover {
            background: var(--active-student);
            transform: translateY(-2px);
        }

        .control-btn.active {
            background: var(--active-student);
        }

        /* ç¢ºä¿å»£æ’­æŒ‰éˆ•ä¸€å®šå¯è¦‹ */
        #btnBroadcast {
            display: inline-block !important;
            visibility: visible !important;
            opacity: 1 !important;
            background: #4a5568 !important;
            color: var(--text-primary) !important;
            border: none !important;
            padding: 8px 15px !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            transition: all 0.3s !important;
        }

        #btnBroadcast:hover {
            background: var(--active-student) !important;
            transform: translateY(-2px) !important;
        }

        /* ç¢ºä¿æ§åˆ¶é¢æ¿æŒ‰éˆ•éƒ½å¯è¦‹ */
        .monitor-controls .control-btn {
            display: inline-block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* å´é‚Šæ¬„ */
        .sidebar {
            grid-area: sidebar;
            background: var(--panel-bg);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #4a5568;
            overflow-y: auto;
        }

        .sidebar h3 {
            color: var(--active-student);
            margin-bottom: 15px;
            font-size: 16px;
        }

        /* æˆ¿é–“åˆ—è¡¨ */
        .room-list {
            margin-bottom: 20px;
        }

        .room-item {
            background: #3a3a3a;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
            position: relative;
        }

        .room-item:hover {
            background: #4a4a4a;
            border-left-color: var(--active-student);
        }

        .room-item.active {
            background: #4a4a4a;
            border-left-color: var(--active-student);
        }

        .room-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .room-stats {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .sync-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(72, 187, 120, 0.2);
            border: 1px solid rgba(72, 187, 120, 0.5);
            color: var(--active-student);
            border-radius: 4px;
            padding: 4px 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            opacity: 0.7;
        }

        .sync-btn:hover {
            background: var(--active-student);
            color: #1a202c;
            opacity: 1;
            transform: scale(1.1);
        }

        /* å­¸ç”Ÿåˆ—è¡¨ */
        .student-list {
            margin-bottom: 20px;
        }

        .student-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 5px;
            background: #3a3a3a;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .student-item:hover {
            background: #4a4a4a;
        }

        .student-item.active {
            background: var(--active-student);
            color: #1a1a1a;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        .status-dot.online {
            background: var(--active-student);
        }

        .status-dot.offline {
            background: var(--inactive-student);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .student-activity {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .student-stats {
            text-align: right;
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* ä»£ç¢¼ç›£æ§å€ */
        .code-monitor {
            grid-area: monitor;
            background: var(--code-bg);
            border-radius: 8px;
            border: 1px solid #4a5568;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .monitor-header {
            background: #3a3a3a;
            padding: 15px 20px;
            border-bottom: 1px solid #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .monitor-student-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .monitor-student-name {
            font-size: 18px;
            font-weight: bold;
            color: var(--active-student);
        }

        .monitor-stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .code-editor-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .CodeMirror {
            height: 100% !important;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
            font-size: 14px !important;
            background: var(--code-bg) !important;
        }

        .CodeMirror-gutters {
            background: #2a2a2a !important;
            border-right: 1px solid #4a5568 !important;
        }

        .CodeMirror-linenumber {
            color: var(--text-secondary) !important;
        }

        .code-update {
            animation: codeFlash 0.3s ease-in-out;
        }

        @keyframes codeFlash {
            0% { background-color: rgba(72, 187, 120, 0.3); }
            100% { background-color: transparent; }
        }

        /* æ´»å‹•æ—¥èªŒ */
        .activity-logs {
            grid-area: logs;
            background: var(--panel-bg);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #4a5568;
            overflow-y: auto;
        }

        .log-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            background: #3a3a3a;
            border-radius: 4px;
            font-size: 13px;
            border-left: 3px solid var(--active-student);
        }

        .log-time {
            color: var(--text-secondary);
            font-size: 11px;
        }

        /* é€£ç·šç‹€æ…‹ */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 1000;
        }

        .connection-status.connected {
            background: var(--success-highlight);
            color: #1a1a1a;
        }

        .connection-status.disconnected {
            background: var(--error-highlight);
            color: white;
        }

        /* å…¨è¢å¹•æ¨¡å¼ */
        .fullscreen-mode .monitor-container {
            grid-template-areas: "monitor";
            grid-template-rows: 1fr;
            grid-template-columns: 1fr;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            background: var(--bg-primary);
        }

        .fullscreen-mode .sidebar,
        .fullscreen-mode .control-panel,
        .fullscreen-mode .activity-logs {
            display: none;
        }

        /* å…¨è¢å¹•è¿”å›æŒ‰éˆ• */
        .fullscreen-exit-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            background: var(--error-highlight);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s;
            display: none;
        }

        .fullscreen-mode .fullscreen-exit-btn {
            display: block;
        }

        .fullscreen-exit-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        /* ç¶²æ ¼æª¢è¦–æ¨¡å¼ */
        .grid-view-mode .code-monitor {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            grid-gap: 15px;
            padding: 15px;
        }

        .grid-view-mode .monitor-header {
            display: none;
        }

        .student-code-card {
            background: var(--panel-bg);
            border-radius: 8px;
            border: 1px solid #4a5568;
            overflow: hidden;
            display: none;
        }

        .grid-view-mode .student-code-card {
            display: block;
        }

        .student-code-header {
            background: #3a3a3a;
            padding: 10px 15px;
            border-bottom: 1px solid #4a5568;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .student-code-header .student-name {
            font-weight: bold;
            color: var(--active-student);
        }

        .student-code-header .status-dot {
            width: 8px;
            height: 8px;
            margin-left: 10px;
        }

        .student-code-content {
            height: 300px;
            overflow: hidden;
        }

        .student-code-content .CodeMirror {
            height: 100%;
            font-size: 12px;
        }

        /* è¼‰å…¥å‹•ç•« */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 18px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid #4a5568;
            border-top: 3px solid var(--active-student);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å»£æ’­æ¨¡æ…‹æ¡† */
        .broadcast-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .broadcast-modal.show {
            display: flex;
        }

        .broadcast-content {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 25px;
            width: 450px;
            max-width: 90vw;
            border: 1px solid #4a5568;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .broadcast-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .broadcast-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--active-student);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #4a5568;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .form-select {
            width: 100%;
            padding: 10px 12px;
            background: #3a3a3a;
            border: 1px solid #4a5568;
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--active-student);
            box-shadow: 0 0 0 2px rgba(72, 187, 120, 0.2);
        }

        .form-textarea {
            width: 100%;
            padding: 12px;
            background: #3a3a3a;
            border: 1px solid #4a5568;
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
            transition: all 0.3s;
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--active-student);
            box-shadow: 0 0 0 2px rgba(72, 187, 120, 0.2);
        }

        .form-textarea::placeholder {
            color: var(--text-secondary);
        }

        .broadcast-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-cancel {
            background: #4a5568;
            border: none;
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-cancel:hover {
            background: #5a6578;
        }

        .btn-send {
            background: var(--active-student);
            border: none;
            color: #1a1a1a;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-send:hover {
            background: #38a169;
            transform: translateY(-1px);
        }

        .btn-send:disabled {
            background: #4a5568;
            color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        .broadcast-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .type-option {
            flex: 1;
            padding: 8px 12px;
            background: #4a5568;
            border: 1px solid #6a7280;
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .type-option.active {
            background: var(--active-student);
            color: #1a1a1a;
            border-color: var(--active-student);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--active-student);
            color: #1a1a1a;
        }

        .btn-primary:hover {
            background: #38b2ac;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #4a5568;
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: #5a6578;
        }

        /* èŠå¤©é¢æ¿æ¨£å¼ */
        .chat-panel {
            margin-top: 20px;
        }

        .chat-container {
            background: #3a3a3a;
            border-radius: 8px;
            border: 1px solid #4a5568;
            overflow: hidden;
        }

        .chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: #2a2a2a;
        }

        .chat-empty {
            text-align: center;
            color: var(--text-secondary);
            padding: 40px 20px;
        }

        .chat-empty i {
            font-size: 24px;
            margin-bottom: 10px;
            display: block;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 10px 12px;
            background: #3a3a3a;
            border-radius: 8px;
            border-left: 4px solid #4a5568;
        }

        .chat-message.teacher-message {
            background: #2d5016;
            border-left-color: var(--active-student);
        }

        .chat-message.system-message {
            background: #1a365d;
            border-left-color: #3182ce;
        }

        .chat-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .chat-message-user {
            font-weight: bold;
            color: var(--active-student);
        }

        .chat-message-time {
            color: var(--text-secondary);
        }

        .chat-message-room {
            color: #3182ce;
            font-size: 11px;
        }

        .chat-message-content {
            color: var(--text-primary);
            line-height: 1.4;
            word-wrap: break-word;
        }

        .chat-input-container {
            padding: 15px;
            background: #3a3a3a;
            border-top: 1px solid #4a5568;
        }

        .chat-target-select {
            margin-bottom: 10px;
        }

        .chat-input-group {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 12px;
            background: #2a2a2a;
            border: 1px solid #4a5568;
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--active-student);
            box-shadow: 0 0 0 2px rgba(72, 187, 120, 0.2);
        }

        .chat-send-btn {
            padding: 10px 15px;
            background: var(--active-student);
            border: none;
            border-radius: 6px;
            color: #1a1a1a;
            cursor: pointer;
            transition: all 0.3s;
        }

        .chat-send-btn:hover {
            background: #38b2ac;
            transform: translateY(-1px);
        }

        .chat-send-btn:disabled {
            background: #4a5568;
            color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 1400px) {
            .dashboard-container {
                grid-template-columns: 300px 1fr;
                grid-template-rows: auto 1fr auto;
                grid-template-areas: 
                    "controls controls"
                    "sidebar monitor"
                    "logs logs";
            }
            
            .sidebar {
                max-height: 600px;
            }
            
            .chat-messages {
                height: 200px;
            }
        }

        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                grid-template-areas: 
                    "controls"
                    "sidebar"
                    "monitor"
                    "logs";
            }
            
            .chat-messages {
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <!-- é€£ç·šç‹€æ…‹æŒ‡ç¤ºå™¨ - å·²ç§»é™¤é¿å…èˆ‡å»£æ’­æŒ‰éˆ•é‡ç–Š
    <div id="connectionStatus" class="connection-status disconnected">
        <i class="fas fa-wifi"></i> é€£ç·šä¸­...
    </div>
    -->

    <!-- å»£æ’­æ¨¡æ…‹æ¡† -->
    <div id="broadcastModal" class="broadcast-modal">
        <div class="broadcast-content">
            <div class="broadcast-header">
                <div class="broadcast-title">
                    <i class="fas fa-bullhorn"></i> å»£æ’­æ¶ˆæ¯
                </div>
                <button class="close-btn" onclick="closeBroadcastModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="broadcastForm">
                <div class="form-group">
                    <label class="form-label">å»£æ’­ç›®æ¨™</label>
                    <select id="broadcastTarget" class="form-select">
                        <option value="all">ğŸ“¢ æ‰€æœ‰æˆ¿é–“</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">å»£æ’­å…§å®¹</label>
                    <textarea id="broadcastMessage" class="form-textarea" 
                              placeholder="è«‹è¼¸å…¥è¦å»£æ’­çµ¦å­¸ç”Ÿçš„æ¶ˆæ¯å…§å®¹..."
                              required></textarea>
                </div>
                <div class="broadcast-actions">
                    <button type="button" class="btn-cancel" onclick="closeBroadcastModal()">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="btn-send">
                        <i class="fas fa-paper-plane"></i> ç™¼é€å»£æ’­
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="monitor-container" id="monitorContainer">
        <!-- å…¨è¢å¹•è¿”å›æŒ‰éˆ• -->
        <button class="fullscreen-exit-btn" id="fullscreenExitBtn" onclick="toggleFullscreen()">
            <i class="fas fa-times"></i> é€€å‡ºå…¨è¢å¹•
        </button>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <div class="monitor-title">
                <i class="fas fa-tv"></i> æ•™å¸«ç›£æ§å¾Œå°
                <div class="room-selector" style="margin-left: 20px; display: inline-block;">
                    <select id="teacherRoomSelect" class="form-select" style="background: #4a5568; color: var(--text-primary); border: 1px solid #68d391; padding: 5px 10px; border-radius: 4px; font-size: 14px;" onchange="switchMonitorRoom()">
                        <option value="">é¸æ“‡ç›£æ§æˆ¿é–“</option>
                        <option value="all">ğŸ‘€ ç›£æ§æ‰€æœ‰æˆ¿é–“</option>
                    </select>
                </div>
            </div>
            <div class="monitor-controls">
                <button class="control-btn" id="btnFullscreen" title="å…¨è¢å¹•ç›£æ§">
                    <i class="fas fa-expand"></i> å…¨è¢å¹•
                </button>
                <button class="control-btn" id="btnGridView" title="ç¶²æ ¼æª¢è¦–">
                    <i class="fas fa-th"></i> ç¶²æ ¼æª¢è¦–
                </button>
                <button class="control-btn" id="btnAutoFollow" title="è‡ªå‹•è·Ÿéš¨æ´»èºå­¸ç”Ÿ">
                    <i class="fas fa-eye"></i> è‡ªå‹•è·Ÿéš¨
                </button>
                <button class="control-btn" id="btnPause" title="æš«åœæ›´æ–°">
                    <i class="fas fa-pause"></i> æš«åœ
                </button>
                <button class="control-btn" id="btnBroadcast" title="å»£æ’­æ¶ˆæ¯">
                    <i class="fas fa-bullhorn"></i> å»£æ’­
                </button>
            </div>
        </div>

        <!-- å´é‚Šæ¬„ -->
        <div class="sidebar">
            <!-- æˆ¿é–“åˆ—è¡¨ -->
            <div class="room-list">
                <h3><i class="fas fa-door-open"></i> æ´»èºæˆ¿é–“</h3>
                <div id="roomList">
                    <div class="loading">
                        <div class="spinner"></div>
                        è¼‰å…¥æˆ¿é–“ä¸­...
                    </div>
                </div>
            </div>

            <!-- èŠå¤©é¢æ¿ -->
            <div class="chat-panel">
                <h3><i class="fas fa-comments"></i> èŠå¤©å®¤</h3>
                <div class="chat-container">
                    <div id="teacherChatMessages" class="chat-messages">
                        <div class="chat-empty">
                            <i class="fas fa-comment-dots"></i>
                            <p>æš«ç„¡èŠå¤©æ¶ˆæ¯</p>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <div class="chat-target-select">
                            <select id="chatTargetRoom" class="form-select">
                                <option value="">é¸æ“‡ç›®æ¨™æˆ¿é–“</option>
                                <option value="all">ğŸ“¢ æ‰€æœ‰æˆ¿é–“</option>
                            </select>
                        </div>
                        <div class="chat-input-group">
                            <input type="text" id="teacherChatInput" class="chat-input" placeholder="è¼¸å…¥å›å¾©æ¶ˆæ¯..." maxlength="500">
                            <button id="sendChatBtn" class="chat-send-btn" title="ç™¼é€æ¶ˆæ¯">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- çµ±è¨ˆä¿¡æ¯ -->
            <div class="stats-panel">
                <h3><i class="fas fa-chart-bar"></i> å³æ™‚çµ±è¨ˆ</h3>
                <div id="statsInfo">
                    <div style="font-size: 13px; color: var(--text-secondary);">
                        <div>ç¸½æˆ¿é–“æ•¸: <span id="totalRooms">0</span></div>
                        <div>ç·šä¸Šå­¸ç”Ÿ: <span id="onlineStudents">0</span></div>
                        <div>æ­£åœ¨ç·¨è¼¯: <span id="activeEditors">0</span> äºº</div>
                    </div>
                </div>
                
                <!-- ç‹€æ…‹èªªæ˜ -->
                <div class="status-legend mt-3">
                    <h6><i class="fas fa-info-circle"></i> ç‹€æ…‹èªªæ˜</h6>
                    <div style="font-size: 12px; color: var(--text-secondary);">
                        <div class="d-flex align-items-center mb-1">
                            <div class="status-dot online" style="margin-right: 8px;"></div>
                            <span>åœ¨ç·šç·¨è¼¯ - å­¸ç”Ÿæ­£åœ¨æ´»èºç·¨è¼¯ä»£ç¢¼</span>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <div class="status-dot offline" style="margin-right: 8px;"></div>
                            <span>å·²é›¢ç·š - å­¸ç”Ÿå·²æ–·é–‹é€£æ¥</span>
                        </div>
                        <div class="mt-2">
                            <strong>ç¶²æ ¼æª¢è¦–:</strong> åŒæ™‚ç›£æ§å¤šå€‹å­¸ç”Ÿ<br>
                            <strong>è‡ªå‹•è·Ÿéš¨:</strong> è‡ªå‹•åˆ‡æ›åˆ°æœ€æ´»èºå­¸ç”Ÿ<br>
                            <strong>å»£æ’­åŠŸèƒ½:</strong> å‘å­¸ç”Ÿç™¼é€é€šçŸ¥æ¶ˆæ¯
                        </div>
                    </div>
                </div>
            </div>

            <!-- å­¸ç”Ÿåˆ—è¡¨ -->
            <div class="student-list">
                <h3><i class="fas fa-users"></i> å­¸ç”Ÿç‹€æ…‹</h3>
                <div id="studentList">
                    <div class="loading">
                        <div class="spinner"></div>
                        è¼‰å…¥å­¸ç”Ÿä¸­...
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»£ç¢¼ç›£æ§å€ -->
        <div class="code-monitor">
            <div class="monitor-header">
                <div class="monitor-student-info">
                    <div class="monitor-student-name" id="currentStudentName">
                        é¸æ“‡å­¸ç”Ÿé–‹å§‹ç›£æ§
                    </div>
                    <div class="status-dot online" id="currentStudentStatus"></div>
                </div>
                <div class="monitor-stats">
                    <div class="stat-item">
                        <i class="fas fa-code"></i>
                        <span id="codeLines">0</span> è¡Œ
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-clock"></i>
                        <span id="lastActivity">--</span>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-keyboard"></i>
                        <span id="editFrequency">0</span> æ¬¡/åˆ†
                    </div>
                </div>
            </div>
            <div class="code-editor-container">
                <textarea id="codeEditor"></textarea>
            </div>
            
            <!-- ç¶²æ ¼æª¢è¦–çš„å­¸ç”Ÿä»£ç¢¼å¡ç‰‡å®¹å™¨ -->
            <div id="gridViewContainer"></div>
        </div>
        
        <!-- æ´»å‹•æ—¥èªŒ -->
        <div class="activity-logs">
            <h3><i class="fas fa-history"></i> æ´»å‹•æ—¥èªŒ</h3>
            <div id="activityLog">
                <div class="log-item">
                    <div class="log-time">ç³»çµ±å•Ÿå‹•</div>
                    <div>æ•™å¸«ç›£æ§å¾Œå°å·²å•Ÿå‹•ï¼Œæ­£åœ¨é€£ç·š...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let ws;
        let codeEditor;
        let currentStudent = null;
        let currentRoom = null;
        let isFullscreen = false;
        let isPaused = false;
        let autoFollow = false;
        let isGridView = false;
        let rooms = new Map();
        let students = new Map();
        let teacherId = null;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let gridViewEditors = new Map(); // å­˜å„²ç¶²æ ¼æª¢è¦–ä¸­çš„ç·¨è¼¯å™¨å¯¦ä¾‹
        let refreshInterval;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // èª¿è©¦å»£æ’­æŒ‰éˆ•
            debugBroadcastButton();
            
            initializeCodeEditor();
            initializeControls();
            initializeChat(); // åˆå§‹åŒ–èŠå¤©åŠŸèƒ½
            initializeBroadcastForm(); // åˆå§‹åŒ–å»£æ’­è¡¨å–®
            connectHTTPPolling();
        });

        // èª¿è©¦å»£æ’­æŒ‰éˆ•å‡½æ•¸
        function debugBroadcastButton() {
            setTimeout(() => {
                const btn = document.getElementById('btnBroadcast');
                const controlPanel = document.querySelector('.control-panel');
                const monitorControls = document.querySelector('.monitor-controls');
                
                console.log('ğŸ” å»£æ’­æŒ‰éˆ•èª¿è©¦ä¿¡æ¯:');
                console.log('æŒ‰éˆ•å…ƒç´ :', btn);
                console.log('æ§åˆ¶é¢æ¿:', controlPanel);
                console.log('ç›£æ§æ§åˆ¶å€:', monitorControls);
                
                if (btn) {
                    console.log('æŒ‰éˆ•æ¨£å¼:', {
                        display: window.getComputedStyle(btn).display,
                        visibility: window.getComputedStyle(btn).visibility,
                        opacity: window.getComputedStyle(btn).opacity,
                        width: window.getComputedStyle(btn).width,
                        height: window.getComputedStyle(btn).height,
                        position: window.getComputedStyle(btn).position,
                        zIndex: window.getComputedStyle(btn).zIndex
                    });
                    
                    // å¼·åˆ¶è¨­ç½®æ¨£å¼
                    btn.style.cssText = `
                        display: inline-block !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                        background: #4a5568 !important;
                        color: #e2e8f0 !important;
                        border: none !important;
                        padding: 8px 15px !important;
                        border-radius: 6px !important;
                        cursor: pointer !important;
                        font-size: 14px !important;
                        z-index: 9999 !important;
                        position: relative !important;
                    `;
                    
                    console.log('âœ… å¼·åˆ¶è¨­ç½®å»£æ’­æŒ‰éˆ•æ¨£å¼å®Œæˆ');
                } else {
                    console.error('âŒ æ‰¾ä¸åˆ°å»£æ’­æŒ‰éˆ•å…ƒç´  #btnBroadcast');
                }
                
                // æª¢æŸ¥æ‰€æœ‰æ§åˆ¶æŒ‰éˆ•
                const allBtns = document.querySelectorAll('.control-btn');
                console.log('æ‰€æœ‰æ§åˆ¶æŒ‰éˆ•æ•¸é‡:', allBtns.length);
                allBtns.forEach((button, index) => {
                    console.log(`æŒ‰éˆ• ${index + 1}:`, button.id, button.textContent.trim());
                });
            }, 1000);
        }

        // åˆå§‹åŒ–æ•™å¸«ç›£æ§
        function connectHTTPPolling() {
            addLog('æ­£åœ¨å»ºç«‹æ•™å¸«ç›£æ§é€£æ¥...');
            
            try {
                // åˆå§‹åŒ–æ•™å¸«ID
                initializeTeacher();
                
                // é–‹å§‹è¼ªè©¢
                startTeacherPolling();
                
                addLog('âœ… æ•™å¸«ç›£æ§å·²å•Ÿå‹•');
                reconnectAttempts = 0;
                
            } catch (error) {
                console.error('æ•™å¸«ç›£æ§é€£æ¥å¤±æ•—:', error);
                addLog(`âŒ é€£æ¥å¤±æ•—: ${error.message}`);
                
                // è‡ªå‹•é‡é€£
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    addLog(`å˜—è©¦é‡æ–°é€£ç·š (${reconnectAttempts}/${maxReconnectAttempts})...`);
                    setTimeout(connectHTTPPolling, 3000);
                } else {
                    addLog('é‡é€£å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢');
                }
            }
        }
        
        // åˆå§‹åŒ–æ•™å¸«ID
        function initializeTeacher() {
            teacherId = `teacher_${Date.now()}`;
            addLog(`æ•™å¸«ID: ${teacherId}`);
        }
        
        // é–‹å§‹æ•™å¸«è¼ªè©¢
        function startTeacherPolling() {
            // åœæ­¢ä»»ä½•ç¾æœ‰çš„è¼ªè©¢
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            // ç«‹å³åŸ·è¡Œä¸€æ¬¡
            loadRoomsData();
            
            // è¨­ç½®å®šæœŸè¼ªè©¢ (æ¯2ç§’è¼ªè©¢ä¸€æ¬¡)
            refreshInterval = setInterval(loadRoomsData, 2000);
        }
        

        
        // è™•ç†æ•™å¸«è¼ªè©¢æ•¸æ“š
        function handleTeacherPollingData(data) {
            // æ›´æ–°çµ±è¨ˆä¿¡æ¯
            if (data.stats) {
                updateStats(data.stats);
            }
            
            // æ›´æ–°æˆ¿é–“ä¿¡æ¯
            if (data.rooms) {
                handleRoomsUpdate(data.rooms);
            }
            
            // è™•ç†æ•™å¸«æ¶ˆæ¯
            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(message => {
                    handleMessage(message);
                });
            }
            
            // è™•ç†ç”¨æˆ¶æ´»å‹•
            if (data.activities && data.activities.length > 0) {
                data.activities.forEach(activity => {
                    handleUserActivity(activity);
                });
            }
        }

        // ç™¼é€æ¶ˆæ¯ (HTTP è«‹æ±‚)
        async function sendMessage(message) {
            try {
                const formData = new URLSearchParams();
                formData.append('action', 'teacher_action');
                formData.append('teacher_id', teacherId);
                formData.append('message_type', message.type);
                formData.append('message_data', JSON.stringify(message.data || message));
                
                const response = await fetch('/api.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData
                });
                
                const data = await response.json();
                if (!data.success) {
                    console.error('ç™¼é€æ•™å¸«æ¶ˆæ¯å¤±æ•—:', data.error);
                    addLog(`âŒ æ“ä½œå¤±æ•—: ${data.error}`);
                }
                
            } catch (error) {
                console.error('ç™¼é€æ•™å¸«æ¶ˆæ¯å¤±æ•—:', error);
                addLog(`âŒ ç¶²çµ¡éŒ¯èª¤: ${error.message}`);
            }
        }

        // è™•ç†æ”¶åˆ°çš„æ¶ˆæ¯
        function handleMessage(message) {
            if (isPaused) return;

            switch (message.type) {
                case 'welcome':
                    teacherId = message.userId;
                    addLog(`æ•™å¸«ID: ${teacherId}`);
                    break;

                case 'statistics_update':
                    updateStats(message.data);
                    break;

                case 'stats_update':
                    updateStats(message.data);
                    addLog(`ğŸ“Š çµ±è¨ˆæ›´æ–° - æˆ¿é–“: ${message.data.activeRooms}, å­¸ç”Ÿ: ${message.data.onlineStudents}`);
                    break;

                case 'room_update':
                    handleRoomUpdate(message.data);
                    break;

                case 'room_sync':
                    handleRoomSync(message.data);
                    break;

                case 'code_change':
                    handleCodeChange(message.data);
                    break;

                case 'user_activity':
                    handleUserActivity(message.data);
                    break;

                case 'conflict_detected':
                    handleConflictDetected(message.data);
                    break;

                case 'chat_message':
                    handleChatMessage(message);
                    break;
                    
                case 'teacher_message':
                    handleTeacherMessage(message);
                    break;
                    
                case 'teacher_broadcast':
                    handleTeacherBroadcast(message);
                    break;

                case 'broadcast_error':
                    addLog(`âŒ å»£æ’­éŒ¯èª¤: ${message.message}`);
                    alert(`å»£æ’­éŒ¯èª¤: ${message.message}`);
                    break;

                case 'room_empty':
                    handleRoomEmpty(message.data);
                    break;

                case 'rooms_loaded':
                    handleRoomsLoaded(message.data);
                    break;

                case 'connection_established':
                    addLog(`âœ… é€£æ¥å·²å»ºç«‹: ${message.message || 'æˆåŠŸé€£æ¥åˆ°WebSocketæœå‹™å™¨'}`);
                    if (message.test_id) {
                        addLog(`ğŸ†” æ¸¬è©¦ID: ${message.test_id}`);
                    }
                    break;

                case 'error':
                    addLog(`âŒ æœå‹™å™¨éŒ¯èª¤: ${message.error || message.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                    break;

                default:
                    console.log('æœªè™•ç†çš„æ¶ˆæ¯é¡å‹:', message.type);
                    addLog(`ğŸ“¨ æ”¶åˆ°æœªè™•ç†çš„æ¶ˆæ¯: ${message.type}`);
            }
        }

        // è™•ç†æˆ¿é–“æ›´æ–°
        function handleRoomUpdate(data) {
            const { roomName, users, code, version } = data;
            
            console.log(`ğŸ  æ”¶åˆ°æˆ¿é–“æ›´æ–°:`, { roomName, userCount: users?.length, version, codeLength: code?.length });

            // æ›´æ–°æˆ¿é–“ä¿¡æ¯
            rooms.set(roomName, {
                name: roomName,
                users: users || [],
                code: code || '',
                version: version || 1,
                userCount: users ? users.length : 0,
                lastActivity: data.lastActivity || Date.now(),
                codeLines: code ? code.split('\n').length : 0
            });

            // å…ˆå°‡è©²æˆ¿é–“çš„æ‰€æœ‰å­¸ç”Ÿæ¨™è¨˜ç‚ºé›¢ç·š
            students.forEach((student, studentId) => {
                if (student.roomId === roomName) {
                    student.online = false;
                }
            });

            // æ›´æ–°åœ¨ç·šå­¸ç”Ÿä¿¡æ¯
            if (users && Array.isArray(users)) {
                users.forEach(user => {
                    // ä½¿ç”¨å¤šå€‹å¯èƒ½çš„IDå­—æ®µ
                    const studentId = user.userId || user.id;
                    const studentName = user.userName || user.name || studentId;
                    
                    if (studentId) {
                        students.set(studentId, {
                            id: studentId,
                            userId: studentId,
                            name: studentName,
                            userName: studentName,
                            roomId: roomName,
                            code: code || '',
                            online: true, // æ¨™è¨˜ç‚ºåœ¨ç·š
                            lastActivity: new Date(data.lastActivity || Date.now()),
                            codeLines: code ? code.split('\n').length : 0
                        });
                        
                        console.log(`âœ… æ›´æ–°å­¸ç”Ÿä¿¡æ¯: ${studentName} (${studentId}) - åœ¨ç·š`);

                        // å¦‚æœæ­£åœ¨ç›£æ§é€™å€‹å­¸ç”Ÿï¼Œæ›´æ–°ä»£ç¢¼
                        if (currentStudent === studentId && code) {
                            updateCodeEditor(code);
                            updateCodeStats(code);
                            addLog(`ğŸ”„ ${studentName} çš„ä»£ç¢¼å·²æ›´æ–°`);
                        }

                        // è‡ªå‹•è·Ÿéš¨æœ€æ´»èºçš„å­¸ç”Ÿ
                        if (autoFollow && code && data.lastEditedBy === studentName) {
                            selectStudent(studentId);
                        }
                    }
                });
            }

            // ç§»é™¤ä¸åœ¨ç•¶å‰æˆ¿é–“ç”¨æˆ¶åˆ—è¡¨ä¸­çš„å­¸ç”Ÿï¼ˆä»–å€‘å·²é›¢é–‹ï¼‰
            const currentUserIds = new Set((users || []).map(user => user.userId || user.id));
            const studentsToRemove = [];
            
            students.forEach((student, studentId) => {
                if (student.roomId === roomName && !currentUserIds.has(studentId)) {
                    studentsToRemove.push(studentId);
                    console.log(`ğŸšª å­¸ç”Ÿ ${student.name} (${studentId}) å·²é›¢é–‹æˆ¿é–“ ${roomName}`);
                }
            });
            
            // å¯¦éš›ç§»é™¤é›¢é–‹çš„å­¸ç”Ÿ
            studentsToRemove.forEach(studentId => {
                const student = students.get(studentId);
                addLog(`ğŸšª ${student.name} é›¢é–‹äº†æˆ¿é–“ ${roomName}`);
                students.delete(studentId);
                
                // å¦‚æœæ­£åœ¨ç›£æ§é€™å€‹å­¸ç”Ÿï¼Œæ¸…é™¤ç›£æ§ç‹€æ…‹
                if (currentStudent === studentId) {
                    currentStudent = null;
                    document.getElementById('currentStudentName').textContent = 'é¸æ“‡å­¸ç”Ÿé–‹å§‹ç›£æ§';
                    updateCodeEditor('');
                    updateCodeStats('');
                }
            });

            // å¦‚æœç•¶å‰é¸ä¸­çš„æ˜¯é€™å€‹æˆ¿é–“ï¼Œä¸”æ²’æœ‰é¸ä¸­å­¸ç”Ÿï¼Œé¡¯ç¤ºæˆ¿é–“ä»£ç¢¼
            if (currentRoom === roomName && !currentStudent && code) {
                updateCodeEditor(code);
                updateCodeStats(code);
                document.getElementById('currentStudentName').textContent = `æˆ¿é–“: ${roomName}`;
                addLog(`ğŸ”„ æˆ¿é–“ ${roomName} ä»£ç¢¼å·²æ›´æ–°`);
            }

            updateRoomList();
            updateStudentList();
            updateChatRoomSelector(); // æ·»åŠ é€™è¡Œä¾†æ›´æ–°èŠå¤©æˆ¿é–“é¸æ“‡å™¨
            updateBroadcastTargets(); // åŒæ™‚æ›´æ–°å»£æ’­ç›®æ¨™é¸æ“‡å™¨
            updateTeacherRoomSelector(); // æ›´æ–°æ•™å¸«æˆ¿é–“é¸æ“‡å™¨
        }

        // è™•ç†æˆ¿é–“åŒæ­¥
        function handleRoomSync(data) {
            console.log(`ğŸ”„ æ”¶åˆ°æˆ¿é–“åŒæ­¥éŸ¿æ‡‰:`, data);
            
            // å¼·åˆ¶æ›´æ–°æˆ¿é–“ä¿¡æ¯ï¼Œç¢ºä¿ä»£ç¢¼åŒæ­¥
            handleRoomUpdate(data);
            
            addLog(`ğŸ”„ æˆ¿é–“ ${data.roomName} ä»£ç¢¼å·²å¼·åˆ¶åŒæ­¥`);
        }

        // è«‹æ±‚åŒæ­¥ç‰¹å®šæˆ¿é–“çš„ä»£ç¢¼
        async function syncRoomCode(roomName) {
            try {
                await sendMessage({
                    type: 'teacher_sync_room',
                    data: {
                        room_id: roomName
                    }
                });
                addLog(`ğŸ”„ è«‹æ±‚åŒæ­¥æˆ¿é–“ ${roomName} çš„ä»£ç¢¼`);
            } catch (error) {
                console.error('åŒæ­¥æˆ¿é–“ä»£ç¢¼å¤±æ•—:', error);
                alert('HTTP é€£æ¥å•é¡Œï¼Œç„¡æ³•åŒæ­¥');
            }
        }

        // è™•ç†æˆ¿é–“ç©ºç½®
        function handleRoomEmpty(data) {
            const { roomName, message } = data;
            addLog(`ğŸ  ${message}`);
            
            // ç§»é™¤è©²æˆ¿é–“çš„æ‰€æœ‰å­¸ç”Ÿ
            const studentsToRemove = [];
            students.forEach((student, studentId) => {
                if (student.roomId === roomName) {
                    studentsToRemove.push(studentId);
                }
            });
            
            studentsToRemove.forEach(studentId => {
                const student = students.get(studentId);
                console.log(`ğŸšª æ¸…ç†å­¸ç”Ÿ: ${student.name} (${studentId}) å¾ç©ºæˆ¿é–“ ${roomName}`);
                students.delete(studentId);
                
                // å¦‚æœæ­£åœ¨ç›£æ§é€™å€‹å­¸ç”Ÿï¼Œæ¸…é™¤ç›£æ§ç‹€æ…‹
                if (currentStudent === studentId) {
                    currentStudent = null;
                    document.getElementById('currentStudentName').textContent = 'é¸æ“‡å­¸ç”Ÿé–‹å§‹ç›£æ§';
                    updateCodeEditor('');
                    updateCodeStats('');
                }
            });
            
            // å¦‚æœæˆ¿é–“å·²ç¶“å®Œå…¨æ¸…ç©ºï¼Œå¾rooms Mapä¸­ç§»é™¤
            if (rooms.has(roomName)) {
                const room = rooms.get(roomName);
                if (!room.users || room.users.length === 0) {
                    rooms.delete(roomName);
                    console.log(`ğŸ—‘ï¸ å·²ç§»é™¤ç©ºæˆ¿é–“: ${roomName}`);
                }
            }
            
            updateStudentList();
            updateRoomList();
            updateChatRoomSelector(); // æ·»åŠ é€™è¡Œä¾†æ›´æ–°èŠå¤©æˆ¿é–“é¸æ“‡å™¨
            updateBroadcastTargets(); // åŒæ™‚æ›´æ–°å»£æ’­ç›®æ¨™é¸æ“‡å™¨
        }

        // è™•ç†ä»£ç¢¼è®Šæ›´
        function handleCodeChange(data) {
            const { userId, userName, roomName, code, version, timestamp } = data;
            
            console.log(`ğŸ”„ æ”¶åˆ°ä»£ç¢¼è®Šæ›´é€šçŸ¥:`, { userId, userName, roomName, version });
            
            // æ›´æ–°æˆ¿é–“ä»£ç¢¼
            if (rooms.has(roomName)) {
                const room = rooms.get(roomName);
                room.code = code;
                room.version = version;
                room.lastEditedBy = userName;
                room.lastActivity = timestamp || Date.now();
                room.codeLines = code ? code.split('\n').length : 0;  // æ·»åŠ ä»£ç¢¼è¡Œæ•¸æ›´æ–°
                rooms.set(roomName, room);
                console.log(`âœ… å·²æ›´æ–°æˆ¿é–“ ${roomName} çš„ä»£ç¢¼`);
                
                // å¦‚æœç•¶å‰ç›£æ§çš„æ˜¯é€™å€‹æˆ¿é–“ï¼ˆè€Œä¸æ˜¯ç‰¹å®šå­¸ç”Ÿï¼‰ï¼Œç«‹å³æ›´æ–°é¡¯ç¤º
                if (currentRoom === roomName && !currentStudent) {
                    updateCodeEditor(code);
                    updateCodeStats(code);
                    document.getElementById('currentStudentName').textContent = `æˆ¿é–“: ${roomName}`;
                    addLog(`ğŸ”„ æˆ¿é–“ ${roomName} ä»£ç¢¼å·²å³æ™‚æ›´æ–°`);
                }
            }

            // æ›´æ–°å­¸ç”Ÿä»£ç¢¼ - æ”¹ç”¨userIdä½œç‚ºä¸»è¦åŒ¹é…æ¢ä»¶
            let studentUpdated = false;
            
            // æ–¹æ³•1ï¼šç›´æ¥é€šéuserIdåŒ¹é…
            if (userId && students.has(userId)) {
                const student = students.get(userId);
                student.code = code;
                student.lastActivity = new Date(timestamp || Date.now());
                student.codeLines = code.split('\n').length;
                students.set(userId, student);
                studentUpdated = true;
                
                console.log(`âœ… ç›´æ¥é€šéuserId ${userId} æ›´æ–°å­¸ç”Ÿä»£ç¢¼`);
                
                // å¦‚æœæ­£åœ¨ç›£æ§é€™å€‹å­¸ç”Ÿï¼Œç«‹å³æ›´æ–°ä»£ç¢¼ç·¨è¼¯å™¨
                if (currentStudent === userId) {
                    updateCodeEditor(code);
                    updateCodeStats(code);
                    addLog(`ğŸ”„ ${userName} çš„ä»£ç¢¼å·²å³æ™‚æ›´æ–°`);
                }
            }
            
            // æ–¹æ³•2ï¼šå¦‚æœç›´æ¥åŒ¹é…å¤±æ•—ï¼Œå˜—è©¦é€šéç”¨æˆ¶åå’Œæˆ¿é–“åŒ¹é…
            if (!studentUpdated) {
                students.forEach((student, studentId) => {
                    if (student.roomId === roomName && (student.name === userName || student.userName === userName)) {
                        student.code = code;
                        student.lastActivity = new Date(timestamp || Date.now());
                        student.codeLines = code.split('\n').length;
                        students.set(studentId, student);
                        studentUpdated = true;
                        
                        console.log(`âœ… é€šéç”¨æˆ¶å ${userName} åŒ¹é…æ›´æ–°å­¸ç”Ÿ ${studentId} ä»£ç¢¼`);

                        // å¦‚æœæ­£åœ¨ç›£æ§é€™å€‹å­¸ç”Ÿï¼Œç«‹å³æ›´æ–°ä»£ç¢¼ç·¨è¼¯å™¨
                        if (currentStudent === studentId) {
                            updateCodeEditor(code);
                            updateCodeStats(code);
                            addLog(`ğŸ”„ ${userName} çš„ä»£ç¢¼å·²å³æ™‚æ›´æ–°`);
                        }
                    }
                });
            }
            
            // å¦‚æœæ²’æœ‰æ‰¾åˆ°å°æ‡‰çš„å­¸ç”Ÿï¼Œè¨˜éŒ„è­¦å‘Š
            if (!studentUpdated) {
                console.warn(`âš ï¸ ç„¡æ³•æ‰¾åˆ°å°æ‡‰çš„å­¸ç”Ÿé€²è¡Œä»£ç¢¼æ›´æ–°:`, { userId, userName, roomName });
                addLog(`âš ï¸ ä»£ç¢¼æ›´æ–°è­¦å‘Š: æ‰¾ä¸åˆ°å­¸ç”Ÿ ${userName} (${userId || 'N/A'})`);
            }

            // è‡ªå‹•è·Ÿéš¨æœ€æ´»èºçš„å­¸ç”Ÿ
            if (autoFollow && studentUpdated && userId) {
                selectStudent(userId);
            }

            updateStudentList();
            updateRoomList();
            addLog(`ğŸ“ ${userName} åœ¨æˆ¿é–“ ${roomName} æ›´æ–°äº†ä»£ç¢¼ (ç‰ˆæœ¬ ${version})`);
        }

        // è™•ç†ç”¨æˆ¶æ´»å‹•
        function handleUserActivity(data) {
            const { userName, action, roomName } = data;
            addLog(`${userName} ${action} - æˆ¿é–“: ${roomName}`);
        }

        // è™•ç†è¡çªæª¢æ¸¬
        function handleConflictDetected(data) {
            const { userName, roomName, clientVersion, serverVersion } = data;
            addLog(`âš ï¸ è¡çªæª¢æ¸¬: ${userName} åœ¨æˆ¿é–“ ${roomName} (å®¢æˆ¶ç«¯ç‰ˆæœ¬: ${clientVersion}, æœå‹™å™¨ç‰ˆæœ¬: ${serverVersion})`);
        }

        // è™•ç†èŠå¤©æ¶ˆæ¯
        function handleChatMessage(message) {
            // æœå‹™å™¨ç™¼é€çš„æ¶ˆæ¯çµæ§‹ï¼š{ type: 'chat_message', id, userId, userName, message, timestamp, roomName?, isTeacher? }
            const { userName, roomName, message: chatText, isTeacher } = message;
            const messageType = isTeacher ? 'teacher' : 'student';
            
            console.log(`ğŸ’¬ æ•™å¸«ç«¯æ”¶åˆ°èŠå¤©æ¶ˆæ¯:`, message);
            addLog(`ğŸ’¬ ${userName} åœ¨æˆ¿é–“ ${roomName || 'æœªçŸ¥æˆ¿é–“'}: ${chatText}`);
            
            // æ·»åŠ åˆ°èŠå¤©é¢æ¿
            addChatMessage(userName, roomName || 'æœªçŸ¥æˆ¿é–“', chatText, messageType);
            
            // ç¢ºä¿æˆ¿é–“åœ¨é¸æ“‡å™¨ä¸­
            updateChatRoomSelector();
        }
        
        // è™•ç†æ•™å¸«æ¶ˆæ¯
        function handleTeacherMessage(message) {
            const username = message.username || 'æ•™å¸«';
            const content = message.message || '';
            const roomName = message.room || 'æœªçŸ¥æˆ¿é–“';
            
            addChatMessage(username, roomName, content, 'teacher');
            addLog(`ğŸ‘¨â€ğŸ« ${username} å‘ ${roomName}: ${content}`);
        }
        
        // è™•ç†æ•™å¸«å»£æ’­
        function handleTeacherBroadcast(message) {
            const content = message.message || '';
            const roomName = message.room || 'æœªçŸ¥æˆ¿é–“';
            const messageType = message.messageType || 'info';
            
            addLog(`ğŸ“¢ æ•™å¸«å»£æ’­åˆ° ${roomName}: ${content}`);
            
            // å¯ä»¥åœ¨é€™è£¡æ·»åŠ ç‰¹æ®Šçš„å»£æ’­æ¶ˆæ¯é¡¯ç¤ºé‚è¼¯
            if (messageType === 'warning') {
                addLog(`âš ï¸ è­¦å‘Šå»£æ’­: ${content}`);
            } else if (messageType === 'error') {
                addLog(`âŒ éŒ¯èª¤å»£æ’­: ${content}`);
            } else {
                addLog(`â„¹ï¸ ä¿¡æ¯å»£æ’­: ${content}`);
            }
        }

        // æ·»åŠ èŠå¤©æ¶ˆæ¯åˆ°èŠå¤©é¢æ¿
        function addChatMessage(userName, roomName, message, type = 'student') {
            const chatMessages = document.getElementById('teacherChatMessages');
            if (!chatMessages) return;

            // ç§»é™¤ç©ºç‹€æ…‹
            const emptyState = chatMessages.querySelector('.chat-empty');
            if (emptyState) {
                emptyState.remove();
            }

            // å‰µå»ºèŠå¤©æ¶ˆæ¯å…ƒç´ 
            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${type === 'teacher' ? 'teacher-message' : ''}`;
            
            const timeString = new Date().toLocaleTimeString('zh-TW', {
                hour: '2-digit',
                minute: '2-digit'
            });

            messageElement.innerHTML = `
                <div class="chat-message-header">
                    <div class="chat-message-user">${userName}</div>
                    <div class="chat-message-time">${timeString}</div>
                </div>
                <div class="chat-message-room">æˆ¿é–“: ${roomName}</div>
                <div class="chat-message-content">${escapeHtml(message)}</div>
            `;

            // æ·»åŠ åˆ°èŠå¤©å®¹å™¨
            chatMessages.appendChild(messageElement);

            // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // é™åˆ¶èŠå¤©æ¶ˆæ¯æ•¸é‡
            const maxMessages = 100;
            if (chatMessages.children.length > maxMessages) {
                chatMessages.removeChild(chatMessages.firstChild);
            }
        }

        // æ›´æ–°èŠå¤©æˆ¿é–“é¸æ“‡å™¨
        function updateChatRoomSelector() {
            const selector = document.getElementById('chatTargetRoom');
            if (!selector) {
                console.warn('âŒ æ‰¾ä¸åˆ°èŠå¤©æˆ¿é–“é¸æ“‡å™¨å…ƒç´ ');
                return;
            }

            // ä¿å­˜ç•¶å‰é¸ä¸­å€¼
            const currentValue = selector.value;

            // æ¸…ç©ºç¾æœ‰é¸é …ï¼ˆä¿ç•™é è¨­é¸é …ï¼‰
            selector.innerHTML = `
                <option value="">é¸æ“‡ç›®æ¨™æˆ¿é–“</option>
                <option value="all">ğŸ“¢ æ‰€æœ‰æˆ¿é–“</option>
            `;

            // æ·»åŠ æ´»èºæˆ¿é–“
            let roomCount = 0;
            rooms.forEach((room, roomName) => {
                const option = document.createElement('option');
                option.value = roomName;
                option.textContent = `${roomName} (${room.userCount || 0} äºº)`;
                selector.appendChild(option);
                roomCount++;
            });

            // æ¢å¾©é¸ä¸­å€¼
            if (currentValue && [...selector.options].some(opt => opt.value === currentValue)) {
                selector.value = currentValue;
            }

            console.log(`âœ… èŠå¤©æˆ¿é–“é¸æ“‡å™¨å·²æ›´æ–°ï¼Œæ·»åŠ äº† ${roomCount} å€‹æˆ¿é–“`);
        }

        // ç™¼é€æ•™å¸«èŠå¤©æ¶ˆæ¯
        async function sendTeacherChatMessage() {
            const input = document.getElementById('teacherChatInput');
            const selector = document.getElementById('chatTargetRoom');
            
            if (!input || !selector) return;

            const message = input.value.trim();
            const targetRoom = selector.value;

            if (!message) {
                alert('è«‹è¼¸å…¥æ¶ˆæ¯å…§å®¹');
                return;
            }

            if (!targetRoom) {
                alert('è«‹é¸æ“‡ç›®æ¨™æˆ¿é–“');
                return;
            }

            // ç™¼é€æ¶ˆæ¯åˆ°æœå‹™å™¨ (ä½¿ç”¨ HTTP è«‹æ±‚)
            try {
                await sendMessage({
                    type: 'teacher_chat',
                    data: {
                        targetRoom: targetRoom,
                        message: message,
                        teacherName: 'æ•™å¸«'
                    }
                });

                // åœ¨èŠå¤©é¢æ¿é¡¯ç¤ºè‡ªå·±çš„æ¶ˆæ¯
                const displayRoom = targetRoom === 'all' ? 'æ‰€æœ‰æˆ¿é–“' : targetRoom;
                addChatMessage('æ•™å¸«', displayRoom, message, 'teacher');

                // æ¸…ç©ºè¼¸å…¥æ¡†
                input.value = '';
                
                addLog(`ğŸ’¬ æ•™å¸«å‘ ${displayRoom} ç™¼é€æ¶ˆæ¯: ${message}`);
            } catch (error) {
                console.error('ç™¼é€æ¶ˆæ¯å¤±æ•—:', error);
                alert('ç™¼é€æ¶ˆæ¯å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥');
            }
        }

        // HTMLè½‰ç¾©å‡½æ•¸
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // åˆå§‹åŒ–èŠå¤©åŠŸèƒ½
        function initializeChat() {
            const sendBtn = document.getElementById('sendChatBtn');
            const input = document.getElementById('teacherChatInput');

            if (sendBtn) {
                sendBtn.addEventListener('click', sendTeacherChatMessage);
            }

            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendTeacherChatMessage();
                    }
                });
            }

            // åˆå§‹åŒ–æˆ¿é–“é¸æ“‡å™¨
            updateChatRoomSelector();
        }

        // è™•ç†æˆ¿é–“è¼‰å…¥
        function handleRoomsLoaded(data) {
            if (data && data.rooms) {
                // æ¸…ç©ºç¾æœ‰æˆ¿é–“
                rooms.clear();
                
                // è¼‰å…¥æ‰€æœ‰æˆ¿é–“
                data.rooms.forEach(room => {
                    rooms.set(room.name, {
                        name: room.name,
                        users: room.users || [],
                        code: room.code || '',
                        version: room.version || 1,
                        userCount: room.users ? room.users.length : 0
                    });
                    
                    // æ›´æ–°å­¸ç”Ÿä¿¡æ¯
                    if (room.users) {
                        room.users.forEach(user => {
                            students.set(user.id, {
                                id: user.id,
                                name: user.name || user.id,
                                roomId: room.name,
                                code: room.code || '',
                                online: true,
                                lastActivity: new Date(),
                                codeLines: room.code ? room.code.split('\n').length : 0
                            });
                        });
                    }
                });
                
                updateRoomList();
                updateStudentList();
                updateChatRoomSelector(); // æ·»åŠ é€™è¡Œä¾†æ›´æ–°èŠå¤©æˆ¿é–“é¸æ“‡å™¨
                updateBroadcastTargets(); // åŒæ™‚æ›´æ–°å»£æ’­ç›®æ¨™é¸æ“‡å™¨
                addLog(`ğŸ“‚ è¼‰å…¥äº† ${data.rooms.length} å€‹æˆ¿é–“`);
            }
        }

        // åˆå§‹åŒ–ä»£ç¢¼ç·¨è¼¯å™¨
        function initializeCodeEditor() {
            codeEditor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
                mode: 'python',
                theme: 'monokai',
                lineNumbers: true,
                readOnly: true,
                lineWrapping: true,
                fontSize: '14px',
                autoRefresh: true,
                viewportMargin: Infinity
            });

            // è¨­ç½®åˆå§‹ä»£ç¢¼
            codeEditor.setValue('');  // ç§»é™¤é è¨­æ–‡å­—ï¼Œä¿æŒç©ºç™½
        }

        // åˆå§‹åŒ–æ§åˆ¶æŒ‰éˆ•
        function initializeControls() {
            document.getElementById('btnFullscreen').addEventListener('click', toggleFullscreen);
            document.getElementById('btnGridView').addEventListener('click', toggleGridView);
            document.getElementById('btnAutoFollow').addEventListener('click', toggleAutoFollow);
            document.getElementById('btnPause').addEventListener('click', togglePause);
            document.getElementById('btnBroadcast').addEventListener('click', toggleBroadcast);

            // ç¢ºä¿å»£æ’­æŒ‰éˆ•å¯è¦‹
            const broadcastBtn = document.getElementById('btnBroadcast');
            if (broadcastBtn) {
                broadcastBtn.style.display = 'inline-block';
                broadcastBtn.style.visibility = 'visible';
                broadcastBtn.style.opacity = '1';
                console.log('âœ… å»£æ’­æŒ‰éˆ•å·²åˆå§‹åŒ–ä¸¦è¨­å®šç‚ºå¯è¦‹');
            } else {
                console.error('âŒ æ‰¾ä¸åˆ°å»£æ’­æŒ‰éˆ•å…ƒç´ ');
            }

            // éµç›¤å¿«æ·éµ
            document.addEventListener('keydown', (e) => {
                if (e.key === 'F11') {
                    e.preventDefault();
                    toggleFullscreen();
                } else if (e.key === ' ') {
                    e.preventDefault();
                    togglePause();
                }
            });
        }

        // æ›´æ–°ä»£ç¢¼ç·¨è¼¯å™¨
        function updateCodeEditor(code) {
            const currentCode = codeEditor.getValue();
            if (currentCode !== code) {
                codeEditor.setValue(code);
                
                // æ·»åŠ æ›´æ–°å‹•ç•«
                const wrapper = codeEditor.getWrapperElement();
                wrapper.classList.add('code-update');
                setTimeout(() => {
                    wrapper.classList.remove('code-update');
                }, 300);
            }
        }

        // æ›´æ–°ä»£ç¢¼çµ±è¨ˆ
        function updateCodeStats(code) {
            const lines = code.split('\n').length;
            document.getElementById('codeLines').textContent = lines;
            document.getElementById('lastActivity').textContent = 'å‰›å‰›';
        }

        // é¸æ“‡å­¸ç”Ÿ
        function selectStudent(studentId) {
            currentStudent = studentId;
            const student = students.get(studentId);
            
            if (student) {
                document.getElementById('currentStudentName').textContent = student.name;
                
                // æ›´æ–°å­¸ç”Ÿåˆ—è¡¨é¸ä¸­ç‹€æ…‹
                document.querySelectorAll('.student-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const studentElement = document.querySelector(`[data-student="${studentId}"]`);
                if (studentElement) {
                    studentElement.classList.add('active');
                }

                // é¡¯ç¤ºå­¸ç”Ÿä»£ç¢¼
                updateCodeEditor(student.code || '');  // ç§»é™¤é è¨­æç¤ºæ–‡å­—
                updateCodeStats(student.code || '');
                
                addLog(`é–‹å§‹ç›£æ§å­¸ç”Ÿ: ${student.name}`);
            }
        }

        // æ›´æ–°æˆ¿é–“åˆ—è¡¨
        function updateRoomList() {
            const container = document.getElementById('roomList');
            container.innerHTML = '';

            if (rooms.size === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">æš«ç„¡æ´»èºæˆ¿é–“</div>';
                return;
            }

            rooms.forEach((room, roomId) => {
                const roomElement = document.createElement('div');
                roomElement.className = 'room-item';
                if (currentRoom === roomId) {
                    roomElement.classList.add('active');
                }
                roomElement.dataset.room = roomId;
                roomElement.innerHTML = `
                    <div class="room-name">${roomId}</div>
                    <div class="room-stats">${room.userCount} äººåœ¨ç·š â€¢ ${room.codeLines || 0} è¡Œä»£ç¢¼</div>
                    <button class="sync-btn" onclick="event.stopPropagation(); syncRoomCode('${roomId}')" title="åŒæ­¥æˆ¿é–“ä»£ç¢¼">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                `;
                
                roomElement.addEventListener('click', () => selectRoom(roomId));
                container.appendChild(roomElement);
            });
        }

        // æ›´æ–°å­¸ç”Ÿåˆ—è¡¨ - åªé¡¯ç¤ºç•¶å‰é¸ä¸­æˆ¿é–“çš„å­¸ç”Ÿ
        function updateStudentList() {
            const container = document.getElementById('studentList');
            container.innerHTML = '';

            // å¦‚æœæ²’æœ‰é¸ä¸­æˆ¿é–“ï¼Œé¡¯ç¤ºæç¤º
            if (!currentRoom) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">è«‹å…ˆé¸æ“‡æˆ¿é–“</div>';
                return;
            }

            // ç¯©é¸ç•¶å‰æˆ¿é–“çš„å­¸ç”Ÿ
            const roomStudents = new Map();
            students.forEach((student, studentId) => {
                if (student.roomId === currentRoom) {
                    roomStudents.set(studentId, student);
                }
            });

            if (roomStudents.size === 0) {
                container.innerHTML = `<div style="text-align: center; color: var(--text-secondary); padding: 20px;">æˆ¿é–“ã€Œ${currentRoom}ã€æš«ç„¡å­¸ç”Ÿ</div>`;
                return;
            }
            
            roomStudents.forEach((student, studentId) => {
                const studentElement = document.createElement('div');
                studentElement.className = 'student-item';
                if (currentStudent === studentId) {
                    studentElement.classList.add('active');
                }
                studentElement.dataset.student = studentId;
                
                const timeDiff = new Date() - student.lastActivity;
                const lastActivity = timeDiff < 60000 ? 'å‰›å‰›' : `${Math.floor(timeDiff / 60000)}åˆ†é˜å‰`;
                
                studentElement.innerHTML = `
                    <div class="status-dot ${student.online ? 'online' : 'offline'}"></div>
                    <div class="student-info">
                        <div class="student-name">${student.name}</div>
                        <div class="student-activity">
                            ${student.online ? 'ğŸŸ¢ åœ¨ç·šç·¨è¼¯' : 'ğŸ”´ å·²é›¢ç·š'} â€¢ ${lastActivity}
                            <br><small>${student.codeLines} è¡Œä»£ç¢¼</small>
                        </div>
                    </div>
                    <div class="student-stats">
                        <div>${student.codeLines} è¡Œ</div>
                        <div><small>${student.online ? 'æ´»èº' : 'é›¢ç·š'}</small></div>
                    </div>
                `;
                
                studentElement.addEventListener('click', () => selectStudent(studentId));
                studentElement.addEventListener('dblclick', () => {
                    selectStudent(studentId);
                    if (!isFullscreen) toggleFullscreen();
                });
                
                container.appendChild(studentElement);
            });
            
            // æ›´æ–°ç¶²æ ¼æª¢è¦–
            updateGridView();
        }

        // æ›´æ–°çµ±è¨ˆä¿¡æ¯
        function updateStats(data) {
            document.getElementById('totalRooms').textContent = data.activeRooms || 0;
            document.getElementById('onlineStudents').textContent = data.onlineStudents || 0;
            document.getElementById('activeEditors').textContent = data.editCount || 0;
        }

        // é¸æ“‡æˆ¿é–“ - æ”¹é€²é‚è¼¯
        function selectRoom(roomId) {
            const oldRoom = currentRoom;
            currentRoom = roomId;
            
            // æ¸…é™¤ç•¶å‰å­¸ç”Ÿé¸æ“‡
            currentStudent = null;
            
            // æ›´æ–°æˆ¿é–“åˆ—è¡¨é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.room-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const roomElement = document.querySelector(`[data-room="${roomId}"]`);
            if (roomElement) {
                roomElement.classList.add('active');
            }
            
            // æ¸…é™¤å­¸ç”Ÿåˆ—è¡¨çš„é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.student-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // è¼‰å…¥æˆ¿é–“è©³ç´°ä¿¡æ¯
            loadRoomDetails(roomId);
            
            // æ›´æ–°ç›£æ§æ¨™é¡Œ
            document.getElementById('currentStudentName').textContent = `æˆ¿é–“: ${roomId}`;
            
            // æ›´æ–°ç›£æ§ç‹€æ…‹
            const statusDot = document.getElementById('currentStudentStatus');
            if (statusDot) {
                statusDot.className = 'status-dot online';
            }
            
            addLog(`åˆ‡æ›åˆ°æˆ¿é–“: ${roomId}`);
            
            // æ›´æ–°å­¸ç”Ÿåˆ—è¡¨ï¼ˆåªé¡¯ç¤ºç•¶å‰æˆ¿é–“çš„å­¸ç”Ÿï¼‰
            updateStudentList();
        }

        // åˆ‡æ›å…¨è¢å¹•
        function toggleFullscreen() {
            isFullscreen = !isFullscreen;
            const container = document.getElementById('monitorContainer');
            const btn = document.getElementById('btnFullscreen');
            
            if (isFullscreen) {
                container.classList.add('fullscreen-mode');
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-compress"></i> é€€å‡ºå…¨è¢å¹•';
            } else {
                container.classList.remove('fullscreen-mode');
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-expand"></i> å…¨è¢å¹•';
            }
            
            // åˆ·æ–°ç·¨è¼¯å™¨
            setTimeout(() => {
                if (codeEditor) {
                    codeEditor.refresh();
                }
            }, 100);
        }

        // åˆ‡æ›ç¶²æ ¼æª¢è¦–
        function toggleGridView() {
            isGridView = !isGridView;
            const container = document.getElementById('monitorContainer');
            const btn = document.getElementById('btnGridView');
            
            if (isGridView) {
                container.classList.add('grid-view-mode');
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-th"></i> ç¶²æ ¼æª¢è¦–';
            } else {
                container.classList.remove('grid-view-mode');
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-th"></i> ç¶²æ ¼æª¢è¦–';
            }
            
            // åˆ·æ–°ç·¨è¼¯å™¨
            setTimeout(() => {
                if (codeEditor) {
                    codeEditor.refresh();
                }
            }, 100);
        }

        // åˆ‡æ›è‡ªå‹•è·Ÿéš¨
        function toggleAutoFollow() {
            autoFollow = !autoFollow;
            const btn = document.getElementById('btnAutoFollow');
            
            if (autoFollow) {
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-eye-slash"></i> åœæ­¢è·Ÿéš¨';
                addLog('å·²å•Ÿç”¨è‡ªå‹•è·Ÿéš¨æ´»èºå­¸ç”Ÿ');
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-eye"></i> è‡ªå‹•è·Ÿéš¨';
                addLog('å·²åœç”¨è‡ªå‹•è·Ÿéš¨');
            }
        }

        // åˆ‡æ›æš«åœ
        function togglePause() {
            isPaused = !isPaused;
            const btn = document.getElementById('btnPause');
            
            if (isPaused) {
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-play"></i> æ¢å¾©';
                addLog('å·²æš«åœå³æ™‚æ›´æ–°');
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-pause"></i> æš«åœ';
                addLog('å·²æ¢å¾©å³æ™‚æ›´æ–°');
            }
        }

        // æ•™å¸«å»£æ’­åŠŸèƒ½ - é¡¯ç¤ºæ¨¡æ…‹æ¡†
        function toggleBroadcast() {
            updateBroadcastTargets();
            document.getElementById('broadcastModal').classList.add('show');
        }

        // é—œé–‰å»£æ’­æ¨¡æ…‹æ¡†
        function closeBroadcastModal() {
            document.getElementById('broadcastModal').classList.remove('show');
            document.getElementById('broadcastForm').reset();
        }

        // æ›´æ–°å»£æ’­ç›®æ¨™é¸é …
        function updateBroadcastTargets() {
            const select = document.getElementById('broadcastTarget');
            if (!select) {
                console.warn('âŒ æ‰¾ä¸åˆ°å»£æ’­ç›®æ¨™é¸æ“‡å™¨å…ƒç´ ');
                return;
            }
            
            select.innerHTML = '<option value="all">ğŸ“¢ æ‰€æœ‰æˆ¿é–“</option>';
            
            let roomCount = 0;
            rooms.forEach((room, roomId) => {
                const option = document.createElement('option');
                option.value = roomId;
                option.textContent = `ğŸ  ${roomId} (${room.userCount} äºº)`;
                select.appendChild(option);
                roomCount++;
            });
            
            // å¦‚æœæœ‰ç•¶å‰é¸ä¸­çš„æˆ¿é–“ï¼Œè¨­ç‚ºé è¨­å€¼
            if (currentRoom && rooms.has(currentRoom)) {
                select.value = currentRoom;
            }
            
            console.log(`âœ… å»£æ’­ç›®æ¨™é¸æ“‡å™¨å·²æ›´æ–°ï¼Œæ·»åŠ äº† ${roomCount} å€‹æˆ¿é–“`);
        }

        // è™•ç†å»£æ’­è¡¨å–®æäº¤
        function initializeBroadcastForm() {
            const broadcastForm = document.getElementById('broadcastForm');
            if (broadcastForm) {
                broadcastForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const target = document.getElementById('broadcastTarget').value;
                    const message = document.getElementById('broadcastMessage').value.trim();
                    
                    if (!message) {
                        alert('è«‹è¼¸å…¥å»£æ’­å…§å®¹');
                        return;
                    }
                    
                    // ä½¿ç”¨ HTTP è«‹æ±‚ç™¼é€å»£æ’­ (æ›¿ä»£ WebSocket)
                    try {
                        await sendMessage({
                            type: 'teacher_broadcast',
                            data: {
                                targetRoom: target,
                                message: message,
                                messageType: 'info'
                            }
                        });
                        
                        const targetName = target === 'all' ? 'æ‰€æœ‰æˆ¿é–“' : target;
                        addLog(`ğŸ“¢ å·²å»£æ’­æ¶ˆæ¯åˆ° ${targetName}: ${message}`);
                        closeBroadcastModal();
                    } catch (error) {
                        console.error('å»£æ’­å¤±æ•—:', error);
                        alert('å»£æ’­å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥');
                    }
                });
            }
        }

        // å‰µå»ºç¶²æ ¼æª¢è¦–å­¸ç”Ÿä»£ç¢¼å¡ç‰‡
        function createStudentCodeCard(studentId, student) {
            const card = document.createElement('div');
            card.className = 'student-code-card';
            card.dataset.student = studentId;
            
            card.innerHTML = `
                <div class="student-code-header">
                    <div class="student-name">${student.name}</div>
                    <div class="status-dot ${student.online ? 'online' : 'offline'}"></div>
                </div>
                <div class="student-code-content">
                    <textarea class="grid-code-editor" id="gridEditor_${studentId}"></textarea>
                </div>
            `;
            
            return card;
        }

        // æ›´æ–°ç¶²æ ¼æª¢è¦–
        function updateGridView() {
            if (!isGridView) return;
            
            const container = document.getElementById('gridViewContainer');
            container.innerHTML = '';
            
            students.forEach((student, studentId) => {
                const card = createStudentCodeCard(studentId, student);
                container.appendChild(card);
                
                // åˆå§‹åŒ–é€™å€‹å­¸ç”Ÿçš„ä»£ç¢¼ç·¨è¼¯å™¨
                setTimeout(() => {
                    const textarea = document.getElementById(`gridEditor_${studentId}`);
                    if (textarea && !gridViewEditors.has(studentId)) {
                        const editor = CodeMirror.fromTextArea(textarea, {
                            mode: 'python',
                            theme: 'monokai',
                            lineNumbers: true,
                            readOnly: true,
                            lineWrapping: true,
                            fontSize: '12px'
                        });
                        
                        editor.setValue(student.code || '');
                        gridViewEditors.set(studentId, editor);
                    }
                }, 100);
            });
        }

        // æ·»åŠ æ—¥èªŒ
        function addLog(message) {
            const logContainer = document.getElementById('activityLog');
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            
            const time = new Date().toLocaleTimeString();
            logItem.innerHTML = `
                <div class="log-time">${time}</div>
                <div>${message}</div>
            `;
            
            logContainer.insertBefore(logItem, logContainer.firstChild);
            
            // é™åˆ¶æ—¥èªŒæ•¸é‡
            const logs = logContainer.querySelectorAll('.log-item');
            if (logs.length > 50) {
                logs[logs.length - 1].remove();
            }
        }

        // è™•ç†è¦–çª—å¤§å°è®ŠåŒ–
        window.addEventListener('resize', () => {
            setTimeout(() => {
                if (codeEditor) {
                    codeEditor.refresh();
                }
            }, 100);
        });

        // é é¢å¸è¼‰æ™‚é—œé–‰é€£æ¥
        window.addEventListener('beforeunload', () => {
            // åœæ­¢ HTTP è¼ªè©¢
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            
            // é€šçŸ¥æœå‹™å™¨æ•™å¸«é›¢ç·š
            if (teacherId) {
                navigator.sendBeacon('/api.php', new URLSearchParams({
                    action: 'teacher_disconnect',
                    teacher_id: teacherId
                }));
            }
        });

        // è¼‰å…¥æˆ¿é–“æ•¸æ“š
        async function loadRoomsData() {
            try {
                const response = await fetch('/api/teacher.php?action=rooms');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('ğŸ“Š è¼‰å…¥æˆ¿é–“æ•¸æ“š:', data);
                
                // æ›´æ–°çµ±è¨ˆä¿¡æ¯
                updateStats({
                    activeRooms: data.activeRooms || data.totalRooms || 0,
                    onlineStudents: data.studentsInRooms || data.nonTeacherUsers || data.totalUsers || 0,
                    editCount: 0 // é€™å€‹å€¼éœ€è¦å¾å…¶ä»–åœ°æ–¹ç²å–
                });
                
                // æ¸…ç©ºç¾æœ‰æˆ¿é–“æ•¸æ“š
                rooms.clear();
                students.clear();
                
                // è™•ç†æˆ¿é–“æ•¸æ“š
                if (data.rooms && Array.isArray(data.rooms)) {
                    data.rooms.forEach(room => {
                        // æ·»åŠ æˆ¿é–“
                        rooms.set(room.id, {
                            name: room.name || room.id,
                            users: room.users || [],
                            code: room.current_code || '',
                            version: room.version || 1,
                            userCount: room.userCount || 0,
                            lastActivity: room.last_activity ? new Date(room.last_activity * 1000) : new Date(),
                            codeLines: room.codeLength ? Math.max(1, Math.ceil(room.codeLength / 50)) : 0,
                            isActive: room.isActive || false
                        });
                        
                        // æ·»åŠ æˆ¿é–“ä¸­çš„å­¸ç”Ÿ
                        if (room.users && Array.isArray(room.users)) {
                            room.users.forEach(user => {
                                const studentId = user.user_id || user.id || user.name;
                                const studentName = user.user_name || user.name || studentId;
                                students.set(studentId, {
                                    id: studentId,
                                    name: studentName,
                                    roomId: room.id,
                                    online: true,
                                    lastActivity: user.last_active ? new Date(user.last_active) : new Date(),
                                    code: room.current_code || '',
                                    codeLines: room.current_code ? room.current_code.split('\n').length : 0
                                });
                            });
                        }
                    });
                }
                
                // æ›´æ–°UI
                updateRoomList();
                updateStudentList();
                updateChatRoomSelector(); // æ›´æ–°èŠå¤©æˆ¿é–“é¸æ“‡å™¨
                updateBroadcastTargets(); // æ›´æ–°å»£æ’­ç›®æ¨™é¸æ“‡å™¨
                updateTeacherRoomSelector(); // æ›´æ–°æ•™å¸«æˆ¿é–“é¸æ“‡å™¨
                
                // å¦‚æœæœ‰é¸ä¸­çš„æˆ¿é–“ï¼Œè¼‰å…¥æˆ¿é–“è©³ç´°ä¿¡æ¯
                if (currentRoom && rooms.has(currentRoom)) {
                    loadRoomDetails(currentRoom);
                }
                
                addLog(`ğŸ“‚ è¼‰å…¥äº† ${data.rooms ? data.rooms.length : 0} å€‹æˆ¿é–“ï¼Œ${data.totalUsers || 0} ååœ¨ç·šå­¸ç”Ÿ`);
                
            } catch (error) {
                console.error('âŒ è¼‰å…¥æˆ¿é–“æ•¸æ“šå¤±æ•—:', error);
                addLog(`âŒ è¼‰å…¥æˆ¿é–“æ•¸æ“šå¤±æ•—: ${error.message}`);
            }
        }
        
        // è¼‰å…¥æˆ¿é–“è©³ç´°ä¿¡æ¯
        async function loadRoomDetails(roomId) {
            try {
                const response = await fetch(`/api/teacher.php?action=room&id=${encodeURIComponent(roomId)}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const roomData = await response.json();
                console.log(`ğŸ“‹ è¼‰å…¥æˆ¿é–“ ${roomId} è©³ç´°ä¿¡æ¯:`, roomData);
                
                // æ›´æ–°æˆ¿é–“ä»£ç¢¼
                if (roomData.code !== undefined) {
                    updateCodeEditor(roomData.code);
                    updateCodeStats(roomData.code);
                    
                    // æ›´æ–°æˆ¿é–“ä¿¡æ¯
                    if (rooms.has(roomId)) {
                        const room = rooms.get(roomId);
                        room.code = roomData.code;
                        room.version = roomData.version || 1;
                        room.codeLines = roomData.code ? roomData.code.split('\n').length : 0;
                        rooms.set(roomId, room);
                    }
                    
                    addLog(`ğŸ“ è¼‰å…¥æˆ¿é–“ ${roomId} ä»£ç¢¼: ${roomData.code.split('\n').length} è¡Œ`);
                }
                
                // æ›´æ–°å­¸ç”Ÿä»£ç¢¼ä¿¡æ¯
                if (roomData.users && Array.isArray(roomData.users)) {
                    roomData.users.forEach(user => {
                        const studentId = user.user_id || user.id || user.name;
                        if (students.has(studentId)) {
                            const student = students.get(studentId);
                            student.code = roomData.code || '';
                            student.codeLines = roomData.code ? roomData.code.split('\n').length : 0;
                            students.set(studentId, student);
                        }
                    });
                }
                
            } catch (error) {
                console.error(`âŒ è¼‰å…¥æˆ¿é–“ ${roomId} è©³ç´°ä¿¡æ¯å¤±æ•—:`, error);
                addLog(`âŒ è¼‰å…¥æˆ¿é–“è©³ç´°ä¿¡æ¯å¤±æ•—: ${error.message}`);
            }
        }

        // æˆ¿é–“åˆ‡æ›åŠŸèƒ½
        function switchMonitorRoom() {
            const roomSelect = document.getElementById('teacherRoomSelect');
            const selectedRoom = roomSelect.value;
            
            if (!selectedRoom) {
                addLog('è«‹é¸æ“‡è¦ç›£æ§çš„æˆ¿é–“');
                return;
            }
            
            if (selectedRoom === 'all') {
                // ç›£æ§æ‰€æœ‰æˆ¿é–“
                currentRoom = null;
                currentStudent = null;
                
                // æ¸…ç©ºç•¶å‰ä»£ç¢¼ç·¨è¼¯å™¨
                if (codeEditor) {
                    codeEditor.setValue('// ç›£æ§æ‰€æœ‰æˆ¿é–“æ¨¡å¼\n// åœ¨å·¦å´é¸æ“‡å…·é«”å­¸ç”ŸæŸ¥çœ‹ä»£ç¢¼');
                }
                
                // æ›´æ–°æ¨™é¡Œ
                document.getElementById('currentStudentName').textContent = 'ç›£æ§æ‰€æœ‰æˆ¿é–“';
                
                // è¼‰å…¥æ‰€æœ‰æˆ¿é–“æ•¸æ“š
                loadRoomsData();
                
                addLog(`ğŸ‘€ åˆ‡æ›åˆ°ç›£æ§æ‰€æœ‰æˆ¿é–“æ¨¡å¼`);
            } else {
                // ç›£æ§ç‰¹å®šæˆ¿é–“
                currentRoom = selectedRoom;
                currentStudent = null;
                
                // æ›´æ–°æ¨™é¡Œ
                document.getElementById('currentStudentName').textContent = `æˆ¿é–“: ${selectedRoom}`;
                
                // è¼‰å…¥æˆ¿é–“è©³ç´°ä¿¡æ¯
                loadRoomDetails(selectedRoom);
                
                // ç™¼é€æˆ¿é–“ç›£æ§è«‹æ±‚
                sendMessage({
                    type: 'monitor_room',
                    data: { roomId: selectedRoom }
                });
                
                addLog(`ğŸ  åˆ‡æ›ç›£æ§æˆ¿é–“åˆ°: ${selectedRoom}`);
            }
            
            // æ›´æ–°å­¸ç”Ÿåˆ—è¡¨å’Œæˆ¿é–“åˆ—è¡¨
            updateStudentList();
            updateRoomList();
        }

        // æ›´æ–°èŠå¤©æˆ¿é–“é¸æ“‡å™¨
        function updateChatRoomSelector() {
            const chatRoomSelect = document.getElementById('chatTargetRoom');
            if (!chatRoomSelect) return;
            
            // æ¸…ç©ºç¾æœ‰é¸é …
            chatRoomSelect.innerHTML = '<option value="">é¸æ“‡ç›®æ¨™æˆ¿é–“</option><option value="all">ğŸ“¢ æ‰€æœ‰æˆ¿é–“</option>';
            
            // æ·»åŠ æ´»èºæˆ¿é–“
            rooms.forEach((room, roomId) => {
                const option = document.createElement('option');
                option.value = roomId;
                option.textContent = `${roomId} (${room.userCount}äºº)`;
                chatRoomSelect.appendChild(option);
            });
        }

        // æ›´æ–°å»£æ’­ç›®æ¨™é¸æ“‡å™¨
        function updateBroadcastTargets() {
            const select = document.getElementById('broadcastTarget');
            if (!select) {
                console.warn('âŒ æ‰¾ä¸åˆ°å»£æ’­ç›®æ¨™é¸æ“‡å™¨å…ƒç´ ');
                return;
            }
            
            select.innerHTML = '<option value="all">ğŸ“¢ æ‰€æœ‰æˆ¿é–“</option>';
            
            let roomCount = 0;
            rooms.forEach((room, roomId) => {
                const option = document.createElement('option');
                option.value = roomId;
                option.textContent = `ğŸ  ${roomId} (${room.userCount} äºº)`;
                select.appendChild(option);
                roomCount++;
            });
            
            // å¦‚æœæœ‰ç•¶å‰é¸ä¸­çš„æˆ¿é–“ï¼Œè¨­ç‚ºé è¨­å€¼
            if (currentRoom && rooms.has(currentRoom)) {
                select.value = currentRoom;
            }
            
            console.log(`âœ… å»£æ’­ç›®æ¨™é¸æ“‡å™¨å·²æ›´æ–°ï¼Œæ·»åŠ äº† ${roomCount} å€‹æˆ¿é–“`);
        }

        // æ›´æ–°æ•™å¸«æˆ¿é–“é¸æ“‡å™¨
        function updateTeacherRoomSelector() {
            const roomSelect = document.getElementById('teacherRoomSelect');
            if (!roomSelect) return;
            
            // ä¿å­˜ç•¶å‰é¸ä¸­å€¼
            const currentValue = roomSelect.value;
            
            // æ¸…ç©ºç¾æœ‰é¸é …ï¼ˆä¿ç•™é è¨­é¸é …ï¼‰
            roomSelect.innerHTML = `
                <option value="">é¸æ“‡ç›£æ§æˆ¿é–“</option>
                <option value="all">ğŸ‘€ ç›£æ§æ‰€æœ‰æˆ¿é–“</option>
            `;
            
            // æ·»åŠ æ´»èºæˆ¿é–“
            let roomCount = 0;
            rooms.forEach((room, roomId) => {
                const option = document.createElement('option');
                option.value = roomId;
                option.textContent = `ğŸ  ${roomId} (${room.userCount} äºº)`;
                roomSelect.appendChild(option);
                roomCount++;
            });
            
            // æ¢å¾©é¸ä¸­å€¼
            if (currentValue && [...roomSelect.options].some(opt => opt.value === currentValue)) {
                roomSelect.value = currentValue;
            }
            
            console.log(`âœ… æ•™å¸«æˆ¿é–“é¸æ“‡å™¨å·²æ›´æ–°ï¼Œæ·»åŠ äº† ${roomCount} å€‹æˆ¿é–“`);
        }

        // åˆå§‹åŒ–é€£æ¥
        connectHTTPPolling();
    </script>
</body>
</html> 