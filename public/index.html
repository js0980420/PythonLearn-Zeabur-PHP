<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python多人協作教學平台</title>
    
    <!-- 🌐 環境自動檢測配置 -->
    <script>
    (function() {
        const hostname = window.location.hostname;
        
        console.log('🔍 檢測當前環境:', hostname);
        
        // 環境檢測（WebSocket URL 由 websocket.js 自行決定）
        if (hostname === 'localhost' || hostname === '127.0.0.1') {
            console.log('🏠 本地開發環境檢測');
        } else if (hostname.includes('zeabur.app') || hostname.includes('python-learn')) {
            console.log('☁️ Zeabur 雲端環境檢測');
        } else {
            console.log('🌐 自定義域名環境檢測');
        }
        
        // 設置環境標識
        window.ENVIRONMENT = {
            isLocal: hostname === 'localhost' || hostname === '127.0.0.1',
            isZeabur: hostname.includes('zeabur.app'),
            hostname: hostname,
            protocol: window.location.protocol
        };
        
        console.log('🔧 環境配置完成:', window.ENVIRONMENT);
    })();
    </script>
    
    <!-- 避免 favicon 404 錯誤 -->
    <link rel="icon" href="data:,">
    
    <!-- 外部CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" rel="stylesheet">
    
    <!-- 本地自定義CSS - 多路徑備援 -->
    <link href="css/styles.css" rel="stylesheet" id="primaryCSS">
    <script>
    // CSS 載入失敗時的備援機制
    document.getElementById('primaryCSS').onerror = function() {
        console.warn('主要CSS載入失敗，嘗試備用路徑...');
        const fallbackCSS = document.createElement('link');
        fallbackCSS.rel = 'stylesheet';
        fallbackCSS.href = '/public/css/styles.css';
        document.head.appendChild(fallbackCSS);
    };
    </script>

    
    <!-- 內嵌基本樣式 (確保即使外部CSS加載失敗或被移除，也有基本框架) -->
    <style>
        /* Python協作教學平台 - 完整內嵌樣式 */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .card-custom {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* 協作提醒樣式 */
        .collaboration-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            max-width: 400px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            animation: slideInRight 0.5s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* 衝突檢測模態窗口 */
        .conflict-modal .modal-content {
            border-radius: 15px;
            border: 3px solid #dc3545;
        }

        .conflict-header {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .conflict-option {
            transition: all 0.3s ease;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .conflict-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .option-reload {
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
        }

        .option-force {
            background: linear-gradient(45deg, #ffc107, #e0a800);
            color: black;
        }

        .option-discuss {
            background: linear-gradient(45deg, #28a745, #1e7e34);
            color: white;
        }

        /* 編輯器衝突警告 */
        .editor-conflict-warning {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: #dc3545;
            color: white;
            padding: 10px;
            text-align: center;
            z-index: 1000;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* 在線用戶指示器 */
        .user-indicator {
            display: inline-block;
            padding: 4px 12px;
            background: #28a745;
            color: white;
            border-radius: 15px;
            font-size: 12px;
            margin: 2px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .system-message {
            background: #e9ecef;
            border-left-color: #6c757d;
            font-style: italic;
        }

        .conflict-code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            border-left: 4px solid #dc3545;
        }

        /* AI助教樣式 */
        .ai-analysis {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }

        .ai-suggestion {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }

        /* 🔧 編輯器專用樣式 - 確保編輯器有足夠大小 */
        #editor {
            width: 100%;
            height: 400px;
            min-height: 400px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: #2d3748;
            color: #e2e8f0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        /* CodeMirror 編輯器樣式 */
        .CodeMirror {
            height: 400px !important;
            min-height: 400px !important;
            width: 100% !important;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            background: #2d3748 !important;
        }

        .CodeMirror-scroll {
            height: 400px !important;
            min-height: 400px !important;
        }

        .CodeMirror-lines {
            padding: 10px;
        }

        /* 聊天室樣式 */
        .chat-container {
            height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }

        .chat-message {
            background: rgba(255,255,255,0.9);
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 8px;
            border-left: 3px solid #007bff;
            word-wrap: break-word;
        }

        .chat-message.teacher {
            border-left-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }

        .chat-message-time {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }

        .chat-message-user {
            font-weight: bold;
            color: #333;
        }

        .chat-input-container {
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }

        /* 用戶登入記錄下拉選單樣式 */
        .username-dropdown {
            position: relative;
        }

        .username-history-item .dropdown-item {
            padding: 8px 16px;
            border-radius: 6px;
            margin: 2px 0;
            transition: all 0.2s ease;
        }

        .username-history-item .dropdown-item:hover {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            transform: translateX(3px);
        }

        .username-history-item .dropdown-item small {
            opacity: 0.8;
            font-size: 10px;
        }

        .username-history-item .dropdown-item:hover small {
            color: rgba(255, 255, 255, 0.9);
        }

        /* 時間標記樣式 */
        .username-time-badge {
            background: rgba(0, 123, 255, 0.1);
            color: #007bff;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 500;
        }

        /* 清除記錄按鈕樣式 */
        .username-history-item .text-danger {
            transition: all 0.3s ease;
        }

        .username-history-item .text-danger:hover {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            transform: scale(1.02);
        }

        /* 下拉選單動畫 */
        #usernameDropdown {
            animation: fadeInDown 0.3s ease;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 運行結果樣式 */
        #runResult {
            max-height: 200px;
            min-height: 150px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: #212529;
            color: #ffffff;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        /* 確保容器有足夠的空間 */
        .col-md-8 {
            min-height: 600px;
        }

        .col-md-4 {
            min-height: 600px;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            #editor, .CodeMirror {
                height: 300px !important;
                min-height: 300px !important;
            }
            
            #chatMessages {
                max-height: 200px;
                min-height: 150px;
            }
            
            #runResult {
                max-height: 150px;
                min-height: 100px;
            }
        }

        /* AI回應卡片樣式 */
        .ai-response-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px;
            margin: 15px 0;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
            overflow: hidden;
        }

        .ai-response-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .ai-response-content {
            padding: 20px;
        }

        .ai-response-content h6 {
            color: #ffffff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-response-content h7 {
            color: #f8f9fa;
            font-weight: 600;
        }

        .ai-response-content .alert {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 8px;
        }

        .ai-response-content .card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .ai-response-content .card-body {
            color: white;
        }

        .ai-response-content ul {
            color: #f8f9fa;
        }

        .ai-response-content li {
            margin-bottom: 8px;
        }

        .ai-conflict-analysis {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 5px solid #a93226;
        }

        .ai-conflict-analysis .alert {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }

        /* Toast 樣式 */
        .success-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1060;
            animation: slideInDown 0.3s ease-out;
        }

        @keyframes slideInDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .error-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1060;
            animation: slideInDown 0.3s ease-out;
        }

        .info-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1060;
            animation: slideInDown 0.3s ease-out;
        }

        /* 教師廣播樣式 */
        .teacher-broadcast {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            padding: 20px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 2000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: zoomIn 0.5s ease-out;
        }

        @keyframes zoomIn {
            from { transform: scale(0.3); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .broadcast-info { background: #d1ecf1; border: 2px solid #bee5eb; color: #0c5460; }
        .broadcast-warning { background: #fff3cd; border: 2px solid #ffeaa7; color: #856404; }
        .broadcast-success { background: #d4edda; border: 2px solid #c3e6cb; color: #155724; }
        .broadcast-error { background: #f8d7da; border: 2px solid #f5c6cb; color: #721c24; }

        /* 教學內容樣式 */
        .tutorial-content {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
        }

        .tutorial-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #17a2b8;
        }

        .tutorial-section h6 {
            color: #17a2b8;
            margin-bottom: 8px;
        }

        .tutorial-section p {
            margin-bottom: 5px;
            line-height: 1.4;
        }

        .tutorial-section strong {
            color: #ffc107;
        }

        /* 基礎樣式覆蓋 */
        #editorContainer, #chatContainer, #aiResponse, #outputContent { 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            min-height: 100px;
        }
        
        #outputContent { 
            background-color: #f8f9fa; 
            padding: 10px; 
            max-height: 200px; 
            overflow-y: auto; 
            font-family: monospace; 
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="text-center mb-4">
            <h1 class="text-white"><i class="fas fa-code-branch"></i> Python多人協作教學平台</h1>
        </div>

        <div id="loginSection" class="card-custom p-4 mb-4">
            <h3 class="text-center mb-4"><i class="fas fa-users"></i> 加入協作房間</h3>
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">房間名稱</label>
                        <div class="input-group">
                            <select class="form-select" id="roomSelect" onchange="updateRoomInput()">
                                <option value="general-room">general-room (預設房間)</option>
                                <option value="custom">自定義房間名稱...</option>
                            </select>
                        </div>
                        <input type="text" class="form-control mt-2" id="roomInput" placeholder="或輸入自定義房間名稱" value="general-room" style="display: none;">
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i> 
                            選擇預設房間或輸入自定義房間名稱
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">您的名稱</label>
                        <div class="dropdown">
                            <input type="text" class="form-control dropdown-toggle" id="username" 
                                   placeholder="請輸入您的用戶名稱" value="" required
                                   data-bs-toggle="dropdown" aria-expanded="false"
                                   autocomplete="off">
                            <ul class="dropdown-menu w-100" id="usernameDropdown">
                                <li><h6 class="dropdown-header">最近登入的用戶</h6></li>
                                <li><hr class="dropdown-divider"></li>
                                <li class="text-center text-muted py-2" id="noUsersMessage">
                                    <i class="fas fa-info-circle"></i> 暫無登入記錄
                                </li>
                            </ul>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i> 
                            輸入新名稱或從下拉選單選擇之前用過的名稱
                        </div>
                    </div>
                    <button class="btn btn-primary w-100 mb-3" onclick="globalJoinRoom()"><i class="fas fa-sign-in-alt"></i> 加入房間</button>
                    <div class="text-center">
                        <hr class="my-3">
                        <p class="text-muted mb-2">教師專用</p>
                        <button class="btn btn-outline-warning" onclick="globalOpenTeacherDashboard()"><i class="fas fa-chalkboard-teacher"></i> 教師監控後台</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="workspaceSection" style="display: none;">
            <div class="card-custom p-3 mb-4">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <h5 class="mb-0"><i class="fas fa-home"></i> 房間: <span id="currentRoom">-</span></h5>
                    </div>
                    <div class="col-md-3">
                        <h6 class="mb-0 text-info"><i class="fas fa-user"></i> 我是: <span id="currentUserName">-</span></h6>
                    </div>
                    <div class="col-md-3">
                        <div id="onlineUsers"><strong>在線用戶:</strong></div>
                    </div>
                    <div class="col-md-3 text-end">
                        <span class="badge bg-success" id="connectionStatus">連接中...</span>
                        <button class="btn btn-outline-danger btn-sm ms-2" onclick="globalLeaveRoom()">離開房間</button>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="card-custom p-4" id="editorCard">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5><i class="fas fa-code"></i> 協作編輯器</h5>
                            <div>
                                <!-- 第一組：保存、載入、運行 -->
                                <div class="btn-group me-2" role="group">
                                    <!-- 保存按鈕組 -->
                                    <button class="btn btn-outline-primary btn-sm" onclick="globalSaveCode(true)">
                                        <i class="fas fa-save"></i> 保存
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm dropdown-toggle dropdown-toggle-split" type="button" data-bs-toggle="dropdown" id="saveDropdownBtn">
                                        <span class="visually-hidden">Toggle Dropdown</span>
                                    </button>
                                    <ul class="dropdown-menu" id="saveCodeOptions">
                                        <li><h6 class="dropdown-header">保存選項</h6></li>
                                        <li><a class="dropdown-item" href="#" onclick="globalSaveCode(true)">
                                            <i class="fas fa-save text-primary"></i> 保存到最新
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><h6 class="dropdown-header">保存槽位</h6></li>
                                        <!-- 槽位項目將由 SaveLoadManager 動態生成 -->
                                    </ul>
                                    
                                    <!-- 載入按鈕組 -->
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="globalLoadCode('latest')">
                                        <i class="fas fa-sync-alt"></i> 載入
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle dropdown-toggle-split" type="button" data-bs-toggle="dropdown" id="loadDropdownBtn">
                                        <span class="visually-hidden">Toggle Dropdown</span>
                                    </button>
                                    <ul class="dropdown-menu" id="loadCodeOptions">
                                        <li><h6 class="dropdown-header">載入選項</h6></li>
                                        <li><a class="dropdown-item" href="#" onclick="globalLoadCode('latest')">
                                            <i class="fas fa-sync-alt text-success"></i> 載入最新
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><h6 class="dropdown-header">已保存版本</h6></li>
                                        <!-- 已保存的槽位項目將由 SaveLoadManager 動態生成 -->
                                    </ul>
                                </div>
                                
                                <!-- 第二組：複製 -->
                                <div class="btn-group me-2" role="group">
                                    <button class="btn btn-primary btn-sm" onclick="globalCopyCode()">
                                        <i class="fas fa-copy"></i> 複製
                                    </button>
                                </div>
                                
                                <!-- 第三組：更多(下載、導入) -->
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-info btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" id="moreOptionsBtn">
                                        <i class="fas fa-ellipsis-h"></i> 更多
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><h6 class="dropdown-header">檔案操作</h6></li>
                                        <li><a class="dropdown-item" href="#" onclick="globalDownloadCode()">
                                            <i class="fas fa-download text-primary"></i> 下載 .py 檔案
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="globalImportCode()">
                                            <i class="fas fa-upload text-success"></i> 導入檔案
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div id="editorContainer">
                            <textarea id="codeEditor"></textarea>
                            <input type="file" id="file-import" accept=".py,.txt" style="display: none;" onchange="globalHandleFileImport(event)">
                        </div>
                        <div id="codeOutput" class="mt-3" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6><i class="fas fa-terminal"></i> 運行結果</h6>
                                <button class="btn btn-outline-secondary btn-sm" onclick="globalClearOutput()"><i class="fas fa-times"></i> 清除</button>
                            </div>
                            <div id="outputContent"></div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card-custom p-3" id="rightPanel">
                        <!-- 切換按鈕 -->
                        <div class="d-flex justify-content-center mb-3">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-primary" id="aiTabBtn" onclick="globalSwitchToAI()">
                                    <i class="fas fa-robot"></i> AI助教
                                </button>
                                <button type="button" class="btn btn-outline-success" id="chatTabBtn" onclick="globalSwitchToChat()">
                                    <i class="fas fa-comments"></i> 聊天室
                                </button>
                            </div>
                        </div>
                        
                        <!-- AI助教區域 -->
                        <div id="aiSection">
                            <div class="d-grid gap-2 mb-3">
                                <button class="btn btn-outline-info" onclick="globalAskAI('analyze')"><i class="fas fa-lightbulb"></i> 解釋程式</button>
                                <button class="btn btn-outline-warning" onclick="globalAskAI('check_errors')"><i class="fas fa-bug"></i> 檢查錯誤</button>
                                <button class="btn btn-outline-success" onclick="globalAskAI('improvement_tips')"><i class="fas fa-lightbulb"></i> 改進建議</button>
                                <button class="btn btn-outline-danger" onclick="globalTestConflictAnalysis()"><i class="fas fa-code-branch"></i> 衝突分析</button>
                                <button class="btn btn-outline-primary" onclick="globalRunWithAI()"><i class="fas fa-play-circle"></i> AI運行代碼</button>
                            </div>
                            <div id="aiResponse" class="p-2" style="min-height: 350px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;"></div>
                            <div id="aiShareOptions" class="mt-2" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">分享到聊天室?</small>
                                    <div>
                                        <button class="btn btn-success btn-sm" onclick="globalShareAIResponse()"><i class="fas fa-share"></i> 分享</button>
                                        <button class="btn btn-secondary btn-sm" onclick="globalHideAIShareOptions()"><i class="fas fa-times"></i> 取消</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 聊天室區域 -->
                        <div id="chatSection" style="display: none;">
                            <div id="chatContainer" class="p-2 mb-2" style="height: 400px; overflow-y: auto; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;">
                                <div class="text-center text-muted small">
                                    <i class="fas fa-comments"></i><br>
                                    歡迎使用聊天室
                                </div>
                            </div>
                            <div class="input-group">
                                <input type="text" class="form-control" id="chatInput" placeholder="輸入消息..." onkeypress="if(event.key==='Enter')globalSendChat()">
                                <button class="btn btn-primary" onclick="globalSendChat()"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 協作提醒 -->
        <div id="collaborationAlert" style="display: none; position: fixed; top: 20px; right: 20px; background-color: #fff3cd; color: #664d03; padding: 15px; border-radius: 5px; border: 1px solid #ffeeba; z-index: 1050;">
            <div class="d-flex align-items-center"><i class="fas fa-exclamation-triangle text-warning me-2"></i><div><strong>⚠️ 其他同學也在修改程式碼！</strong><div id="collaboratingUsers" class="mt-1"></div></div></div>
        </div>

        <!-- 🔧 環境檢測面板 -->
        <div id="envCheckPanel" style="display: none; position: fixed; bottom: 20px; right: 20px; background: white; border: 2px solid #007bff; border-radius: 8px; padding: 15px; z-index: 1060; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 400px;">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0"><i class="fas fa-cog"></i> 環境變數檢測</h6>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleEnvPanel()"><i class="fas fa-times"></i></button>
            </div>
            <div id="envCheckContent">
                <div class="text-center"><i class="fas fa-spinner fa-spin"></i> 檢測中...</div>
            </div>
        </div>

        <!-- 🔧 環境檢測按鈕 -->
        <button id="envCheckBtn" onclick="toggleEnvPanel()" style="position: fixed; bottom: 20px; left: 20px; background: #007bff; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; z-index: 1059; box-shadow: 0 2px 8px rgba(0,0,0,0.2);" title="檢查環境變數">
            <i class="fas fa-cog"></i>
        </button>

        <!-- 衝突解決模態窗口 -->
        <div class="modal fade" id="conflictModal" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> 協作衝突</h5>
                    </div>
                    <div class="modal-body">
                        <p>檢測到協作衝突！<span id="conflictUserName">其他同學</span>也在同時修改程式碼，請查看差異後選擇解決方案：</p>
                        
                        <!-- 🔧 新增：代碼差異對比區域 -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-code-branch"></i> 代碼差異對比</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="row g-0">
                                    <div class="col-md-6">
                                        <div class="bg-info bg-opacity-10 p-2 border-end">
                                            <h6 class="text-info mb-2"><i class="fas fa-user"></i> 您的版本</h6>
                                            <pre id="myCodeVersion" class="bg-white p-2 rounded border" style="max-height: 200px; overflow-y: auto; font-size: 0.9em; white-space: pre-wrap;"></pre>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="bg-warning bg-opacity-10 p-2">
                                            <h6 class="text-warning mb-2"><i class="fas fa-users"></i> <span id="otherUserName">對方</span>的版本</h6>
                                            <pre id="otherCodeVersion" class="bg-white p-2 rounded border" style="max-height: 200px; overflow-y: auto; font-size: 0.9em; white-space: pre-wrap;"></pre>
                                        </div>
                                    </div>
                                </div>
                                <!-- 差異摘要 -->
                                <div class="bg-light p-2 border-top">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle"></i> 
                                        <span id="diffSummary">正在分析差異...</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 解決方案按鈕 -->
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-outline-success w-100" onclick="globalResolveConflict('accept')">
                                    <i class="fas fa-check"></i> 接受對方修改
                                </button>
                            </div>
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-outline-warning w-100" onclick="globalResolveConflict('reject')">
                                    <i class="fas fa-times"></i> 保持我的版本
                                </button>
                            </div>
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-outline-info w-100" onclick="globalShareConflictToChat()">
                                    <i class="fas fa-comments"></i> 複製到聊天室討論
                                </button>
                            </div>
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-outline-primary w-100" onclick="globalAskAIForConflictHelp()">
                                    <i class="fas fa-robot"></i> 請 AI 協助分析
                                </button>
                            </div>
                        </div>
                        
                        <div id="conflictVersionInfo" class="text-muted small mb-2"></div>
                        <!-- AI分析結果區域 -->
                        <div id="conflictAIAnalysis" class="mt-3 p-3 rounded" style="background:#f8f9fa; display: none;">
                            <h6 class="text-primary"><i class="fas fa-robot"></i> AI協作衝突分析</h6>
                            <div id="aiAnalysisContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- main-container end -->

    <script>
    // 🔧 動態路徑修復 - Zeabur 環境專用路徑檢測
    (function() {
        const currentPath = window.location.pathname;
        const hostname = window.location.hostname;
        const isZeabur = hostname.includes('zeabur.app');
        const isInPublicPath = currentPath.includes('/public/');
        
        console.log('🔍 當前路徑:', currentPath);
        console.log('🔍 是否 Zeabur 環境:', isZeabur);
        console.log('🔍 是否在 public 路徑:', isInPublicPath);
        
        // 🎯 Zeabur 環境路徑修復
        let jsBasePath = '';
        
        // 🔧 修復的JS檔案路徑邏輯 - 統一使用相對路徑
        if (isZeabur) {
            // Zeabur環境：由於 root: "public" 在 zeabur.yaml 中，直接使用相對路徑
            jsBasePath = '';
            console.log('☁️ Zeabur環境：使用相對路徑載入JS文件');
        } else {
            // 本地環境：PHP服務器 -t public 已經將 public/ 設為根目錄
            jsBasePath = '';
            console.log('🏠 本地環境：PHP服務器根目錄為public/，使用相對路徑');
        }
        
        // 🎨 CSS檔案路徑修復 - 對於Zeabur環境使用相對路徑
        const existingStylesLink = document.querySelector('link[href*="styles.css"]');
        if (existingStylesLink && isZeabur) {
            // Zeabur環境：嘗試正確的相對路徑到 public/css/
            existingStylesLink.href = 'css/styles.css';
            console.log('🎨 CSS路徑已更新為相對路徑: css/styles.css');
        }
        
        console.log('🔧 JS 基礎路徑:', jsBasePath);
        console.log('🔍 路徑條件檢查:', { isZeabur, isInPublicPath, currentPath, hostname });
        
        // 🎯 Zeabur環境調試路徑資訊
        console.log('🌐 完整URL信息:', {
            origin: window.location.origin,
            pathname: window.location.pathname,
            hostname: window.location.hostname,
            href: window.location.href
        });
        
        // 定義需要載入的 JS 文件（按依賴順序）- 純 HTTP 輪詢架構
        const jsFiles = [
            'js/user-manager.js',     // 用戶管理器（最高優先級）
            'js/http-polling.js',     // HTTP 輪詢管理器（替代 WebSocket）
            'js/save-load.js', 
            'js/ui.js?v=20250128-3',  // 強制更新緩存
            'js/editor.js',
            'js/chat.js',
            'js/ai-assistant.js',
            'js/conflict.js?v=20250128-3'  // 衝突解決器也需要更新
        ];
        
        let loadedCount = 0;
        let totalFiles = jsFiles.length;
        
        // 🚀 串行載入 JS 文件以保持依賴關係
        function loadNextScript(index) {
            if (index >= jsFiles.length) {
                console.log('🎉 所有 JS 文件載入完成');
                return;
            }
            
            const file = jsFiles[index];
            const script = document.createElement('script');
            script.src = jsBasePath + file;
            script.async = false;
            
            script.onload = function() {
                loadedCount++;
                console.log(`✅ 成功載入 (${loadedCount}/${totalFiles}):`, file);
                // 載入下一個文件
                loadNextScript(index + 1);
            };
            
            script.onerror = function() {
                console.error('❌ 載入失敗:', file);
                
                // 🔄 備用路徑策略 - 統一使用相對路徑
                const fallbackPaths = [
                    './',               // 當前目錄（相對路徑）
                    '/',                // 根目錄
                    '../'               // 上級目錄（備用）
                ];
                
                let fallbackIndex = 0;
                function tryFallback() {
                    if (fallbackIndex >= fallbackPaths.length) {
                        console.error('❌ 所有備用路徑都失敗:', file);
                        // 繼續載入下一個文件
                        loadNextScript(index + 1);
                        return;
                    }
                    
                    const fallbackPath = fallbackPaths[fallbackIndex];
                    const fallbackScript = document.createElement('script');
                    fallbackScript.src = fallbackPath + file.split('?')[0]; // 移除版本參數
                    
                    fallbackScript.onload = () => {
                        loadedCount++;
                        console.log(`✅ 備用路徑成功 (${loadedCount}/${totalFiles}):`, fallbackPath + file);
                        loadNextScript(index + 1);
                    };
                    
                    fallbackScript.onerror = () => {
                        console.warn(`⚠️ 備用路徑失敗: ${fallbackPath}${file}`);
                        fallbackIndex++;
                        tryFallback();
                    };
                    
                    document.head.appendChild(fallbackScript);
                }
                
                tryFallback();
            };
            
            document.head.appendChild(script);
        }
        
        // 開始載入第一個腳本
        loadNextScript(0);
        
        // 🔥 添加頁面卸載處理 - 確保用戶正確退出房間
        window.addEventListener('beforeunload', (event) => {
            console.log('🔌 頁面即將卸載，正在離開房間...');
            
            // 🔥 強制發送離開請求，不管連接狀態如何
            try {
                let roomId = 'general-room';
                let userId = '';
                
                // 嘗試獲取當前房間和用戶信息
                if (window.wsManager) {
                    roomId = window.wsManager.currentRoom || 'general-room';
                    userId = window.wsManager.currentUser || '';
                    
                    // 立即標記為離線狀態
                    window.wsManager.isConnectedState = false;
                    
                    // 停止輪詢
                    if (window.wsManager.stopPolling) {
                        window.wsManager.stopPolling();
                    }
                }
                
                // 如果沒有用戶ID，嘗試從其他地方獲取
                if (!userId && window.UserManager && window.UserManager.getCurrentUser) {
                    const currentUser = window.UserManager.getCurrentUser();
                    userId = currentUser ? currentUser.id : '';
                }
                
                console.log('🔌 離開房間信息:', { roomId, userId });
                
                // 🔥 使用 sendBeacon 發送離開請求（最可靠的方法）
                if (userId) {
                    const formData = new FormData();
                    formData.append('action', 'leave');
                    formData.append('room_id', roomId);
                    formData.append('user_id', userId);
                    
                    const success = navigator.sendBeacon('/api.php', formData);
                    console.log(success ? '✅ sendBeacon 離開請求已發送' : '⚠️ sendBeacon 可能失敗');
                    
                    // 🔥 備用方案：同步XHR（確保發送）
                    if (!success) {
                        try {
                            const xhr = new XMLHttpRequest();
                            xhr.open('POST', '/api.php', false); // 同步請求
                            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                            xhr.send(`action=leave&room_id=${encodeURIComponent(roomId)}&user_id=${encodeURIComponent(userId)}`);
                            console.log('✅ 備用 XHR 離開請求已發送');
                        } catch (xhrError) {
                            console.warn('⚠️ 備用 XHR 也失敗了:', xhrError);
                        }
                    }
                } else {
                    console.warn('⚠️ 無法獲取用戶ID，跳過離開請求');
                }
                
            } catch (error) {
                console.error('❌ 頁面卸載時離開房間失敗:', error);
            }
            
            // 清理用戶管理器
            if (window.UserManager && window.UserManager.cleanup) {
                window.UserManager.cleanup();
            }
        });
        
        // 🔥 添加頁面隱藏處理 - 處理移動設備或瀏覽器標籤切換
        let pageHiddenStartTime = 0;
        
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                pageHiddenStartTime = Date.now();
                console.log('📱 頁面已隱藏，開始計時...');
                
                // 🔥 設置延遲離開機制（5秒後如果還是隱藏就離開房間）
                setTimeout(() => {
                    if (document.visibilityState === 'hidden' && window.wsManager && window.wsManager.isConnected && window.wsManager.isConnected()) {
                        console.log('⏰ 頁面隱藏超過5秒，主動離開房間');
                        
                        // 發送離開請求
                        const formData = new FormData();
                        formData.append('action', 'leave');
                        formData.append('room_id', window.wsManager.currentRoom || 'general-room');
                        formData.append('user_id', window.wsManager.currentUser || '');
                        
                        navigator.sendBeacon('/api.php', formData);
                        
                        // 停止輪詢
                        if (window.wsManager.stopPolling) {
                            window.wsManager.stopPolling();
                        }
                        
                        window.wsManager.isConnectedState = false;
                    }
                }, 5000); // 5秒延遲
                
            } else if (document.visibilityState === 'visible') {
                const hiddenDuration = pageHiddenStartTime > 0 ? Date.now() - pageHiddenStartTime : 0;
                console.log(`👀 頁面重新可見，隱藏了 ${hiddenDuration}ms`);
                
                // 🔥 如果隱藏時間超過10秒，視為重新連接
                if (hiddenDuration > 10000) {
                    console.log('🔄 長時間隱藏後重新可見，重新初始化連接...');
                    
                    if (window.wsManager && !window.wsManager.isConnected()) {
                        // 重新連接邏輯（如果需要）
                        console.log('💭 考慮重新連接到房間...');
                    }
                }
                
                pageHiddenStartTime = 0;
            }
        });
    })();
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>

    <script>
    // 🔧 環境變數檢測功能
    function toggleEnvPanel() {
        const panel = document.getElementById('envCheckPanel');
        const btn = document.getElementById('envCheckBtn');
        
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            btn.style.display = 'none';
            checkEnvironmentVariables();
        } else {
            panel.style.display = 'none';
            btn.style.display = 'block';
        }
    }
    
    async function checkEnvironmentVariables() {
        const content = document.getElementById('envCheckContent');
        
        try {
            // 檢查健康狀態
            const healthResponse = await fetch('/public/health.php');
            const healthData = await healthResponse.json();
            
            // 生成環境報告
            let html = '<div style="font-size: 12px;">';
            
            // 環境狀態
            html += `<div class="mb-2">
                <strong>🌐 環境狀態:</strong><br>
                <span class="badge bg-${healthData.environment === 'zeabur' ? 'success' : 'warning'}">${healthData.environment}</span>
            </div>`;
            
            // 服務狀態
            html += '<div class="mb-2"><strong>🔧 服務狀態:</strong><br>';
            if (healthData.services) {
                Object.entries(healthData.services).forEach(([service, status]) => {
                    const color = status === 'running' ? 'success' : status === 'partial' ? 'warning' : 'danger';
                    html += `<span class="badge bg-${color} me-1">${service}: ${status}</span><br>`;
                });
            }
            html += '</div>';
            
            // 檢查關鍵環境變數（模擬，因為無法從前端直接訪問）
            html += '<div class="mb-2"><strong>📋 推測環境變數:</strong><br>';
            
            // 根據服務狀態推測環境變數
            const pollingStatus = healthData.services?.polling || 'unknown';
            html += `<small>HTTP_POLLING: <span class="badge bg-${pollingStatus === 'enabled' ? 'success' : 'warning'}">${pollingStatus === 'enabled' ? 'enabled' : 'disabled'}</span><br>`;
            html += `NODE_ENV: <span class="badge bg-${healthData.environment === 'zeabur' ? 'success' : 'warning'}">${healthData.server?.environment || 'unknown'}</span><br>`;
            html += `PORT: <span class="badge bg-info">8080 (推測)</span></small>`;
            html += '</div>';
            
            // 性能信息
            if (healthData.performance) {
                html += `<div class="mb-2"><strong>⚡ 性能:</strong><br>
                    <small>內存使用: ${healthData.performance.memory_usage_mb}MB<br>
                    PHP版本: ${healthData.services?.php || 'unknown'}</small>
                </div>`;
            }
            
            // 建議
            html += '<div class="mt-2">';
            if (pollingStatus === 'enabled') {
                html += '<div class="alert alert-success p-2" style="font-size: 11px;">✅ HTTP 輪詢模式已啟用，專為 Zeabur 單端口環境優化</div>';
            } else {
                html += '<div class="alert alert-warning p-2" style="font-size: 11px;">⚠️ HTTP 輪詢未啟用，請檢查系統配置</div>';
            }
            html += '</div>';
            
            html += '</div>';
            content.innerHTML = html;
            
        } catch (error) {
            content.innerHTML = `<div class="alert alert-danger p-2" style="font-size: 11px;">❌ 無法檢測環境狀態: ${error.message}</div>`;
        }
    }
    </script>
</body>
</html> 