<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pythonå¤šäººå”ä½œæ•™å­¸å¹³å°</title>
    
    <!-- ğŸŒ ç’°å¢ƒè‡ªå‹•æª¢æ¸¬é…ç½® -->
    <script>
    (function() {
        const hostname = window.location.hostname;
        
        console.log('ğŸ” æª¢æ¸¬ç•¶å‰ç’°å¢ƒ:', hostname);
        
        // ç’°å¢ƒæª¢æ¸¬ï¼ˆWebSocket URL ç”± websocket.js è‡ªè¡Œæ±ºå®šï¼‰
        if (hostname === 'localhost' || hostname === '127.0.0.1') {
            console.log('ğŸ  æœ¬åœ°é–‹ç™¼ç’°å¢ƒæª¢æ¸¬');
        } else if (hostname.includes('zeabur.app') || hostname.includes('python-learn')) {
            console.log('â˜ï¸ Zeabur é›²ç«¯ç’°å¢ƒæª¢æ¸¬');
        } else {
            console.log('ğŸŒ è‡ªå®šç¾©åŸŸåç’°å¢ƒæª¢æ¸¬');
        }
        
        // è¨­ç½®ç’°å¢ƒæ¨™è­˜
        window.ENVIRONMENT = {
            isLocal: hostname === 'localhost' || hostname === '127.0.0.1',
            isZeabur: hostname.includes('zeabur.app'),
            hostname: hostname,
            protocol: window.location.protocol
        };
        
        console.log('ğŸ”§ ç’°å¢ƒé…ç½®å®Œæˆ:', window.ENVIRONMENT);
    })();
    </script>
    
    <!-- é¿å… favicon 404 éŒ¯èª¤ -->
    <link rel="icon" href="data:,">
    
    <!-- å¤–éƒ¨CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" rel="stylesheet">
    
    <!-- æœ¬åœ°è‡ªå®šç¾©CSS - å¤šè·¯å¾‘å‚™æ´ -->
    <link href="css/styles.css" rel="stylesheet" id="primaryCSS">
    <script>
    // CSS è¼‰å…¥å¤±æ•—æ™‚çš„å‚™æ´æ©Ÿåˆ¶
    document.getElementById('primaryCSS').onerror = function() {
        console.warn('ä¸»è¦CSSè¼‰å…¥å¤±æ•—ï¼Œå˜—è©¦å‚™ç”¨è·¯å¾‘...');
        const fallbackCSS = document.createElement('link');
        fallbackCSS.rel = 'stylesheet';
        fallbackCSS.href = '/public/css/styles.css';
        document.head.appendChild(fallbackCSS);
    };
    </script>

    
    <!-- å…§åµŒåŸºæœ¬æ¨£å¼ (ç¢ºä¿å³ä½¿å¤–éƒ¨CSSåŠ è¼‰å¤±æ•—æˆ–è¢«ç§»é™¤ï¼Œä¹Ÿæœ‰åŸºæœ¬æ¡†æ¶) -->
    <style>
        /* Pythonå”ä½œæ•™å­¸å¹³å° - å®Œæ•´å…§åµŒæ¨£å¼ */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .card-custom {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* å”ä½œæé†’æ¨£å¼ */
        .collaboration-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            max-width: 400px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            animation: slideInRight 0.5s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* è¡çªæª¢æ¸¬æ¨¡æ…‹çª—å£ */
        .conflict-modal .modal-content {
            border-radius: 15px;
            border: 3px solid #dc3545;
        }

        .conflict-header {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .conflict-option {
            transition: all 0.3s ease;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .conflict-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .option-reload {
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
        }

        .option-force {
            background: linear-gradient(45deg, #ffc107, #e0a800);
            color: black;
        }

        .option-discuss {
            background: linear-gradient(45deg, #28a745, #1e7e34);
            color: white;
        }

        /* ç·¨è¼¯å™¨è¡çªè­¦å‘Š */
        .editor-conflict-warning {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: #dc3545;
            color: white;
            padding: 10px;
            text-align: center;
            z-index: 1000;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* åœ¨ç·šç”¨æˆ¶æŒ‡ç¤ºå™¨ */
        .user-indicator {
            display: inline-block;
            padding: 4px 12px;
            background: #28a745;
            color: white;
            border-radius: 15px;
            font-size: 12px;
            margin: 2px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .system-message {
            background: #e9ecef;
            border-left-color: #6c757d;
            font-style: italic;
        }

        .conflict-code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            border-left: 4px solid #dc3545;
        }

        /* AIåŠ©æ•™æ¨£å¼ */
        .ai-analysis {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }

        .ai-suggestion {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }

        /* ğŸ”§ ç·¨è¼¯å™¨å°ˆç”¨æ¨£å¼ - ç¢ºä¿ç·¨è¼¯å™¨æœ‰è¶³å¤ å¤§å° */
        #editor {
            width: 100%;
            height: 400px;
            min-height: 400px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: #2d3748;
            color: #e2e8f0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        /* CodeMirror ç·¨è¼¯å™¨æ¨£å¼ */
        .CodeMirror {
            height: 400px !important;
            min-height: 400px !important;
            width: 100% !important;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            background: #2d3748 !important;
        }

        .CodeMirror-scroll {
            height: 400px !important;
            min-height: 400px !important;
        }

        .CodeMirror-lines {
            padding: 10px;
        }

        /* èŠå¤©å®¤æ¨£å¼ */
        .chat-container {
            height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }

        .chat-message {
            background: rgba(255,255,255,0.9);
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 8px;
            border-left: 3px solid #007bff;
            word-wrap: break-word;
        }

        .chat-message.teacher {
            border-left-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }

        .chat-message-time {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }

        .chat-message-user {
            font-weight: bold;
            color: #333;
        }

        .chat-input-container {
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }

        /* ç”¨æˆ¶ç™»å…¥è¨˜éŒ„ä¸‹æ‹‰é¸å–®æ¨£å¼ */
        .username-dropdown {
            position: relative;
        }

        .username-history-item .dropdown-item {
            padding: 8px 16px;
            border-radius: 6px;
            margin: 2px 0;
            transition: all 0.2s ease;
        }

        .username-history-item .dropdown-item:hover {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            transform: translateX(3px);
        }

        .username-history-item .dropdown-item small {
            opacity: 0.8;
            font-size: 10px;
        }

        .username-history-item .dropdown-item:hover small {
            color: rgba(255, 255, 255, 0.9);
        }

        /* æ™‚é–“æ¨™è¨˜æ¨£å¼ */
        .username-time-badge {
            background: rgba(0, 123, 255, 0.1);
            color: #007bff;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 500;
        }

        /* æ¸…é™¤è¨˜éŒ„æŒ‰éˆ•æ¨£å¼ */
        .username-history-item .text-danger {
            transition: all 0.3s ease;
        }

        .username-history-item .text-danger:hover {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            transform: scale(1.02);
        }

        /* ä¸‹æ‹‰é¸å–®å‹•ç•« */
        #usernameDropdown {
            animation: fadeInDown 0.3s ease;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* é‹è¡Œçµæœæ¨£å¼ */
        #runResult {
            max-height: 200px;
            min-height: 150px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: #212529;
            color: #ffffff;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        /* ç¢ºä¿å®¹å™¨æœ‰è¶³å¤ çš„ç©ºé–“ */
        .col-md-8 {
            min-height: 600px;
        }

        .col-md-4 {
            min-height: 600px;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            #editor, .CodeMirror {
                height: 300px !important;
                min-height: 300px !important;
            }
            
            #chatMessages {
                max-height: 200px;
                min-height: 150px;
            }
            
            #runResult {
                max-height: 150px;
                min-height: 100px;
            }
        }

        /* AIå›æ‡‰å¡ç‰‡æ¨£å¼ */
        .ai-response-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px;
            margin: 15px 0;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
            overflow: hidden;
        }

        .ai-response-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .ai-response-content {
            padding: 20px;
        }

        .ai-response-content h6 {
            color: #ffffff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-response-content h7 {
            color: #f8f9fa;
            font-weight: 600;
        }

        .ai-response-content .alert {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 8px;
        }

        .ai-response-content .card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .ai-response-content .card-body {
            color: white;
        }

        .ai-response-content ul {
            color: #f8f9fa;
        }

        .ai-response-content li {
            margin-bottom: 8px;
        }

        .ai-conflict-analysis {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 5px solid #a93226;
        }

        .ai-conflict-analysis .alert {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }

        /* Toast æ¨£å¼ */
        .success-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1060;
            animation: slideInDown 0.3s ease-out;
        }

        @keyframes slideInDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .error-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1060;
            animation: slideInDown 0.3s ease-out;
        }

        .info-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1060;
            animation: slideInDown 0.3s ease-out;
        }

        /* æ•™å¸«å»£æ’­æ¨£å¼ */
        .teacher-broadcast {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            padding: 20px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 2000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: zoomIn 0.5s ease-out;
        }

        @keyframes zoomIn {
            from { transform: scale(0.3); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .broadcast-info { background: #d1ecf1; border: 2px solid #bee5eb; color: #0c5460; }
        .broadcast-warning { background: #fff3cd; border: 2px solid #ffeaa7; color: #856404; }
        .broadcast-success { background: #d4edda; border: 2px solid #c3e6cb; color: #155724; }
        .broadcast-error { background: #f8d7da; border: 2px solid #f5c6cb; color: #721c24; }

        /* æ•™å­¸å…§å®¹æ¨£å¼ */
        .tutorial-content {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
        }

        .tutorial-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #17a2b8;
        }

        .tutorial-section h6 {
            color: #17a2b8;
            margin-bottom: 8px;
        }

        .tutorial-section p {
            margin-bottom: 5px;
            line-height: 1.4;
        }

        .tutorial-section strong {
            color: #ffc107;
        }

        /* åŸºç¤æ¨£å¼è¦†è“‹ */
        #editorContainer, #chatContainer, #aiResponse, #outputContent { 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            min-height: 100px;
        }
        
        #outputContent { 
            background-color: #f8f9fa; 
            padding: 10px; 
            max-height: 200px; 
            overflow-y: auto; 
            font-family: monospace; 
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="text-center mb-4">
            <h1 class="text-white"><i class="fas fa-code-branch"></i> Pythonå¤šäººå”ä½œæ•™å­¸å¹³å°</h1>
        </div>

        <div id="loginSection" class="card-custom p-4 mb-4">
            <h3 class="text-center mb-4"><i class="fas fa-users"></i> åŠ å…¥å”ä½œæˆ¿é–“</h3>
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">æˆ¿é–“åç¨±</label>
                        <div class="input-group">
                            <select class="form-select" id="roomSelect" onchange="updateRoomInput()">
                                <option value="general-room">general-room (é è¨­æˆ¿é–“)</option>
                                <option value="custom">è‡ªå®šç¾©æˆ¿é–“åç¨±...</option>
                            </select>
                        </div>
                        <input type="text" class="form-control mt-2" id="roomInput" placeholder="æˆ–è¼¸å…¥è‡ªå®šç¾©æˆ¿é–“åç¨±" value="general-room" style="display: none;">
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i> 
                            é¸æ“‡é è¨­æˆ¿é–“æˆ–è¼¸å…¥è‡ªå®šç¾©æˆ¿é–“åç¨±
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ‚¨çš„åç¨±</label>
                        <div class="dropdown">
                            <input type="text" class="form-control dropdown-toggle" id="username" 
                                   placeholder="è«‹è¼¸å…¥æ‚¨çš„ç”¨æˆ¶åç¨±" value="" required
                                   data-bs-toggle="dropdown" aria-expanded="false"
                                   autocomplete="off">
                            <ul class="dropdown-menu w-100" id="usernameDropdown">
                                <li><h6 class="dropdown-header">æœ€è¿‘ç™»å…¥çš„ç”¨æˆ¶</h6></li>
                                <li><hr class="dropdown-divider"></li>
                                <li class="text-center text-muted py-2" id="noUsersMessage">
                                    <i class="fas fa-info-circle"></i> æš«ç„¡ç™»å…¥è¨˜éŒ„
                                </li>
                            </ul>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i> 
                            è¼¸å…¥æ–°åç¨±æˆ–å¾ä¸‹æ‹‰é¸å–®é¸æ“‡ä¹‹å‰ç”¨éçš„åç¨±
                        </div>
                    </div>
                    <button class="btn btn-primary w-100 mb-3" onclick="globalJoinRoom()"><i class="fas fa-sign-in-alt"></i> åŠ å…¥æˆ¿é–“</button>
                    <div class="text-center">
                        <hr class="my-3">
                        <p class="text-muted mb-2">æ•™å¸«å°ˆç”¨</p>
                        <button class="btn btn-outline-warning" onclick="globalOpenTeacherDashboard()"><i class="fas fa-chalkboard-teacher"></i> æ•™å¸«ç›£æ§å¾Œå°</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="workspaceSection" style="display: none;">
            <div class="card-custom p-3 mb-4">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <h5 class="mb-0"><i class="fas fa-home"></i> æˆ¿é–“: <span id="currentRoom">-</span></h5>
                    </div>
                    <div class="col-md-3">
                        <h6 class="mb-0 text-info"><i class="fas fa-user"></i> æˆ‘æ˜¯: <span id="currentUserName">-</span></h6>
                    </div>
                    <div class="col-md-3">
                        <div id="onlineUsers"><strong>åœ¨ç·šç”¨æˆ¶:</strong></div>
                    </div>
                    <div class="col-md-3 text-end">
                        <span class="badge bg-success" id="connectionStatus">é€£æ¥ä¸­...</span>
                        <button class="btn btn-outline-danger btn-sm ms-2" onclick="globalLeaveRoom()">é›¢é–‹æˆ¿é–“</button>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="card-custom p-4" id="editorCard">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5><i class="fas fa-code"></i> å”ä½œç·¨è¼¯å™¨</h5>
                            <div>
                                <!-- ç¬¬ä¸€çµ„ï¼šä¿å­˜ã€è¼‰å…¥ã€é‹è¡Œ -->
                                <div class="btn-group me-2" role="group">
                                    <!-- ä¿å­˜æŒ‰éˆ•çµ„ -->
                                    <button class="btn btn-outline-primary btn-sm" onclick="globalSaveCode(true)">
                                        <i class="fas fa-save"></i> ä¿å­˜
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm dropdown-toggle dropdown-toggle-split" type="button" data-bs-toggle="dropdown" id="saveDropdownBtn">
                                        <span class="visually-hidden">Toggle Dropdown</span>
                                    </button>
                                    <ul class="dropdown-menu" id="saveCodeOptions">
                                        <li><h6 class="dropdown-header">ä¿å­˜é¸é …</h6></li>
                                        <li><a class="dropdown-item" href="#" onclick="globalSaveCode(true)">
                                            <i class="fas fa-save text-primary"></i> ä¿å­˜åˆ°æœ€æ–°
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><h6 class="dropdown-header">ä¿å­˜æ§½ä½</h6></li>
                                        <!-- æ§½ä½é …ç›®å°‡ç”± SaveLoadManager å‹•æ…‹ç”Ÿæˆ -->
                                    </ul>
                                    
                                    <!-- è¼‰å…¥æŒ‰éˆ•çµ„ -->
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="globalLoadCode('latest')">
                                        <i class="fas fa-sync-alt"></i> è¼‰å…¥
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle dropdown-toggle-split" type="button" data-bs-toggle="dropdown" id="loadDropdownBtn">
                                        <span class="visually-hidden">Toggle Dropdown</span>
                                    </button>
                                    <ul class="dropdown-menu" id="loadCodeOptions">
                                        <li><h6 class="dropdown-header">è¼‰å…¥é¸é …</h6></li>
                                        <li><a class="dropdown-item" href="#" onclick="globalLoadCode('latest')">
                                            <i class="fas fa-sync-alt text-success"></i> è¼‰å…¥æœ€æ–°
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><h6 class="dropdown-header">å·²ä¿å­˜ç‰ˆæœ¬</h6></li>
                                        <!-- å·²ä¿å­˜çš„æ§½ä½é …ç›®å°‡ç”± SaveLoadManager å‹•æ…‹ç”Ÿæˆ -->
                                    </ul>
                                </div>
                                
                                <!-- ç¬¬äºŒçµ„ï¼šè¤‡è£½ -->
                                <div class="btn-group me-2" role="group">
                                    <button class="btn btn-primary btn-sm" onclick="globalCopyCode()">
                                        <i class="fas fa-copy"></i> è¤‡è£½
                                    </button>
                                </div>
                                
                                <!-- ç¬¬ä¸‰çµ„ï¼šæ›´å¤š(ä¸‹è¼‰ã€å°å…¥) -->
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-info btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" id="moreOptionsBtn">
                                        <i class="fas fa-ellipsis-h"></i> æ›´å¤š
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><h6 class="dropdown-header">æª”æ¡ˆæ“ä½œ</h6></li>
                                        <li><a class="dropdown-item" href="#" onclick="globalDownloadCode()">
                                            <i class="fas fa-download text-primary"></i> ä¸‹è¼‰ .py æª”æ¡ˆ
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="globalImportCode()">
                                            <i class="fas fa-upload text-success"></i> å°å…¥æª”æ¡ˆ
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div id="editorContainer">
                            <textarea id="codeEditor"></textarea>
                            <input type="file" id="file-import" accept=".py,.txt" style="display: none;" onchange="globalHandleFileImport(event)">
                        </div>
                        <div id="codeOutput" class="mt-3" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6><i class="fas fa-terminal"></i> é‹è¡Œçµæœ</h6>
                                <button class="btn btn-outline-secondary btn-sm" onclick="globalClearOutput()"><i class="fas fa-times"></i> æ¸…é™¤</button>
                            </div>
                            <div id="outputContent"></div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card-custom p-3" id="rightPanel">
                        <!-- åˆ‡æ›æŒ‰éˆ• -->
                        <div class="d-flex justify-content-center mb-3">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-primary" id="aiTabBtn" onclick="globalSwitchToAI()">
                                    <i class="fas fa-robot"></i> AIåŠ©æ•™
                                </button>
                                <button type="button" class="btn btn-outline-success" id="chatTabBtn" onclick="globalSwitchToChat()">
                                    <i class="fas fa-comments"></i> èŠå¤©å®¤
                                </button>
                            </div>
                        </div>
                        
                        <!-- AIåŠ©æ•™å€åŸŸ -->
                        <div id="aiSection">
                            <div class="d-grid gap-2 mb-3">
                                <button class="btn btn-outline-info" onclick="globalAskAI('analyze')"><i class="fas fa-lightbulb"></i> è§£é‡‹ç¨‹å¼</button>
                                <button class="btn btn-outline-warning" onclick="globalAskAI('check_errors')"><i class="fas fa-bug"></i> æª¢æŸ¥éŒ¯èª¤</button>
                                <button class="btn btn-outline-success" onclick="globalAskAI('improvement_tips')"><i class="fas fa-lightbulb"></i> æ”¹é€²å»ºè­°</button>
                                <button class="btn btn-outline-danger" onclick="globalTestConflictAnalysis()"><i class="fas fa-code-branch"></i> è¡çªåˆ†æ</button>
                                <button class="btn btn-outline-primary" onclick="globalRunWithAI()"><i class="fas fa-play-circle"></i> AIé‹è¡Œä»£ç¢¼</button>
                            </div>
                            <div id="aiResponse" class="p-2" style="min-height: 350px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;"></div>
                            <div id="aiShareOptions" class="mt-2" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">åˆ†äº«åˆ°èŠå¤©å®¤?</small>
                                    <div>
                                        <button class="btn btn-success btn-sm" onclick="globalShareAIResponse()"><i class="fas fa-share"></i> åˆ†äº«</button>
                                        <button class="btn btn-secondary btn-sm" onclick="globalHideAIShareOptions()"><i class="fas fa-times"></i> å–æ¶ˆ</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- èŠå¤©å®¤å€åŸŸ -->
                        <div id="chatSection" style="display: none;">
                            <div id="chatContainer" class="p-2 mb-2" style="height: 400px; overflow-y: auto; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;">
                                <div class="text-center text-muted small">
                                    <i class="fas fa-comments"></i><br>
                                    æ­¡è¿ä½¿ç”¨èŠå¤©å®¤
                                </div>
                            </div>
                            <div class="input-group">
                                <input type="text" class="form-control" id="chatInput" placeholder="è¼¸å…¥æ¶ˆæ¯..." onkeypress="if(event.key==='Enter')globalSendChat()">
                                <button class="btn btn-primary" onclick="globalSendChat()"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å”ä½œæé†’ -->
        <div id="collaborationAlert" style="display: none; position: fixed; top: 20px; right: 20px; background-color: #fff3cd; color: #664d03; padding: 15px; border-radius: 5px; border: 1px solid #ffeeba; z-index: 1050;">
            <div class="d-flex align-items-center"><i class="fas fa-exclamation-triangle text-warning me-2"></i><div><strong>âš ï¸ å…¶ä»–åŒå­¸ä¹Ÿåœ¨ä¿®æ”¹ç¨‹å¼ç¢¼ï¼</strong><div id="collaboratingUsers" class="mt-1"></div></div></div>
        </div>

        <!-- ğŸ”§ ç’°å¢ƒæª¢æ¸¬é¢æ¿ -->
        <div id="envCheckPanel" style="display: none; position: fixed; bottom: 20px; right: 20px; background: white; border: 2px solid #007bff; border-radius: 8px; padding: 15px; z-index: 1060; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 400px;">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0"><i class="fas fa-cog"></i> ç’°å¢ƒè®Šæ•¸æª¢æ¸¬</h6>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleEnvPanel()"><i class="fas fa-times"></i></button>
            </div>
            <div id="envCheckContent">
                <div class="text-center"><i class="fas fa-spinner fa-spin"></i> æª¢æ¸¬ä¸­...</div>
            </div>
        </div>

        <!-- ğŸ”§ ç’°å¢ƒæª¢æ¸¬æŒ‰éˆ• -->
        <button id="envCheckBtn" onclick="toggleEnvPanel()" style="position: fixed; bottom: 20px; left: 20px; background: #007bff; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; z-index: 1059; box-shadow: 0 2px 8px rgba(0,0,0,0.2);" title="æª¢æŸ¥ç’°å¢ƒè®Šæ•¸">
            <i class="fas fa-cog"></i>
        </button>

        <!-- è¡çªè§£æ±ºæ¨¡æ…‹çª—å£ -->
        <div class="modal fade" id="conflictModal" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> å”ä½œè¡çª</h5>
                    </div>
                    <div class="modal-body">
                        <p>æª¢æ¸¬åˆ°å”ä½œè¡çªï¼<span id="conflictUserName">å…¶ä»–åŒå­¸</span>ä¹Ÿåœ¨åŒæ™‚ä¿®æ”¹ç¨‹å¼ç¢¼ï¼Œè«‹æŸ¥çœ‹å·®ç•°å¾Œé¸æ“‡è§£æ±ºæ–¹æ¡ˆï¼š</p>
                        
                        <!-- ğŸ”§ æ–°å¢ï¼šä»£ç¢¼å·®ç•°å°æ¯”å€åŸŸ -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-code-branch"></i> ä»£ç¢¼å·®ç•°å°æ¯”</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="row g-0">
                                    <div class="col-md-6">
                                        <div class="bg-info bg-opacity-10 p-2 border-end">
                                            <h6 class="text-info mb-2"><i class="fas fa-user"></i> æ‚¨çš„ç‰ˆæœ¬</h6>
                                            <pre id="myCodeVersion" class="bg-white p-2 rounded border" style="max-height: 200px; overflow-y: auto; font-size: 0.9em; white-space: pre-wrap;"></pre>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="bg-warning bg-opacity-10 p-2">
                                            <h6 class="text-warning mb-2"><i class="fas fa-users"></i> <span id="otherUserName">å°æ–¹</span>çš„ç‰ˆæœ¬</h6>
                                            <pre id="otherCodeVersion" class="bg-white p-2 rounded border" style="max-height: 200px; overflow-y: auto; font-size: 0.9em; white-space: pre-wrap;"></pre>
                                        </div>
                                    </div>
                                </div>
                                <!-- å·®ç•°æ‘˜è¦ -->
                                <div class="bg-light p-2 border-top">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle"></i> 
                                        <span id="diffSummary">æ­£åœ¨åˆ†æå·®ç•°...</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- è§£æ±ºæ–¹æ¡ˆæŒ‰éˆ• -->
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-outline-success w-100" onclick="globalResolveConflict('accept')">
                                    <i class="fas fa-check"></i> æ¥å—å°æ–¹ä¿®æ”¹
                                </button>
                            </div>
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-outline-warning w-100" onclick="globalResolveConflict('reject')">
                                    <i class="fas fa-times"></i> ä¿æŒæˆ‘çš„ç‰ˆæœ¬
                                </button>
                            </div>
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-outline-info w-100" onclick="globalShareConflictToChat()">
                                    <i class="fas fa-comments"></i> è¤‡è£½åˆ°èŠå¤©å®¤è¨è«–
                                </button>
                            </div>
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-outline-primary w-100" onclick="globalAskAIForConflictHelp()">
                                    <i class="fas fa-robot"></i> è«‹ AI å”åŠ©åˆ†æ
                                </button>
                            </div>
                        </div>
                        
                        <div id="conflictVersionInfo" class="text-muted small mb-2"></div>
                        <!-- AIåˆ†æçµæœå€åŸŸ -->
                        <div id="conflictAIAnalysis" class="mt-3 p-3 rounded" style="background:#f8f9fa; display: none;">
                            <h6 class="text-primary"><i class="fas fa-robot"></i> AIå”ä½œè¡çªåˆ†æ</h6>
                            <div id="aiAnalysisContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- main-container end -->

    <script>
    // ğŸ”§ å‹•æ…‹è·¯å¾‘ä¿®å¾© - Zeabur ç’°å¢ƒå°ˆç”¨è·¯å¾‘æª¢æ¸¬
    (function() {
        const currentPath = window.location.pathname;
        const hostname = window.location.hostname;
        const isZeabur = hostname.includes('zeabur.app');
        const isInPublicPath = currentPath.includes('/public/');
        
        console.log('ğŸ” ç•¶å‰è·¯å¾‘:', currentPath);
        console.log('ğŸ” æ˜¯å¦ Zeabur ç’°å¢ƒ:', isZeabur);
        console.log('ğŸ” æ˜¯å¦åœ¨ public è·¯å¾‘:', isInPublicPath);
        
        // ğŸ¯ Zeabur ç’°å¢ƒè·¯å¾‘ä¿®å¾©
        let jsBasePath = '';
        
        // ğŸ”§ ä¿®å¾©çš„JSæª”æ¡ˆè·¯å¾‘é‚è¼¯ - çµ±ä¸€ä½¿ç”¨ç›¸å°è·¯å¾‘
        if (isZeabur) {
            // Zeaburç’°å¢ƒï¼šç”±æ–¼ root: "public" åœ¨ zeabur.yaml ä¸­ï¼Œç›´æ¥ä½¿ç”¨ç›¸å°è·¯å¾‘
            jsBasePath = '';
            console.log('â˜ï¸ Zeaburç’°å¢ƒï¼šä½¿ç”¨ç›¸å°è·¯å¾‘è¼‰å…¥JSæ–‡ä»¶');
        } else {
            // æœ¬åœ°ç’°å¢ƒï¼šPHPæœå‹™å™¨ -t public å·²ç¶“å°‡ public/ è¨­ç‚ºæ ¹ç›®éŒ„
            jsBasePath = '';
            console.log('ğŸ  æœ¬åœ°ç’°å¢ƒï¼šPHPæœå‹™å™¨æ ¹ç›®éŒ„ç‚ºpublic/ï¼Œä½¿ç”¨ç›¸å°è·¯å¾‘');
        }
        
        // ğŸ¨ CSSæª”æ¡ˆè·¯å¾‘ä¿®å¾© - å°æ–¼Zeaburç’°å¢ƒä½¿ç”¨ç›¸å°è·¯å¾‘
        const existingStylesLink = document.querySelector('link[href*="styles.css"]');
        if (existingStylesLink && isZeabur) {
            // Zeaburç’°å¢ƒï¼šå˜—è©¦æ­£ç¢ºçš„ç›¸å°è·¯å¾‘åˆ° public/css/
            existingStylesLink.href = 'css/styles.css';
            console.log('ğŸ¨ CSSè·¯å¾‘å·²æ›´æ–°ç‚ºç›¸å°è·¯å¾‘: css/styles.css');
        }
        
        console.log('ğŸ”§ JS åŸºç¤è·¯å¾‘:', jsBasePath);
        console.log('ğŸ” è·¯å¾‘æ¢ä»¶æª¢æŸ¥:', { isZeabur, isInPublicPath, currentPath, hostname });
        
        // ğŸ¯ Zeaburç’°å¢ƒèª¿è©¦è·¯å¾‘è³‡è¨Š
        console.log('ğŸŒ å®Œæ•´URLä¿¡æ¯:', {
            origin: window.location.origin,
            pathname: window.location.pathname,
            hostname: window.location.hostname,
            href: window.location.href
        });
        
        // å®šç¾©éœ€è¦è¼‰å…¥çš„ JS æ–‡ä»¶ï¼ˆæŒ‰ä¾è³´é †åºï¼‰- ç´” HTTP è¼ªè©¢æ¶æ§‹
        const jsFiles = [
            'js/user-manager.js',     // ç”¨æˆ¶ç®¡ç†å™¨ï¼ˆæœ€é«˜å„ªå…ˆç´šï¼‰
            'js/http-polling.js',     // HTTP è¼ªè©¢ç®¡ç†å™¨ï¼ˆæ›¿ä»£ WebSocketï¼‰
            'js/save-load.js', 
            'js/ui.js?v=20250128-3',  // å¼·åˆ¶æ›´æ–°ç·©å­˜
            'js/editor.js',
            'js/chat.js',
            'js/ai-assistant.js',
            'js/conflict.js?v=20250128-3'  // è¡çªè§£æ±ºå™¨ä¹Ÿéœ€è¦æ›´æ–°
        ];
        
        let loadedCount = 0;
        let totalFiles = jsFiles.length;
        
        // ğŸš€ ä¸²è¡Œè¼‰å…¥ JS æ–‡ä»¶ä»¥ä¿æŒä¾è³´é—œä¿‚
        function loadNextScript(index) {
            if (index >= jsFiles.length) {
                console.log('ğŸ‰ æ‰€æœ‰ JS æ–‡ä»¶è¼‰å…¥å®Œæˆ');
                return;
            }
            
            const file = jsFiles[index];
            const script = document.createElement('script');
            script.src = jsBasePath + file;
            script.async = false;
            
            script.onload = function() {
                loadedCount++;
                console.log(`âœ… æˆåŠŸè¼‰å…¥ (${loadedCount}/${totalFiles}):`, file);
                // è¼‰å…¥ä¸‹ä¸€å€‹æ–‡ä»¶
                loadNextScript(index + 1);
            };
            
            script.onerror = function() {
                console.error('âŒ è¼‰å…¥å¤±æ•—:', file);
                
                // ğŸ”„ å‚™ç”¨è·¯å¾‘ç­–ç•¥ - çµ±ä¸€ä½¿ç”¨ç›¸å°è·¯å¾‘
                const fallbackPaths = [
                    './',               // ç•¶å‰ç›®éŒ„ï¼ˆç›¸å°è·¯å¾‘ï¼‰
                    '/',                // æ ¹ç›®éŒ„
                    '../'               // ä¸Šç´šç›®éŒ„ï¼ˆå‚™ç”¨ï¼‰
                ];
                
                let fallbackIndex = 0;
                function tryFallback() {
                    if (fallbackIndex >= fallbackPaths.length) {
                        console.error('âŒ æ‰€æœ‰å‚™ç”¨è·¯å¾‘éƒ½å¤±æ•—:', file);
                        // ç¹¼çºŒè¼‰å…¥ä¸‹ä¸€å€‹æ–‡ä»¶
                        loadNextScript(index + 1);
                        return;
                    }
                    
                    const fallbackPath = fallbackPaths[fallbackIndex];
                    const fallbackScript = document.createElement('script');
                    fallbackScript.src = fallbackPath + file.split('?')[0]; // ç§»é™¤ç‰ˆæœ¬åƒæ•¸
                    
                    fallbackScript.onload = () => {
                        loadedCount++;
                        console.log(`âœ… å‚™ç”¨è·¯å¾‘æˆåŠŸ (${loadedCount}/${totalFiles}):`, fallbackPath + file);
                        loadNextScript(index + 1);
                    };
                    
                    fallbackScript.onerror = () => {
                        console.warn(`âš ï¸ å‚™ç”¨è·¯å¾‘å¤±æ•—: ${fallbackPath}${file}`);
                        fallbackIndex++;
                        tryFallback();
                    };
                    
                    document.head.appendChild(fallbackScript);
                }
                
                tryFallback();
            };
            
            document.head.appendChild(script);
        }
        
        // é–‹å§‹è¼‰å…¥ç¬¬ä¸€å€‹è…³æœ¬
        loadNextScript(0);
        
        // ğŸ”¥ æ·»åŠ é é¢å¸è¼‰è™•ç† - ç¢ºä¿ç”¨æˆ¶æ­£ç¢ºé€€å‡ºæˆ¿é–“
        window.addEventListener('beforeunload', (event) => {
            console.log('ğŸ”Œ é é¢å³å°‡å¸è¼‰ï¼Œæ­£åœ¨é›¢é–‹æˆ¿é–“...');
            
            // ğŸ”¥ å¼·åˆ¶ç™¼é€é›¢é–‹è«‹æ±‚ï¼Œä¸ç®¡é€£æ¥ç‹€æ…‹å¦‚ä½•
            try {
                let roomId = 'general-room';
                let userId = '';
                
                // å˜—è©¦ç²å–ç•¶å‰æˆ¿é–“å’Œç”¨æˆ¶ä¿¡æ¯
                if (window.wsManager) {
                    roomId = window.wsManager.currentRoom || 'general-room';
                    userId = window.wsManager.currentUser || '';
                    
                    // ç«‹å³æ¨™è¨˜ç‚ºé›¢ç·šç‹€æ…‹
                    window.wsManager.isConnectedState = false;
                    
                    // åœæ­¢è¼ªè©¢
                    if (window.wsManager.stopPolling) {
                        window.wsManager.stopPolling();
                    }
                }
                
                // å¦‚æœæ²’æœ‰ç”¨æˆ¶IDï¼Œå˜—è©¦å¾å…¶ä»–åœ°æ–¹ç²å–
                if (!userId && window.UserManager && window.UserManager.getCurrentUser) {
                    const currentUser = window.UserManager.getCurrentUser();
                    userId = currentUser ? currentUser.id : '';
                }
                
                console.log('ğŸ”Œ é›¢é–‹æˆ¿é–“ä¿¡æ¯:', { roomId, userId });
                
                // ğŸ”¥ ä½¿ç”¨ sendBeacon ç™¼é€é›¢é–‹è«‹æ±‚ï¼ˆæœ€å¯é çš„æ–¹æ³•ï¼‰
                if (userId) {
                    const formData = new FormData();
                    formData.append('action', 'leave');
                    formData.append('room_id', roomId);
                    formData.append('user_id', userId);
                    
                    const success = navigator.sendBeacon('/api.php', formData);
                    console.log(success ? 'âœ… sendBeacon é›¢é–‹è«‹æ±‚å·²ç™¼é€' : 'âš ï¸ sendBeacon å¯èƒ½å¤±æ•—');
                    
                    // ğŸ”¥ å‚™ç”¨æ–¹æ¡ˆï¼šåŒæ­¥XHRï¼ˆç¢ºä¿ç™¼é€ï¼‰
                    if (!success) {
                        try {
                            const xhr = new XMLHttpRequest();
                            xhr.open('POST', '/api.php', false); // åŒæ­¥è«‹æ±‚
                            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                            xhr.send(`action=leave&room_id=${encodeURIComponent(roomId)}&user_id=${encodeURIComponent(userId)}`);
                            console.log('âœ… å‚™ç”¨ XHR é›¢é–‹è«‹æ±‚å·²ç™¼é€');
                        } catch (xhrError) {
                            console.warn('âš ï¸ å‚™ç”¨ XHR ä¹Ÿå¤±æ•—äº†:', xhrError);
                        }
                    }
                } else {
                    console.warn('âš ï¸ ç„¡æ³•ç²å–ç”¨æˆ¶IDï¼Œè·³éé›¢é–‹è«‹æ±‚');
                }
                
            } catch (error) {
                console.error('âŒ é é¢å¸è¼‰æ™‚é›¢é–‹æˆ¿é–“å¤±æ•—:', error);
            }
            
            // æ¸…ç†ç”¨æˆ¶ç®¡ç†å™¨
            if (window.UserManager && window.UserManager.cleanup) {
                window.UserManager.cleanup();
            }
        });
        
        // ğŸ”¥ æ·»åŠ é é¢éš±è—è™•ç† - è™•ç†ç§»å‹•è¨­å‚™æˆ–ç€è¦½å™¨æ¨™ç±¤åˆ‡æ›
        let pageHiddenStartTime = 0;
        
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                pageHiddenStartTime = Date.now();
                console.log('ğŸ“± é é¢å·²éš±è—ï¼Œé–‹å§‹è¨ˆæ™‚...');
                
                // ğŸ”¥ è¨­ç½®å»¶é²é›¢é–‹æ©Ÿåˆ¶ï¼ˆ5ç§’å¾Œå¦‚æœé‚„æ˜¯éš±è—å°±é›¢é–‹æˆ¿é–“ï¼‰
                setTimeout(() => {
                    if (document.visibilityState === 'hidden' && window.wsManager && window.wsManager.isConnected && window.wsManager.isConnected()) {
                        console.log('â° é é¢éš±è—è¶…é5ç§’ï¼Œä¸»å‹•é›¢é–‹æˆ¿é–“');
                        
                        // ç™¼é€é›¢é–‹è«‹æ±‚
                        const formData = new FormData();
                        formData.append('action', 'leave');
                        formData.append('room_id', window.wsManager.currentRoom || 'general-room');
                        formData.append('user_id', window.wsManager.currentUser || '');
                        
                        navigator.sendBeacon('/api.php', formData);
                        
                        // åœæ­¢è¼ªè©¢
                        if (window.wsManager.stopPolling) {
                            window.wsManager.stopPolling();
                        }
                        
                        window.wsManager.isConnectedState = false;
                    }
                }, 5000); // 5ç§’å»¶é²
                
            } else if (document.visibilityState === 'visible') {
                const hiddenDuration = pageHiddenStartTime > 0 ? Date.now() - pageHiddenStartTime : 0;
                console.log(`ğŸ‘€ é é¢é‡æ–°å¯è¦‹ï¼Œéš±è—äº† ${hiddenDuration}ms`);
                
                // ğŸ”¥ å¦‚æœéš±è—æ™‚é–“è¶…é10ç§’ï¼Œè¦–ç‚ºé‡æ–°é€£æ¥
                if (hiddenDuration > 10000) {
                    console.log('ğŸ”„ é•·æ™‚é–“éš±è—å¾Œé‡æ–°å¯è¦‹ï¼Œé‡æ–°åˆå§‹åŒ–é€£æ¥...');
                    
                    if (window.wsManager && !window.wsManager.isConnected()) {
                        // é‡æ–°é€£æ¥é‚è¼¯ï¼ˆå¦‚æœéœ€è¦ï¼‰
                        console.log('ğŸ’­ è€ƒæ…®é‡æ–°é€£æ¥åˆ°æˆ¿é–“...');
                    }
                }
                
                pageHiddenStartTime = 0;
            }
        });
    })();
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>

    <script>
    // ğŸ”§ ç’°å¢ƒè®Šæ•¸æª¢æ¸¬åŠŸèƒ½
    function toggleEnvPanel() {
        const panel = document.getElementById('envCheckPanel');
        const btn = document.getElementById('envCheckBtn');
        
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            btn.style.display = 'none';
            checkEnvironmentVariables();
        } else {
            panel.style.display = 'none';
            btn.style.display = 'block';
        }
    }
    
    async function checkEnvironmentVariables() {
        const content = document.getElementById('envCheckContent');
        
        try {
            // æª¢æŸ¥å¥åº·ç‹€æ…‹
            const healthResponse = await fetch('/public/health.php');
            const healthData = await healthResponse.json();
            
            // ç”Ÿæˆç’°å¢ƒå ±å‘Š
            let html = '<div style="font-size: 12px;">';
            
            // ç’°å¢ƒç‹€æ…‹
            html += `<div class="mb-2">
                <strong>ğŸŒ ç’°å¢ƒç‹€æ…‹:</strong><br>
                <span class="badge bg-${healthData.environment === 'zeabur' ? 'success' : 'warning'}">${healthData.environment}</span>
            </div>`;
            
            // æœå‹™ç‹€æ…‹
            html += '<div class="mb-2"><strong>ğŸ”§ æœå‹™ç‹€æ…‹:</strong><br>';
            if (healthData.services) {
                Object.entries(healthData.services).forEach(([service, status]) => {
                    const color = status === 'running' ? 'success' : status === 'partial' ? 'warning' : 'danger';
                    html += `<span class="badge bg-${color} me-1">${service}: ${status}</span><br>`;
                });
            }
            html += '</div>';
            
            // æª¢æŸ¥é—œéµç’°å¢ƒè®Šæ•¸ï¼ˆæ¨¡æ“¬ï¼Œå› ç‚ºç„¡æ³•å¾å‰ç«¯ç›´æ¥è¨ªå•ï¼‰
            html += '<div class="mb-2"><strong>ğŸ“‹ æ¨æ¸¬ç’°å¢ƒè®Šæ•¸:</strong><br>';
            
            // æ ¹æ“šæœå‹™ç‹€æ…‹æ¨æ¸¬ç’°å¢ƒè®Šæ•¸
            const pollingStatus = healthData.services?.polling || 'unknown';
            html += `<small>HTTP_POLLING: <span class="badge bg-${pollingStatus === 'enabled' ? 'success' : 'warning'}">${pollingStatus === 'enabled' ? 'enabled' : 'disabled'}</span><br>`;
            html += `NODE_ENV: <span class="badge bg-${healthData.environment === 'zeabur' ? 'success' : 'warning'}">${healthData.server?.environment || 'unknown'}</span><br>`;
            html += `PORT: <span class="badge bg-info">8080 (æ¨æ¸¬)</span></small>`;
            html += '</div>';
            
            // æ€§èƒ½ä¿¡æ¯
            if (healthData.performance) {
                html += `<div class="mb-2"><strong>âš¡ æ€§èƒ½:</strong><br>
                    <small>å…§å­˜ä½¿ç”¨: ${healthData.performance.memory_usage_mb}MB<br>
                    PHPç‰ˆæœ¬: ${healthData.services?.php || 'unknown'}</small>
                </div>`;
            }
            
            // å»ºè­°
            html += '<div class="mt-2">';
            if (pollingStatus === 'enabled') {
                html += '<div class="alert alert-success p-2" style="font-size: 11px;">âœ… HTTP è¼ªè©¢æ¨¡å¼å·²å•Ÿç”¨ï¼Œå°ˆç‚º Zeabur å–®ç«¯å£ç’°å¢ƒå„ªåŒ–</div>';
            } else {
                html += '<div class="alert alert-warning p-2" style="font-size: 11px;">âš ï¸ HTTP è¼ªè©¢æœªå•Ÿç”¨ï¼Œè«‹æª¢æŸ¥ç³»çµ±é…ç½®</div>';
            }
            html += '</div>';
            
            html += '</div>';
            content.innerHTML = html;
            
        } catch (error) {
            content.innerHTML = `<div class="alert alert-danger p-2" style="font-size: 11px;">âŒ ç„¡æ³•æª¢æ¸¬ç’°å¢ƒç‹€æ…‹: ${error.message}</div>`;
        }
    }
    </script>
</body>
</html> 