<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pythonå¤šäººå”ä½œæ•™å­¸å¹³å°</title>
    
    <!-- ğŸŒ ç’°å¢ƒè‡ªå‹•æª¢æ¸¬é…ç½® -->
    <script>
    (function() {
        const hostname = window.location.hostname;
        
        console.log('ğŸ” æª¢æ¸¬ç•¶å‰ç’°å¢ƒ:', hostname);
        
        // ç’°å¢ƒæª¢æ¸¬ï¼ˆWebSocket URL ç”± websocket.js è‡ªè¡Œæ±ºå®šï¼‰
        if (hostname === 'localhost' || hostname === '127.0.0.1') {
            console.log('ğŸ  æœ¬åœ°é–‹ç™¼ç’°å¢ƒæª¢æ¸¬');
        } else if (hostname.includes('zeabur.app') || hostname.includes('python-learn')) {
            console.log('â˜ï¸ Zeabur é›²ç«¯ç’°å¢ƒæª¢æ¸¬');
        } else {
            console.log('ğŸŒ è‡ªå®šç¾©åŸŸåç’°å¢ƒæª¢æ¸¬');
        }
        
        // è¨­ç½®ç’°å¢ƒæ¨™è­˜
        window.ENVIRONMENT = {
            isLocal: hostname === 'localhost' || hostname === '127.0.0.1',
            isZeabur: hostname.includes('zeabur.app'),
            hostname: hostname,
            protocol: window.location.protocol
        };
        
        console.log('ğŸ”§ ç’°å¢ƒé…ç½®å®Œæˆ:', window.ENVIRONMENT);
    })();
    </script>
    
    <!-- é¿å… favicon 404 éŒ¯èª¤ -->
    <link rel="icon" href="data:,">
    
    <!-- å¤–éƒ¨CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" rel="stylesheet">
    
    <!-- å…§åµŒåŸºæœ¬æ¨£å¼ (ç¢ºä¿å³ä½¿å¤–éƒ¨CSSåŠ è¼‰å¤±æ•—æˆ–è¢«ç§»é™¤ï¼Œä¹Ÿæœ‰åŸºæœ¬æ¡†æ¶) -->
    <style>
        body { background-color: #6f42c1; color: #333; font-family: sans-serif; padding-top: 20px; padding-bottom: 20px; }
        .main-container { max-width: 1200px; margin: auto; }
        .card-custom { background-color: white !important; border-radius: 10px !important; padding: 1.5rem !important; margin-bottom: 1.5rem !important; box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important; }
        .btn { cursor: pointer; }
        #editorContainer, #chatContainer, #aiResponse, #outputContent { border: 1px solid #ddd; border-radius: 5px; min-height: 100px;}
        #outputContent { background-color: #f8f9fa; padding: 10px; max-height: 200px; overflow-y: auto; font-family: monospace; white-space: pre-wrap;}
        
        /* æ•™å¸«å»£æ’­æ¨£å¼ */
        .teacher-broadcast {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            padding: 20px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 2000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideInRight 0.5s ease-out;
        }
        
        .broadcast-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            border-left: 5px solid #0056b3;
        }
        
        .broadcast-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            border-left: 5px solid #e0a800;
            color: #212529;
        }
        
        .broadcast-error {
            background: linear-gradient(135deg, #dc3545, #c82333);
            border-left: 5px solid #b21f2d;
        }
        
        .broadcast-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            border-left: 5px solid #155724;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .teacher-broadcast h5 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
        }
        
        .teacher-broadcast p {
            margin: 0;
            line-height: 1.4;
        }
        
        /* æ›´å¤šå¿…è¦çš„åŸºç¤æ¨£å¼å¯ä»¥åœ¨é€™è£¡æ·»åŠ ï¼Œä»¥æ¸›å°‘å°å¤–éƒ¨CSSæ–‡ä»¶çš„ä¾è³´ï¼Œä¸¦ç¢ºä¿JSæ§åˆ¶çš„æ¨£å¼æœ‰åŸºç¤ */
    </style>
</head>
<body>
    <div class="main-container">
        <div class="text-center mb-4">
            <h1 class="text-white"><i class="fas fa-code-branch"></i> Pythonå¤šäººå”ä½œæ•™å­¸å¹³å°</h1>
        </div>

        <div id="loginSection" class="card-custom p-4 mb-4">
            <h3 class="text-center mb-4"><i class="fas fa-users"></i> åŠ å…¥å”ä½œæˆ¿é–“</h3>
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">æˆ¿é–“åç¨±</label>
                        <input type="text" class="form-control" id="roomInput" placeholder="è¼¸å…¥æˆ¿é–“åç¨±" value="test-room">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ‚¨çš„åç¨±</label>
                        <input type="text" class="form-control" id="nameInput" placeholder="è¼¸å…¥æ‚¨çš„åç¨±" value="Alex Wang">
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i> 
                            é»˜èªä½¿ç”¨æ¸¬è©¦ç”¨æˆ¶"Alex Wang (è‰¾å…‹æ–¯ç‹)"ï¼Œæ‚¨å¯ä»¥ä¿®æ”¹ç‚ºå…¶ä»–åç¨±
                        </div>
                    </div>
                    <button class="btn btn-primary w-100 mb-3" onclick="globalJoinRoom()"><i class="fas fa-sign-in-alt"></i> åŠ å…¥æˆ¿é–“</button>
                    <div class="text-center">
                        <hr class="my-3">
                        <p class="text-muted mb-2">æ•™å¸«å°ˆç”¨</p>
                        <button class="btn btn-outline-warning" onclick="globalOpenTeacherDashboard()"><i class="fas fa-chalkboard-teacher"></i> æ•™å¸«ç›£æ§å¾Œå°</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="workspaceSection" style="display: none;">
            <div class="card-custom p-3 mb-4">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <h5 class="mb-0"><i class="fas fa-home"></i> æˆ¿é–“: <span id="currentRoom">-</span></h5>
                    </div>
                    <div class="col-md-3">
                        <h6 class="mb-0 text-info"><i class="fas fa-user"></i> æˆ‘æ˜¯: <span id="currentUserName">-</span></h6>
                    </div>
                    <div class="col-md-3">
                        <div id="onlineUsers"><strong>åœ¨ç·šç”¨æˆ¶:</strong></div>
                    </div>
                    <div class="col-md-3 text-end">
                        <span class="badge bg-success" id="connectionStatus">é€£æ¥ä¸­...</span>
                        <button class="btn btn-outline-danger btn-sm ms-2" onclick="globalLeaveRoom()">é›¢é–‹æˆ¿é–“</button>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="card-custom p-4" id="editorCard">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5><i class="fas fa-code"></i> å”ä½œç·¨è¼¯å™¨</h5>
                            <div>
                                <!-- ç¬¬ä¸€çµ„ï¼šä¿å­˜ã€è¼‰å…¥ã€é‹è¡Œ -->
                                <div class="btn-group me-2" role="group">
                                    <!-- ä¿å­˜æŒ‰éˆ•çµ„ -->
                                    <button class="btn btn-outline-primary btn-sm" onclick="globalSaveCode(true)">
                                        <i class="fas fa-save"></i> ä¿å­˜
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm dropdown-toggle dropdown-toggle-split" type="button" data-bs-toggle="dropdown" id="saveDropdownBtn">
                                        <span class="visually-hidden">Toggle Dropdown</span>
                                    </button>
                                    <ul class="dropdown-menu" id="saveCodeOptions">
                                        <li><h6 class="dropdown-header">ä¿å­˜é¸é …</h6></li>
                                        <li><a class="dropdown-item" href="#" onclick="globalSaveCode(true)">
                                            <i class="fas fa-save text-primary"></i> ä¿å­˜åˆ°æœ€æ–°
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><h6 class="dropdown-header">ä¿å­˜æ§½ä½</h6></li>
                                        <li><a class="dropdown-item" href="#" onclick="globalSaveToSlot(1)">
                                            <i class="fas fa-folder text-info"></i> ä¿å­˜åˆ°æ§½ä½ 1
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="globalSaveToSlot(2)">
                                            <i class="fas fa-folder text-info"></i> ä¿å­˜åˆ°æ§½ä½ 2
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="globalSaveToSlot(3)">
                                            <i class="fas fa-folder text-info"></i> ä¿å­˜åˆ°æ§½ä½ 3
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="globalSaveToSlot(4)">
                                            <i class="fas fa-folder text-info"></i> ä¿å­˜åˆ°æ§½ä½ 4
                                        </a></li>
                                    </ul>
                                    
                                    <!-- è¼‰å…¥æŒ‰éˆ•çµ„ -->
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="globalLoadCode('latest')">
                                        <i class="fas fa-sync-alt"></i> è¼‰å…¥
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle dropdown-toggle-split" type="button" data-bs-toggle="dropdown" id="loadDropdownBtn">
                                        <span class="visually-hidden">Toggle Dropdown</span>
                                    </button>
                                    <ul class="dropdown-menu" id="loadCodeOptions">
                                        <li><h6 class="dropdown-header">è¼‰å…¥é¸é …</h6></li>
                                        <li><a class="dropdown-item" href="#" onclick="globalLoadCode('latest')">
                                            <i class="fas fa-sync-alt text-success"></i> è¼‰å…¥æœ€æ–°
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><h6 class="dropdown-header">æ­·å²ç‰ˆæœ¬</h6></li>
                                        <li id="historyEmptyMessage"><span class="dropdown-item-text text-muted">ç„¡æ­·å²ç‰ˆæœ¬</span></li>
                                    </ul>
                                    
                                    <button class="btn btn-outline-success btn-sm" onclick="globalRunCode()">
                                        <i class="fas fa-play"></i> é‹è¡Œ
                                    </button>
                                </div>
                                
                                <!-- ç¬¬äºŒçµ„ï¼šè¤‡è£½ -->
                                <div class="btn-group me-2" role="group">
                                    <button class="btn btn-primary btn-sm" onclick="globalCopyCode()">
                                        <i class="fas fa-copy"></i> è¤‡è£½
                                    </button>
                                </div>
                                
                                <!-- ç¬¬ä¸‰çµ„ï¼šæ›´å¤š(ä¸‹è¼‰ã€å°å…¥) -->
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-info btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" id="moreOptionsBtn">
                                        <i class="fas fa-ellipsis-h"></i> æ›´å¤š
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><h6 class="dropdown-header">æª”æ¡ˆæ“ä½œ</h6></li>
                                        <li><a class="dropdown-item" href="#" onclick="globalDownloadCode()">
                                            <i class="fas fa-download text-primary"></i> ä¸‹è¼‰ .py æª”æ¡ˆ
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="globalImportCode()">
                                            <i class="fas fa-upload text-success"></i> å°å…¥æª”æ¡ˆ
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div id="editorContainer">
                            <textarea id="codeEditor"></textarea>
                            <input type="file" id="file-import" accept=".py,.txt" style="display: none;" onchange="globalHandleFileImport(event)">
                        </div>
                        <div id="codeOutput" class="mt-3" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6><i class="fas fa-terminal"></i> é‹è¡Œçµæœ</h6>
                                <button class="btn btn-outline-secondary btn-sm" onclick="globalClearOutput()"><i class="fas fa-times"></i> æ¸…é™¤</button>
                            </div>
                            <div id="outputContent"></div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card-custom p-3 mb-3" id="panelCard">
                        <div class="d-flex justify-content-center mb-3">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-primary" id="aiTabBtn" onclick="globalSwitchToAI()"><i class="fas fa-robot"></i> AIåŠ©æ•™</button>
                                <button type="button" class="btn btn-outline-success" id="chatTabBtn" onclick="globalSwitchToChat()"><i class="fas fa-comments"></i> èŠå¤©å®¤</button>
                            </div>
                        </div>
                        <div id="aiSection">
                            <div class="d-grid gap-2 mb-3">
                                <button class="btn btn-outline-info" onclick="globalAskAI('analyze')"><i class="fas fa-lightbulb"></i> è§£é‡‹ç¨‹å¼</button>
                                <button class="btn btn-outline-warning" onclick="globalAskAI('check_errors')"><i class="fas fa-bug"></i> æª¢æŸ¥éŒ¯èª¤</button>
                                <button class="btn btn-outline-success" onclick="globalAskAI('improvement_tips')"><i class="fas fa-lightbulb"></i> æ”¹é€²å»ºè­°</button>
                                <button class="btn btn-outline-danger" onclick="globalTestConflictAnalysis()"><i class="fas fa-code-branch"></i> è¡çªåˆ†æ</button>
                                <button class="btn btn-outline-primary" onclick="globalShowTutorial()"><i class="fas fa-question-circle"></i> æ“ä½œæ•™å­¸</button>
                            </div>
                            <div id="aiResponse" class="p-2" style="min-height: 200px; background: #f8f9fa;"></div>
                            <div id="aiShareOptions" class="mt-2" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">åˆ†äº«åˆ°èŠå¤©å®¤?</small>
                                    <div>
                                        <button class="btn btn-success btn-sm" onclick="globalShareAIResponse()"><i class="fas fa-share"></i> åˆ†äº«</button>
                                        <button class="btn btn-secondary btn-sm" onclick="globalHideAIShareOptions()"><i class="fas fa-times"></i> å–æ¶ˆ</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="chatSection" style="display: none;">
                            <div id="chatContainer" class="p-2 mb-2" style="height: 300px; overflow-y: auto; background: #f8f9fa;"></div>
                            <div class="input-group">
                                <input type="text" class="form-control" id="chatInput" placeholder="è¼¸å…¥æ¶ˆæ¯...">
                                <button class="btn btn-primary" onclick="globalSendChat()"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å”ä½œæé†’ -->
        <div id="collaborationAlert" style="display: none; position: fixed; top: 20px; right: 20px; background-color: #fff3cd; color: #664d03; padding: 15px; border-radius: 5px; border: 1px solid #ffeeba; z-index: 1050;">
            <div class="d-flex align-items-center"><i class="fas fa-exclamation-triangle text-warning me-2"></i><div><strong>âš ï¸ å…¶ä»–åŒå­¸ä¹Ÿåœ¨ä¿®æ”¹ç¨‹å¼ç¢¼ï¼</strong><div id="collaboratingUsers" class="mt-1"></div></div></div>
        </div>

        <!-- è¡çªè§£æ±ºæ¨¡æ…‹çª—å£ -->
        <div class="modal fade" id="conflictModal" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> å”ä½œè¡çª</h5>
                    </div>
                    <div class="modal-body">
                        <p>æª¢æ¸¬åˆ°å”ä½œè¡çªï¼<span id="conflictUserName">å…¶ä»–åŒå­¸</span>ä¹Ÿåœ¨åŒæ™‚ä¿®æ”¹ç¨‹å¼ç¢¼ï¼Œè«‹æŸ¥çœ‹å·®ç•°å¾Œé¸æ“‡è§£æ±ºæ–¹æ¡ˆï¼š</p>
                        
                        <!-- ğŸ”§ æ–°å¢ï¼šä»£ç¢¼å·®ç•°å°æ¯”å€åŸŸ -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-code-branch"></i> ä»£ç¢¼å·®ç•°å°æ¯”</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="row g-0">
                                    <div class="col-md-6">
                                        <div class="bg-info bg-opacity-10 p-2 border-end">
                                            <h6 class="text-info mb-2"><i class="fas fa-user"></i> æ‚¨çš„ç‰ˆæœ¬</h6>
                                            <pre id="myCodeVersion" class="bg-white p-2 rounded border" style="max-height: 200px; overflow-y: auto; font-size: 0.9em; white-space: pre-wrap;"></pre>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="bg-warning bg-opacity-10 p-2">
                                            <h6 class="text-warning mb-2"><i class="fas fa-users"></i> <span id="otherUserName">å°æ–¹</span>çš„ç‰ˆæœ¬</h6>
                                            <pre id="otherCodeVersion" class="bg-white p-2 rounded border" style="max-height: 200px; overflow-y: auto; font-size: 0.9em; white-space: pre-wrap;"></pre>
                                        </div>
                                    </div>
                                </div>
                                <!-- å·®ç•°æ‘˜è¦ -->
                                <div class="bg-light p-2 border-top">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle"></i> 
                                        <span id="diffSummary">æ­£åœ¨åˆ†æå·®ç•°...</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- è§£æ±ºæ–¹æ¡ˆæŒ‰éˆ• -->
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-outline-success w-100" onclick="globalResolveConflict('reload')">
                                    <i class="fas fa-check"></i> æ¥å—å°æ–¹ä¿®æ”¹
                                </button>
                            </div>
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-outline-warning w-100" onclick="globalResolveConflict('force')">
                                    <i class="fas fa-times"></i> ä¿æŒæˆ‘çš„ç‰ˆæœ¬
                                </button>
                            </div>
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-outline-info w-100" onclick="globalResolveConflict('discuss')">
                                    <i class="fas fa-comments"></i> è¤‡è£½åˆ°èŠå¤©å®¤è¨è«–
                                </button>
                            </div>
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-outline-primary w-100" onclick="globalAskAIForConflictHelp()">
                                    <i class="fas fa-robot"></i> è«‹ AI å”åŠ©åˆ†æ
                                </button>
                            </div>
                        </div>
                        
                        <div id="conflictVersionInfo" class="text-muted small mb-2"></div>
                        <!-- AIåˆ†æçµæœå€åŸŸ -->
                        <div id="conflictAIAnalysis" class="mt-3 p-3 rounded" style="background:#f8f9fa; display: none;">
                            <h6 class="text-primary"><i class="fas fa-robot"></i> AIå”ä½œè¡çªåˆ†æ</h6>
                            <div id="aiAnalysisContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- main-container end -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    
    <!-- æ¨¡çµ„åŒ–JSæª”æ¡ˆ (ç¢ºä¿è·¯å¾‘ç›¸å°æ–¼publicç›®éŒ„æ˜¯æ­£ç¢ºçš„) -->
    <script src="js/auto-login.js"></script>
    <script src="js/websocket.js"></script>
    <script src="js/save-load.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/editor.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/ai-assistant.js"></script>
    <script src="js/conflict.js"></script>
    
    <!-- æ­·å²è¨˜éŒ„é¡¯ç¤ºä¿®å¾©è…³æœ¬ -->
    <script>
        // ç¢ºä¿æ­·å²è¨˜éŒ„èƒ½æ­£ç¢ºé¡¯ç¤ºçš„ä¿®å¾©è…³æœ¬
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”§ æ­·å²è¨˜éŒ„ä¿®å¾©è…³æœ¬å•Ÿå‹•');
            
            // ç­‰å¾…å…¶ä»–æ¨¡çµ„è¼‰å…¥å®Œæˆ
            setTimeout(function() {
                // å¼·åˆ¶è«‹æ±‚ä¸€æ¬¡æ­·å²è¨˜éŒ„
                if (window.wsManager && window.wsManager.isConnected()) {
                    console.log('ğŸ“œ é€šé WebSocket è«‹æ±‚æ­·å²è¨˜éŒ„');
                    window.wsManager.getHistory();
                } else {
                    console.log('ğŸ“œ é€šé HTTP API è«‹æ±‚æ­·å²è¨˜éŒ„');
                    fetch('/api/history?room_id=test_room_001')
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.history && window.SaveLoadManager) {
                                console.log('âœ… ç²å–åˆ°æ­·å²æ•¸æ“šï¼Œæ›´æ–°ä¸‹æ‹‰é¸å–®');
                                window.SaveLoadManager.updateHistoryDropdown(data.history);
                            }
                        })
                        .catch(error => console.error('âŒ æ­·å²è¨˜éŒ„è«‹æ±‚å¤±æ•—:', error));
                }
            }, 3000);
        });
    </script>
    
    <script>
        // å…¨åŸŸäº‹ä»¶è™•ç†å‡½æ•¸ (é¿å…HTMLä¸­çš„onclickç›´æ¥èª¿ç”¨æ¨¡çµ„å…§éƒ¨æ–¹æ³•å°è‡´å¯èƒ½çš„åˆå§‹åŒ–é †åºå•é¡Œ)
        function globalJoinRoom() { if(UI) UI.joinRoom(); else console.error("UI not ready"); }
        function globalLeaveRoom() { if(UI) UI.leaveRoom(); else console.error("UI not ready"); }
        function globalLoadCode(loadType) { 
            if(Editor) Editor.loadCode(loadType); 
            else console.error("Editor not ready"); 
        }
        function globalSaveCode() { if(Editor) Editor.saveCode(); else console.error("Editor not ready"); }
        function globalRunCode() { if(Editor) Editor.runCode(); else console.error("Editor not ready"); }
        function globalClearOutput() { if(Editor) Editor.clearOutput(); else console.error("Editor not ready"); }
        function globalSwitchToAI() { if(UI) UI.switchToAI(); else console.error("UI not ready"); }
        function globalSwitchToChat() { if(UI) UI.switchToChat(); else console.error("UI not ready"); }
        function globalAskAI(action) { if(AIAssistant) AIAssistant.requestAnalysis(action); else console.error("AIAssistant not ready"); }
        function globalShareAIResponse() { if(AIAssistant) AIAssistant.shareResponse(); else console.error("AIAssistant not ready"); }
        function globalHideShareOptions() { if(AIAssistant) AIAssistant.hideShareOptions(); else console.error("AIAssistant not ready"); }
        function globalSendChat() { if(Chat) Chat.sendMessage(); else console.error("Chat not ready"); }
        function globalResolveConflict(action) { if(ConflictResolver) ConflictResolver.resolveConflict(action); else console.error("ConflictResolver not ready"); }
        function globalAskAIForConflictHelp() { if(ConflictResolver) ConflictResolver.requestAIAnalysis(); else console.error("ConflictResolver not ready"); }
        function globalTestConflictAnalysis() { 
            console.log('ğŸ§ª åŸ·è¡Œè¡çªåˆ†ææ¸¬è©¦');
            
            // é¡¯ç¤ºè¡çªåˆ†æé¸é …æ¨¡æ…‹æ¡†
            showConflictAnalysisOptions();
        }
        function globalOpenTeacherDashboard() { window.open('/teacher', '_blank'); }
        function globalShowTutorial() { if(UI) UI.showTutorial(); else console.error("UI not ready"); }
        
        // æ–°å¢çš„æª”æ¡ˆæ“ä½œåŠŸèƒ½
        function globalCopyCode() { if(Editor) Editor.copyCode(); else console.error("Editor not ready"); }
        function globalDownloadCode() { if(Editor) Editor.downloadCode(); else console.error("Editor not ready"); }
        function globalImportCode() { if(Editor) Editor.importCode(); else console.error("Editor not ready"); }
        function globalHandleFileImport(event) { if(Editor) Editor.handleFileImport(event); else console.error("Editor not ready"); }

        // ğŸ” é¡¯ç¤ºè¡çªåˆ†æé¸é …
        function showConflictAnalysisOptions() {
            const modalHTML = `
                <div class="modal fade" id="conflictAnalysisModal" tabindex="-1" aria-labelledby="conflictAnalysisModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title" id="conflictAnalysisModalLabel">
                                    <i class="fas fa-code-branch"></i> è¡çªåˆ†æå·¥å…·
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-body text-center">
                                                <i class="fas fa-vial text-warning mb-3" style="font-size: 2rem;"></i>
                                                <h6 class="card-title">æ¸¬è©¦è¡çªæª¢æ¸¬</h6>
                                                <p class="card-text text-muted">æ¨¡æ“¬è¡çªæƒ…æ³ï¼Œæ¸¬è©¦ç³»çµ±çš„è¡çªæª¢æ¸¬åŠŸèƒ½</p>
                                                <button class="btn btn-warning" onclick="performConflictTest()">
                                                    <i class="fas fa-play"></i> é–‹å§‹æ¸¬è©¦
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-body text-center">
                                                <i class="fas fa-history text-primary mb-3" style="font-size: 2rem;"></i>
                                                <h6 class="card-title">è¡çªæ­·å²è¨˜éŒ„</h6>
                                                <p class="card-text text-muted">æŸ¥çœ‹éå»çš„è¡çªè¨˜éŒ„å’Œè§£æ±ºæ–¹æ¡ˆ</p>
                                                <button class="btn btn-primary" onclick="showConflictHistory()">
                                                    <i class="fas fa-list"></i> æŸ¥çœ‹æ­·å²
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="fas fa-info-circle text-info"></i> è¡çªåˆ†æèªªæ˜
                                            </h6>
                                            <ul class="mb-0">
                                                <li><strong>æ¸¬è©¦è¡çªæª¢æ¸¬ï¼š</strong>æ¨¡æ“¬å¤šäººå”ä½œè¡çªï¼Œé©—è­‰ç³»çµ±åæ‡‰</li>
                                                <li><strong>è¡çªæ­·å²è¨˜éŒ„ï¼š</strong>æŸ¥çœ‹ä¹‹å‰çš„è¡çªäº‹ä»¶å’Œè§£æ±ºæ–¹å¼</li>
                                                <li><strong>AIå”åŠ©åˆ†æï¼š</strong>åœ¨å¯¦éš›è¡çªç™¼ç”Ÿæ™‚æä¾›æ™ºèƒ½å»ºè­°</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ç§»é™¤èˆŠçš„æ¨¡æ…‹æ¡†
            const existingModal = document.getElementById('conflictAnalysisModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // æ·»åŠ æ–°çš„æ¨¡æ…‹æ¡†
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // é¡¯ç¤ºæ¨¡æ…‹æ¡†
            const modal = new bootstrap.Modal(document.getElementById('conflictAnalysisModal'));
            modal.show();
        }
        
        // ğŸ§ª åŸ·è¡Œè¡çªæ¸¬è©¦
        function performConflictTest() {
            console.log('ğŸ§ª é–‹å§‹è¡çªæ¸¬è©¦');
            
            // é—œé–‰é¸é …æ¨¡æ…‹æ¡†
            const modal = bootstrap.Modal.getInstance(document.getElementById('conflictAnalysisModal'));
            if (modal) modal.hide();
            
            // å‰µå»ºæ¸¬è©¦è¡çªæ•¸æ“š
            const testConflictData = {
                roomId: 'test-room',
                conflictUser: 'æ¸¬è©¦ç”¨æˆ¶',
                userVersion: 1,
                serverVersion: 2,
                userCode: window.Editor ? window.Editor.getCode() : '# æ¸¬è©¦ç¨‹å¼ç¢¼\nprint("Hello, World!")',
                serverCode: '# æ¨¡æ“¬çš„æœå‹™å™¨ä»£ç¢¼\nprint("Hello, Python!")\nprint("é€™æ˜¯è¡çªæ¸¬è©¦")'
            };
            
            // é¡¯ç¤ºè¡çªè§£æ±ºæ¨¡æ…‹æ¡†
            if (window.ConflictResolver) {
                window.ConflictResolver.showConflictModal(testConflictData);
                showToast('è¡çªæ¸¬è©¦é–‹å§‹ï¼Œè«‹åœ¨å½ˆå‡ºçš„è¦–çª—ä¸­æŸ¥çœ‹', 'info');
            } else {
                showToast('è¡çªè§£æ±ºå™¨æœªåˆå§‹åŒ–', 'error');
            }
        }
        
        // ğŸ“Š é¡¯ç¤ºè¡çªæ­·å²
        function showConflictHistory() {
            console.log('ğŸ“Š é¡¯ç¤ºè¡çªæ­·å²');
            
            // é—œé–‰é¸é …æ¨¡æ…‹æ¡†
            const modal = bootstrap.Modal.getInstance(document.getElementById('conflictAnalysisModal'));
            if (modal) modal.hide();
            
            if (typeof conflictHistoryManager === 'undefined') {
                showToast('è¡çªæ­·å²ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            const history = conflictHistoryManager.getConflictHistory();
            const stats = conflictHistoryManager.getStatistics();
            
            let historyHTML = '';
            if (history.length === 0) {
                historyHTML = '<div class="text-center py-4"><i class="fas fa-inbox text-muted"></i><p class="text-muted mt-2">å°šç„¡è¡çªè¨˜éŒ„</p></div>';
            } else {
                historyHTML = history.map(record => `
                    <div class="card mb-2">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">
                                        <i class="fas fa-users text-primary"></i> 
                                        èˆ‡ ${record.conflictUser} çš„è¡çª
                                        <span class="badge bg-${record.resolution === 'accepted' ? 'success' : record.resolution === 'rejected' ? 'warning' : 'info'} ms-2">
                                            ${record.resolution === 'accepted' ? 'å·²æ¥å—' : record.resolution === 'rejected' ? 'å·²æ‹’çµ•' : 'å·²åˆä½µ'}
                                        </span>
                                    </h6>
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> ${new Date(record.timestamp).toLocaleString()}
                                        <i class="fas fa-home ms-2"></i> ${record.roomId}
                                    </small>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="showConflictDetail(${record.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            const modalHTML = `
                <div class="modal fade" id="conflictHistoryModal" tabindex="-1" aria-labelledby="conflictHistoryModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title" id="conflictHistoryModalLabel">
                                    <i class="fas fa-history"></i> è¡çªæ­·å²è¨˜éŒ„
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <!-- çµ±è¨ˆä¿¡æ¯ -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h4 class="text-primary">${stats.total}</h4>
                                                <small class="text-muted">ç¸½è¡çªæ•¸</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h4 class="text-success">${stats.accepted}</h4>
                                                <small class="text-muted">å·²æ¥å—</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h4 class="text-warning">${stats.rejected}</h4>
                                                <small class="text-muted">å·²æ‹’çµ•</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h4 class="text-info">${stats.acceptanceRate}%</h4>
                                                <small class="text-muted">æ¥å—ç‡</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- è¡çªè¨˜éŒ„åˆ—è¡¨ -->
                                <div class="conflict-history-list" style="max-height: 400px; overflow-y: auto;">
                                    ${historyHTML}
                                </div>
                                
                                ${history.length > 0 ? `
                                <div class="mt-3 text-center">
                                    <button class="btn btn-outline-danger" onclick="clearConflictHistory()">
                                        <i class="fas fa-trash"></i> æ¸…é™¤æ‰€æœ‰è¨˜éŒ„
                                    </button>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ç§»é™¤èˆŠçš„æ¨¡æ…‹æ¡†
            const existingModal = document.getElementById('conflictHistoryModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // æ·»åŠ æ–°çš„æ¨¡æ…‹æ¡†
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // é¡¯ç¤ºæ¨¡æ…‹æ¡†
            const historyModal = new bootstrap.Modal(document.getElementById('conflictHistoryModal'));
            historyModal.show();
        }
        
        // ğŸ“‹ é¡¯ç¤ºè¡çªè©³æƒ…
        function showConflictDetail(recordId) {
            if (typeof conflictHistoryManager === 'undefined') return;
            
            const record = conflictHistoryManager.getConflictHistory().find(r => r.id === recordId);
            if (!record) return;
            
            const detailHTML = `
                <div class="modal fade" id="conflictDetailModal" tabindex="-1" aria-labelledby="conflictDetailModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title" id="conflictDetailModalLabel">
                                    <i class="fas fa-info-circle"></i> è¡çªè©³æƒ… - ${new Date(record.timestamp).toLocaleString()}
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <!-- åŸºæœ¬ä¿¡æ¯ -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <i class="fas fa-info"></i> è¡çªä¿¡æ¯
                                            </div>
                                            <div class="card-body">
                                                <p><strong>æˆ¿é–“ï¼š</strong>${record.roomId}</p>
                                                <p><strong>è¡çªå°è±¡ï¼š</strong>${record.conflictUser}</p>
                                                <p><strong>æˆ‘çš„ç‰ˆæœ¬ï¼š</strong>${record.userVersion}</p>
                                                <p><strong>å°æ–¹ç‰ˆæœ¬ï¼š</strong>${record.serverVersion}</p>
                                                <p><strong>è§£æ±ºæ–¹å¼ï¼š</strong>
                                                    <span class="badge bg-${record.resolution === 'accepted' ? 'success' : record.resolution === 'rejected' ? 'warning' : 'info'}">
                                                        ${record.resolution === 'accepted' ? 'æ¥å—å°æ–¹ä¿®æ”¹' : record.resolution === 'rejected' ? 'æ‹’çµ•å°æ–¹ä¿®æ”¹' : 'æ‰‹å‹•åˆä½µ'}
                                                    </span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <i class="fas fa-chart-bar"></i> ä»£ç¢¼çµ±è¨ˆ
                                            </div>
                                            <div class="card-body">
                                                <p><strong>æˆ‘çš„ä»£ç¢¼é•·åº¦ï¼š</strong>${record.userCode.length} å­—ç¬¦</p>
                                                <p><strong>å°æ–¹ä»£ç¢¼é•·åº¦ï¼š</strong>${record.serverCode.length} å­—ç¬¦</p>
                                                <p><strong>AIåˆ†æï¼š</strong>${record.aiAnalysis ? 'å·²æä¾›' : 'æœªä½¿ç”¨'}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- ä»£ç¢¼å°æ¯” -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-primary text-white">
                                                <i class="fas fa-user"></i> æˆ‘çš„ä»£ç¢¼
                                            </div>
                                            <div class="card-body">
                                                <pre class="bg-light p-2 rounded" style="max-height: 200px; overflow-y: auto;"><code>${record.userCode || '(ç©ºç™½)'}</code></pre>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-secondary text-white">
                                                <i class="fas fa-users"></i> å°æ–¹ä»£ç¢¼
                                            </div>
                                            <div class="card-body">
                                                <pre class="bg-light p-2 rounded" style="max-height: 200px; overflow-y: auto;"><code>${record.serverCode || '(ç©ºç™½)'}</code></pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                ${record.aiAnalysis ? `
                                <!-- AIåˆ†æçµæœ -->
                                <div class="card">
                                    <div class="card-header bg-success text-white">
                                        <i class="fas fa-robot"></i> AIåˆ†æçµæœ
                                    </div>
                                    <div class="card-body">
                                        <div style="max-height: 300px; overflow-y: auto;">
                                            ${record.aiAnalysis.replace(/\n/g, '<br>')}
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ç§»é™¤èˆŠçš„è©³æƒ…æ¨¡æ…‹æ¡†
            const existingDetailModal = document.getElementById('conflictDetailModal');
            if (existingDetailModal) {
                existingDetailModal.remove();
            }
            
            // æ·»åŠ æ–°çš„è©³æƒ…æ¨¡æ…‹æ¡†
            document.body.insertAdjacentHTML('beforeend', detailHTML);
            
            // é¡¯ç¤ºè©³æƒ…æ¨¡æ…‹æ¡†
            const detailModal = new bootstrap.Modal(document.getElementById('conflictDetailModal'));
            detailModal.show();
        }
        
        // ğŸ—‘ï¸ æ¸…é™¤è¡çªæ­·å²
        function clearConflictHistory() {
            if (typeof conflictHistoryManager === 'undefined') return;
            
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¡çªæ­·å²è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ¢å¾©ã€‚')) {
                conflictHistoryManager.clearHistory();
                
                // é—œé–‰æ¨¡æ…‹æ¡†ä¸¦é‡æ–°é¡¯ç¤º
                const modal = bootstrap.Modal.getInstance(document.getElementById('conflictHistoryModal'));
                if (modal) modal.hide();
                
                showToast('è¡çªæ­·å²è¨˜éŒ„å·²æ¸…é™¤', 'success');
                
                // å»¶é²é‡æ–°é¡¯ç¤ºæ­·å²ï¼ˆç¾åœ¨æ˜¯ç©ºçš„ï¼‰
                setTimeout(() => {
                    showConflictHistory();
                }, 500);
            }
        }

        // DOMContentLoaded äº‹ä»¶è™•ç†
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Pythonå¤šäººå”ä½œæ•™å­¸å¹³å°è¼‰å…¥å®Œæˆ');
            
            // åˆå§‹åŒ–æ‰€æœ‰æ¨¡çµ„
            console.log('ğŸš€ åˆå§‹åŒ–æ‰€æœ‰æ¨¡çµ„...');
            
            // åˆå§‹åŒ–UIæ¨¡çµ„
            if (typeof UI !== 'undefined' && UI.initialize) {
                UI.initialize();
                console.log('âœ… UIæ¨¡çµ„åˆå§‹åŒ–å®Œæˆ');
            } else {
                console.error('âŒ UIæ¨¡çµ„åˆå§‹åŒ–å¤±æ•—');
            }
            
            // åˆå§‹åŒ–ç·¨è¼¯å™¨æ¨¡çµ„
            if (typeof Editor !== 'undefined' && Editor.initialize) {
                Editor.initialize();
                console.log('âœ… ç·¨è¼¯å™¨æ¨¡çµ„åˆå§‹åŒ–å®Œæˆ');
            } else {
                console.error('âŒ ç·¨è¼¯å™¨æ¨¡çµ„åˆå§‹åŒ–å¤±æ•—');
            }
            
            // åˆå§‹åŒ–WebSocketç®¡ç†å™¨
            if (typeof wsManager !== 'undefined' && wsManager.initialize) {
                wsManager.initialize();
                console.log('âœ… WebSocketç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');
            } else {
                console.error('âŒ WebSocketç®¡ç†å™¨åˆå§‹åŒ–å¤±æ•—');
            }
            
            // åˆå§‹åŒ–AIåŠ©æ•™
            if (typeof AIAssistant !== 'undefined' && AIAssistant.initialize) {
                AIAssistant.initialize();
                console.log('âœ… AIåŠ©æ•™æ¨¡çµ„åˆå§‹åŒ–å®Œæˆ');
            } else {
                console.error('âŒ AIåŠ©æ•™æ¨¡çµ„åˆå§‹åŒ–å¤±æ•—');
            }
            
            // åˆå§‹åŒ–èŠå¤©ç³»çµ±
            if (typeof Chat !== 'undefined' && Chat.initialize) {
                Chat.initialize();
                console.log('âœ… èŠå¤©ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
            } else {
                console.error('âŒ èŠå¤©ç³»çµ±åˆå§‹åŒ–å¤±æ•—');
            }
            
            console.log('âœ¨ æ¨¡çµ„åˆå§‹åŒ–å®Œæˆ');
            
            // é è¨­é¡¯ç¤ºAIåŠ©æ•™
            if (typeof UI !== 'undefined' && UI.switchToAI) {
                UI.switchToAI();
                console.log('âœ… AIåŠ©æ•™å·²è¨­ç‚ºé è¨­é¡¯ç¤º');
            } else {
                console.error('âŒ ç„¡æ³•è¨­ç½®é è¨­ç•Œé¢ï¼ŒUIæœªå®šç¾©');
            }
        });
    </script>
</body>
</html> 