<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡çªæª¢æ¸¬å¿«é€Ÿæ¸¬è©¦</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { 
            background: #f8f9fa;
            padding: 20px;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .editor-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            border: 1px solid #dee2e6;
        }
        .editor-section.connected {
            border-color: #28a745;
            background: #f8fff9;
        }
        textarea {
            width: 100%;
            height: 150px;
            font-family: monospace;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }
        .status-log {
            background: #f1f3f4;
            border-radius: 4px;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .conflict-alert {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="text-center mb-4">ğŸ”¥ Ratchet WebSocket è¡çªæª¢æ¸¬æ¸¬è©¦</h1>
        
        <!-- æœå‹™å™¨ç‹€æ…‹ -->
        <div class="alert alert-info">
            <strong>WebSocketç‹€æ…‹:</strong> <span id="wsStatus">æª¢æŸ¥ä¸­...</span><br>
            <strong>æˆ¿é–“ID:</strong> <span id="currentRoomId">-</span>
        </div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="card mb-3">
            <div class="card-body">
                <h5>æ¸¬è©¦æ§åˆ¶</h5>
                <button class="btn btn-primary me-2" onclick="connectBothEditors()">ğŸ”— é€£æ¥é›™ç·¨è¼¯å™¨</button>
                <button class="btn btn-warning me-2" onclick="simulateConflict()">âš¡ æ¨¡æ“¬è¡çª</button>
                <button class="btn btn-danger me-2" onclick="testSameLineConflict()">ğŸš¨ åŒè¡Œè¡çªæ¸¬è©¦</button>
                <button class="btn btn-success me-2" onclick="openRealEditors()">ğŸ–¥ï¸ æ‰“é–‹çœŸå¯¦ç·¨è¼¯å™¨</button>
                <button class="btn btn-secondary me-2" onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥èªŒ</button>
            </div>
        </div>

        <!-- è¡çªè­¦å‘Šå€åŸŸ -->
        <div id="conflictAlert" class="conflict-alert">
            <h5>ğŸš¨ æª¢æ¸¬åˆ°è¡çª!</h5>
            <div id="conflictDetails"></div>
            <button class="btn btn-sm btn-success me-2" onclick="resolveConflict('accept')">åŒæ„ä¿®æ”¹</button>
            <button class="btn btn-sm btn-danger me-2" onclick="resolveConflict('reject')">æ‹’çµ•ä¿®æ”¹</button>
            <button class="btn btn-sm btn-info me-2" onclick="resolveConflict('ai_analyze')">AIåˆ†æ</button>
        </div>

        <!-- ç·¨è¼¯å™¨A -->
        <div class="editor-section" id="editorSectionA">
            <h5>ğŸ“ ç·¨è¼¯å™¨A (å¼µä¸‰ - zhang_san) <span id="statusA" class="badge bg-secondary">æœªé€£æ¥</span></h5>
            <textarea id="codeA" oninput="onCodeChangeA()">def hello():
    print("Hello from å¼µä¸‰")
    return "A"</textarea>
            <button class="btn btn-sm btn-outline-primary mt-2" onclick="sendCodeA()">ç™¼é€è®Šæ›´A</button>
            <button class="btn btn-sm btn-outline-info mt-2" onclick="loadCodeFromServer('A')">è¼‰å…¥æœå‹™å™¨ä»£ç¢¼A</button>
        </div>

        <!-- ç·¨è¼¯å™¨B -->
        <div class="editor-section" id="editorSectionB">
            <h5>ğŸ“ ç·¨è¼¯å™¨B (æå›› - li_si) <span id="statusB" class="badge bg-secondary">æœªé€£æ¥</span></h5>
            <textarea id="codeB" oninput="onCodeChangeB()">def hello():
    print("Hello from æå››")
    return "B"</textarea>
            <button class="btn btn-sm btn-outline-primary mt-2" onclick="sendCodeB()">ç™¼é€è®Šæ›´B</button>
            <button class="btn btn-sm btn-outline-info mt-2" onclick="loadCodeFromServer('B')">è¼‰å…¥æœå‹™å™¨ä»£ç¢¼B</button>
        </div>

        <!-- ç‹€æ…‹æ—¥èªŒ -->
        <div class="card">
            <div class="card-body">
                <h5>ğŸ“‹ æ¸¬è©¦æ—¥èªŒ</h5>
                <div id="statusLog" class="status-log"></div>
            </div>
        </div>
    </div>

    <script>
        let wsA = null;
        let wsB = null;
        const testRoomId = Math.floor(Math.random() * 1000) + 1;
        const userIdA = 'zhang_san';
        const usernameA = 'å¼µä¸‰';
        const userIdB = 'li_si';
        const usernameB = 'æå››';
        let currentConflictId = null;
        let lastCodeA = document.getElementById('codeA').value;
        let lastCodeB = document.getElementById('codeB').value;
        let codeChangeTimerA = null;
        let codeChangeTimerB = null;

        // æ›´æ–°æˆ¿é–“IDé¡¯ç¤º
        document.getElementById('currentRoomId').textContent = testRoomId;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('statusLog');
            const colorClass = type === 'error' ? 'text-danger' : 
                              type === 'success' ? 'text-success' : 
                              type === 'warning' ? 'text-warning' : 'text-muted';
            logDiv.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('statusLog').innerHTML = '';
            log('æ—¥èªŒå·²æ¸…ç©º');
        }

        function updateWSStatus() {
            const statusAOpen = wsA && wsA.readyState === WebSocket.OPEN;
            const statusBOpen = wsB && wsB.readyState === WebSocket.OPEN;
            
            document.getElementById('statusA').textContent = statusAOpen ? 'å·²é€£æ¥' : 'æœªé€£æ¥';
            document.getElementById('statusA').className = statusAOpen ? 'badge bg-success' : 'badge bg-secondary';
            
            document.getElementById('statusB').textContent = statusBOpen ? 'å·²é€£æ¥' : 'æœªé€£æ¥';
            document.getElementById('statusB').className = statusBOpen ? 'badge bg-success' : 'badge bg-secondary';
            
            document.getElementById('editorSectionA').className = statusAOpen ? 'editor-section connected' : 'editor-section';
            document.getElementById('editorSectionB').className = statusBOpen ? 'editor-section connected' : 'editor-section';
            
            const wsStatus = document.getElementById('wsStatus');
            if (statusAOpen && statusBOpen) {
                wsStatus.innerHTML = '<span class="text-success">âœ… é›™ç·¨è¼¯å™¨å·²é€£æ¥</span>';
            } else if (statusAOpen || statusBOpen) {
                wsStatus.innerHTML = '<span class="text-warning">âš ï¸ éƒ¨åˆ†é€£æ¥</span>';
            } else {
                wsStatus.innerHTML = '<span class="text-danger">âŒ æœªé€£æ¥</span>';
            }
        }

        function connectEditor(editorId, wsVar, userId, username) {
            log(`é–‹å§‹é€£æ¥ç·¨è¼¯å™¨ ${editorId} (${username}) åˆ° ws://localhost:8080`, 'info');
            let ws = new WebSocket('ws://localhost:8080');
            
            ws.onopen = function() {
                log(`ç·¨è¼¯å™¨ ${editorId} WebSocketé€£æ¥æˆåŠŸ`, 'success');
                const joinMessage = {
                    type: 'join_room',
                    room_id: testRoomId,
                    user_id: userId,
                    username: username
                };
                ws.send(JSON.stringify(joinMessage));
                log(`ç·¨è¼¯å™¨ ${editorId} ç™¼é€åŠ å…¥æˆ¿é–“: ${JSON.stringify(joinMessage)}`, 'info');
                if (editorId === 'A') wsA = ws; else wsB = ws;
                updateWSStatus();
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                log(`ç·¨è¼¯å™¨ ${editorId} æ”¶åˆ°: ${data.type} (ä¾†è‡ª ${data.username || data.user_id || 'æœå‹™å™¨'}) - ${data.message || (data.code ? data.code.substring(0,30)+'...' : JSON.stringify(data).substring(0,50)+'...')} `,'info');
                handleWebSocketMessage(editorId, data);
            };
            
            ws.onerror = function(errorEvent) {
                log(`ç·¨è¼¯å™¨ ${editorId} WebSocketéŒ¯èª¤: ${errorEvent.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                if (editorId === 'A') wsA = null; else wsB = null;
                updateWSStatus();
            };
            
            ws.onclose = function(closeEvent) {
                log(`ç·¨è¼¯å™¨ ${editorId} WebSocketé€£æ¥é—œé–‰ (Code: ${closeEvent.code}, Reason: ${closeEvent.reason || 'N/A'})`, 'warning');
                if (editorId === 'A') wsA = null; else wsB = null;
                updateWSStatus();
            };
            return ws;
        }

        function connectBothEditors() {
            if (wsA && wsA.readyState === WebSocket.OPEN) wsA.close();
            if (wsB && wsB.readyState === WebSocket.OPEN) wsB.close();
            wsA = connectEditor('A', wsA, userIdA, usernameA);
            // Small delay to avoid potential race conditions on server or client when establishing multiple connections too quickly
            setTimeout(() => {
                 wsB = connectEditor('B', wsB, userIdB, usernameB);
            }, 200);
        }

        function handleWebSocketMessage(editorId, data) {
            switch(data.type) {
                case 'room_joined':
                    log(`âœ… ç·¨è¼¯å™¨ ${editorId} (${data.username}) æˆåŠŸåŠ å…¥æˆ¿é–“ ${data.room_id}`, 'success');
                    if(data.initial_code !== undefined) {
                         if (editorId === 'A') {
                            document.getElementById('codeA').value = data.initial_code;
                            lastCodeA = data.initial_code;
                        } else if (editorId === 'B') {
                            document.getElementById('codeB').value = data.initial_code;
                            lastCodeB = data.initial_code;
                        }
                        log(`ğŸ“ ç·¨è¼¯å™¨ ${editorId} è¼‰å…¥åˆå§‹ä»£ç¢¼ (é•·åº¦: ${data.initial_code.length})`, 'info');
                    }
                    break;
                case 'user_joined':
                    log(`ğŸ‘¤ ç”¨æˆ¶ ${data.username} (${data.user_id}) åŠ å…¥æˆ¿é–“ ${data.room_id}`, 'info');
                    break;
                case 'user_left':
                    log(`ğŸšª ç”¨æˆ¶ ${data.username} (${data.user_id}) é›¢é–‹æˆ¿é–“ ${data.room_id}`, 'warning');
                    break;
                case 'code_changed': // Server sends 'code_changed'
                    log(`ğŸ”„ ç·¨è¼¯å™¨ ${editorId} æ”¶åˆ°ä»£ç¢¼è®Šæ›´ (ä¾†è‡ª ${data.username}, ${data.user_id})`, 'info');
                    if (data.code !== undefined) {
                        if (editorId === 'A' && data.user_id === userIdB) { // Editor A receives change from B
                            if (data.code !== document.getElementById('codeA').value) {
                                document.getElementById('codeA').value = data.code;
                                lastCodeA = data.code;
                                log(`ğŸ“ ç·¨è¼¯å™¨Aå·²åŒæ­¥ä¾†è‡ª ${data.username} çš„ä»£ç¢¼`, 'success');
                            }
                        } else if (editorId === 'B' && data.user_id === userIdA) { // Editor B receives change from A
                            if (data.code !== document.getElementById('codeB').value) {
                                document.getElementById('codeB').value = data.code;
                                lastCodeB = data.code;
                                log(`ğŸ“ ç·¨è¼¯å™¨Bå·²åŒæ­¥ä¾†è‡ª ${data.username} çš„ä»£ç¢¼`, 'success');
                            }
                        }
                    }
                    break;
                case 'conflict_detected':
                    log(`ğŸš¨ ç·¨è¼¯å™¨ ${editorId} æª¢æ¸¬åˆ°è¡çª! (ID: ${data.conflict_id})`, 'warning');
                    showConflictAlert(data);
                    break;
                case 'conflict_resolved':
                    log(`âœ… ç·¨è¼¯å™¨ ${editorId} è¡çªå·²è§£æ±º (ID: ${data.conflict_id})`, 'success');
                    hideConflictAlert();
                    // Potentially re-sync code if server sends resolved code
                    if (data.resolved_code !== undefined) {
                        document.getElementById('codeA').value = data.resolved_code;
                        document.getElementById('codeB').value = data.resolved_code;
                        lastCodeA = data.resolved_code;
                        lastCodeB = data.resolved_code;
                        log(`ğŸ“ é›™ç·¨è¼¯å™¨å·²åŒæ­¥è§£æ±ºå¾Œçš„ä»£ç¢¼ (ç‰ˆæœ¬: ${data.version || 'N/A'})`, 'success');
                    }
                    break;
                case 'error':
                    log(`âŒ ç·¨è¼¯å™¨ ${editorId} æ”¶åˆ°æœå‹™å™¨éŒ¯èª¤: ${data.message}`, 'error');
                    break;
                default:
                    log(`ğŸ“¨ ç·¨è¼¯å™¨ ${editorId} æ”¶åˆ°æœªçŸ¥æœå‹™å™¨æ¶ˆæ¯: ${data.type}`, 'info');
            }
        }

        function showConflictAlert(conflictData) {
            currentConflictId = conflictData.conflict_id;
            let detailsHtml = `<p><strong>è¡çªID:</strong> ${conflictData.conflict_id}</p>
                               <p><strong>è¡çªé¡å‹:</strong> ${conflictData.conflict_type || (conflictData.type === 'same_line_conflict' ? 'åŒè¡Œä¿®æ”¹' : 'ä»£ç¢¼è¡çª')}</p>
                               <p><strong>æè¿°:</strong> ${conflictData.description || conflictData.message || 'æª¢æ¸¬åˆ°ä»£ç¢¼è¡çª'}</p>`;
            if (conflictData.conflict_lines && conflictData.conflict_lines.length > 0) {
                detailsHtml += '<h5>è¡çªè¡Œ:</h5><ul>';
                conflictData.conflict_lines.forEach(line => {
                    detailsHtml += `<li>è¡Œ ${line.line_number}: åŸ='${line.original}', ä»–='${line.other_user}', ä½ ='${line.current_user}'</li>`;
                });
                detailsHtml += '</ul>';
            }
            document.getElementById('conflictDetails').innerHTML = detailsHtml;
            document.getElementById('conflictAlert').style.display = 'block';
        }

        function hideConflictAlert() {
            document.getElementById('conflictAlert').style.display = 'none';
            currentConflictId = null;
        }

        function resolveConflict(resolutionType) {
            if (!currentConflictId) {
                log('æ²’æœ‰å¾…è§£æ±ºçš„è¡çª', 'warning');
                return;
            }
            const activeWs = (wsA && wsA.readyState === WebSocket.OPEN) ? wsA : ((wsB && wsB.readyState === WebSocket.OPEN) ? wsB : null);
            if (!activeWs) {
                log('æ²’æœ‰å¯ç”¨çš„WebSocketé€£æ¥ä¾†è§£æ±ºè¡çª', 'error');
                return;
            }
            const resolutionMessage = {
                type: 'conflict_resolution',
                room_id: testRoomId,
                conflict_id: currentConflictId,
                resolution: resolutionType,
                // The user resolving the conflict. Assuming Zhang San (Editor A) is the main resolver here for simplicity.
                user_id: userIdA 
            };
            activeWs.send(JSON.stringify(resolutionMessage));
            log(`ç™¼é€è¡çªè§£æ±ºè«‹æ±‚: ${resolutionType} (è¡çªID: ${currentConflictId})`, 'info');
            // Optimistically hide, server will confirm with 'conflict_resolved' and new code
            // hideConflictAlert(); 
        }

        function sendCode(editorId, ws, userId, codeContent) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log(`ç·¨è¼¯å™¨ ${editorId} æœªé€£æ¥ï¼Œç„¡æ³•ç™¼é€ä»£ç¢¼`, 'error');
                return false;
            }
            const message = {
                type: 'code_change',
                room_id: testRoomId,
                user_id: userId,
                code: codeContent,
                change_type: 'edit' // Or determine based on actual change if more granular
            };
            ws.send(JSON.stringify(message));
            log(`ç·¨è¼¯å™¨ ${editorId} (${userId}) ç™¼é€ä»£ç¢¼ (é•·åº¦: ${codeContent.length})`, 'info');
            return true;
        }

        function sendCodeA() {
            const code = document.getElementById('codeA').value;
            if(sendCode('A', wsA, userIdA, code)) lastCodeA = code;
        }

        function sendCodeB() {
            const code = document.getElementById('codeB').value;
            if(sendCode('B', wsB, userIdB, code)) lastCodeB = code;
        }

        function onCodeChangeA() {
            clearTimeout(codeChangeTimerA);
            codeChangeTimerA = setTimeout(() => {
                const code = document.getElementById('codeA').value;
                if (code !== lastCodeA) {
                    sendCodeA();
                }
            }, 500);
        }

        function onCodeChangeB() {
            clearTimeout(codeChangeTimerB);
            codeChangeTimerB = setTimeout(() => {
                const code = document.getElementById('codeB').value;
                if (code !== lastCodeB) {
                    sendCodeB();
                }
            }, 500);
        }
        
        function loadCodeFromServer(editorId) {
            const ws = (editorId === 'A') ? wsA : wsB;
            const userId = (editorId === 'A') ? userIdA : userIdB;
            if (ws && ws.readyState === WebSocket.OPEN) {
                log(`ç·¨è¼¯å™¨ ${editorId} (${userId}) è«‹æ±‚å¾æœå‹™å™¨è¼‰å…¥ä»£ç¢¼...`, 'info');
                ws.send(JSON.stringify({
                    type: 'load_code', // Ensure server handles this type
                    room_id: testRoomId,
                    user_id: userId
                }));
            } else {
                log(`ç·¨è¼¯å™¨ ${editorId} æœªé€£æ¥ï¼Œç„¡æ³•è¼‰å…¥ä»£ç¢¼`, 'error');
            }
        }

        function simulateConflict() {
            if (!wsA || wsA.readyState !== WebSocket.OPEN || !wsB || wsB.readyState !== WebSocket.OPEN) {
                log('è«‹å…ˆé€£æ¥é›™ç·¨è¼¯å™¨', 'error');
                return;
            }
            log('ğŸ”¥ é–‹å§‹æ¨¡æ“¬è¡çª (å¿«é€Ÿé€£çºŒç™¼é€ä¸åŒä»£ç¢¼)...', 'warning');
            const codeAVal = document.getElementById('codeA').value;
            const codeBVal = document.getElementById('codeB').value;
            // Ensure they are different to actually cause a change
            if (codeAVal === codeBVal) {
                 document.getElementById('codeA').value = codeAVal + "\n# Açš„ä¿®æ”¹";
            }
            // Send A's current (potentially modified) code
            sendCode('A', wsA, userIdA, document.getElementById('codeA').value);
            // Then, after a short delay, send B's current code
            setTimeout(() => {
                sendCode('B', wsB, userIdB, document.getElementById('codeB').value);
            }, 100); // Short delay to ensure server processes A's change first, then B's as a conflicting one
        }

        function testSameLineConflict() {
            log('æº–å‚™åŒè¡Œè¡çªæ•¸æ“š...', 'info');
            document.getElementById('codeA').value = `def main():\n    print("å¼µä¸‰çš„ç‰ˆæœ¬ - V1") # Line 2 by ZhangSan\n    return 1`;
            lastCodeA = document.getElementById('codeA').value;
            document.getElementById('codeB').value = `def main():\n    print("æå››çš„ç‰ˆæœ¬ - V1") # Line 2 by LiSi\n    return 1`;
            lastCodeB = document.getElementById('codeB').value;
            log('ğŸ“ å·²è¨­ç½®åŒè¡Œè¡çªä»£ç¢¼ã€‚è«‹å…ˆã€Œé€£æ¥é›™ç·¨è¼¯å™¨ã€ï¼Œç„¶å¾Œã€Œæ‰‹å‹•å„è‡ªç™¼é€ä¸€æ¬¡è®Šæ›´ã€ï¼Œæˆ–ç›´æ¥é»æ“Šã€Œæ¨¡æ“¬è¡çªã€', 'info');
        }

        function openRealEditors() {
            const urlA = `http://localhost:8000/frontend/editor.php?room_id=${testRoomId}&user_id=${userIdA}&username=${usernameA}&role=main_changer`;
            const urlB = `http://localhost:8000/frontend/editor.php?room_id=${testRoomId}&user_id=${userIdB}&username=${usernameB}&role=secondary_changer`;
            window.open(urlA, '_blank', 'width=800,height=600,left=50,top=50,noopener,noreferrer');
            window.open(urlB, '_blank', 'width=800,height=600,left=900,top=50,noopener,noreferrer');
            log(`ğŸ–¥ï¸ å·²æ‰“é–‹çœŸå¯¦ç·¨è¼¯å™¨çª—å£ (æˆ¿é–“ID: ${testRoomId})`, 'success');
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            log('ğŸš€ Ratchet WebSocket è¡çªæª¢æ¸¬æ¸¬è©¦é é¢å·²è¼‰å…¥');
            log(`è¨­å®šæˆ¿é–“ID: ${testRoomId}, å¼µä¸‰ (${userIdA}), æå›› (${userIdB})`);
            updateWSStatus();
        };

        // é é¢é—œé–‰æ™‚æ¸…ç†é€£æ¥
        window.onbeforeunload = function() {
            if (wsA && wsA.readyState === WebSocket.OPEN) wsA.close();
            if (wsB && wsB.readyState === WebSocket.OPEN) wsB.close();
        };
    </script>
</body>
</html> 