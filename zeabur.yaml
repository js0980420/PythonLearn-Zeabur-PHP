# Zeabur éƒ¨ç½²é…ç½® - é›™æœå‹™æ¶æ§‹ (ç©©å®šç‰ˆ)
name: python-learn

services:
  # ä¸»è¦ Web æœå‹™ (PHP + WebSocket)
  web:
    build:
      dockerfile: Dockerfile.zeabur
    
    # ç’°å¢ƒè®Šæ•¸é…ç½®
    env:
      # WebSocket æœå‹™å™¨é…ç½®
      WEBSOCKET_HOST: "0.0.0.0"
      WEBSOCKET_PORT: "8081"
      
      # PHP é…ç½®
      PHP_MEMORY_LIMIT: "256M"
      PHP_MAX_EXECUTION_TIME: "300"
      
      # æ‡‰ç”¨é…ç½®
      APP_ENV: "production"
      DEBUG_MODE: "false"
      
      # AI é…ç½® (å¾ Zeabur ç’°å¢ƒè®Šæ•¸)
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: ${OPENAI_MODEL}
      OPENAI_MAX_TOKENS: ${OPENAI_MAX_TOKENS}
      
      # æ•¸æ“šåº«é…ç½® (å¾ Zeabur ç’°å¢ƒè®Šæ•¸)
      MYSQL_HOST: ${MYSQL_HOST}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_PORT: ${MYSQL_PORT}
    
    # æš´éœ²ç«¯å£ (å…§éƒ¨é€šä¿¡)
    ports:
      - 8080  # HTTP æœå‹™
      - 8081  # WebSocket æœå‹™
    
    # å¥åº·æª¢æŸ¥
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health.php"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Caddy åå‘ä»£ç†æœå‹™
  caddy:
    build:
      dockerfile: Dockerfile.caddy
    
    # ç’°å¢ƒè®Šæ•¸
    env:
      # Zeabur æœƒè‡ªå‹•è¨­ç½®é€™å€‹è®Šæ•¸
      ZEABUR_WEB_DOMAIN: ${ZEABUR_WEB_DOMAIN}
    
    # æš´éœ²ç«¯å£ (å°å¤–æœå‹™)
    ports:
      - 80
      - 443
    
    # ä¾è³´ web æœå‹™
    depends_on:
      - web
    
    # å¥åº·æª¢æŸ¥
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2019/metrics"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

# å…¨åŸŸé…ç½®
configs:
  # è‡ªå‹•é‡å•Ÿé…ç½®
  restart_policy:
    condition: on-failure
    max_attempts: 3
    delay: 10s
  
  # æ—¥èªŒé…ç½®
  logging:
    driver: json-file
    options:
      max-size: "10m"
      max-file: "3"

# ğŸŒ ç¶²è·¯é…ç½®
networks:
  default:
    driver: bridge

# ğŸ“Š ç›£æ§é…ç½®
monitoring:
  enabled: true
  metrics:
    - name: http_requests_total
      type: counter
      help: "Total HTTP requests"
    
    - name: websocket_connections
      type: gauge
      help: "Active WebSocket connections"
    
    - name: caddy_requests_total
      type: counter
      help: "Total Caddy proxy requests"
    
    - name: ai_requests_total
      type: counter
      help: "Total AI assistant requests"
    
    - name: python_executions_total
      type: counter
      help: "Total Python code executions"

# ğŸ” å¯†é‘°ç®¡ç†
secrets:
  openai-api-key:
    external: true
    name: OPENAI_API_KEY

# å·é…ç½®
volumes:
  mysql_data:
    driver: local

# å¥åº·æª¢æŸ¥é…ç½®
healthcheck:
  web:
    path: /health.php
    interval: 30s
    timeout: 10s
    
  caddy:
    port: 80
    interval: 30s
    timeout: 10s

# ç’°å¢ƒè®Šæ•¸é…ç½®
env:
  # OpenAI API å¯†é‘°ï¼ˆéœ€è¦åœ¨ Zeabur æ§åˆ¶å°è¨­ç½®ï¼‰
  OPENAI_API_KEY:
    type: secret
    
  # åŸŸåï¼ˆZeabur è‡ªå‹•è¨­ç½®ï¼‰
  ZEABUR_DOMAIN:
    type: auto 