name: ğŸ¤– Cursor Background Agent Setup
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  setup-development-environment:
    name: ğŸ”§ é–‹ç™¼ç’°å¢ƒè¨­ç½®
    runs-on: ubuntu-latest

    strategy:
      matrix:
        php: ["8.1", "8.2"]
        node: ["18", "20"]

    steps:
      - name: ğŸ“¥ ç²å–ä»£ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ˜ è¨­ç½® PHP ${{ matrix.php }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, xml, ctype, json, curl, dom, fileinfo, ftp, gd, hash, iconv, libxml, openssl, pcre, pdo, session, tokenizer, zip, sockets
          ini-values: post_max_size=256M, upload_max_filesize=256M, memory_limit=512M
          coverage: none

      - name: ğŸŸ¢ è¨­ç½® Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: "npm"

      - name: ğŸ“¦ å®‰è£ Composer ä¾è³´
        run: |
          composer validate --strict
          composer install --prefer-dist --no-progress --optimize-autoloader

      - name: ğŸ”— å®‰è£ NPM ä¾è³´
        run: |
          npm ci
          npx playwright install --with-deps

      - name: ğŸ—„ï¸ å‰µå»ºç›®éŒ„çµæ§‹
        run: |
          mkdir -p public/css public/js data logs sessions storage test-logs playwright-report
          mkdir -p backend/api backend/classes backend/config backend/utils
          mkdir -p websocket config classes vendor
          chmod -R 755 public data logs sessions storage backend websocket config classes

      - name: ğŸ” é©—è­‰é—œéµæ–‡ä»¶
        run: |
          echo "ğŸ” æª¢æŸ¥é—œéµæ–‡ä»¶å­˜åœ¨æ€§..."
          ls -la test-servers/stable-websocket-server.php || echo "âš ï¸ WebSocket æœå‹™å™¨æ–‡ä»¶ä¸å­˜åœ¨"
          ls -la public/index.html || echo "âš ï¸ ä¸»é æ–‡ä»¶ä¸å­˜åœ¨"
          ls -la composer.json && echo "âœ… Composer é…ç½®å­˜åœ¨"
          ls -la package.json && echo "âœ… NPM é…ç½®å­˜åœ¨"

      - name: ğŸ§ª é‹è¡ŒåŸºç¤æ¸¬è©¦
        run: |
          echo "ğŸ§ª é‹è¡Œ PHP èªæ³•æª¢æŸ¥..."
          find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \; || echo "âŒ PHP èªæ³•éŒ¯èª¤"

          echo "ğŸ”Œ æª¢æŸ¥ WebSocket æœå‹™å™¨æ–‡ä»¶..."
          php -l test-servers/stable-websocket-server.php || echo "âŒ WebSocket æœå‹™å™¨èªæ³•éŒ¯èª¤"

      - name: ğŸ“Š ç’°å¢ƒä¿¡æ¯å ±å‘Š
        run: |
          echo "ğŸ“Š ç’°å¢ƒé…ç½®å ±å‘Šï¼š"
          echo "PHPç‰ˆæœ¬: $(php --version | head -n1)"
          echo "Composerç‰ˆæœ¬: $(composer --version)"
          echo "Node.jsç‰ˆæœ¬: $(node --version)"
          echo "NPMç‰ˆæœ¬: $(npm --version)"
          echo "å·¥ä½œç›®éŒ„: $(pwd)"
          echo "ç£ç›¤ç©ºé–“: $(df -h . | tail -1)"

      - name: âœ… è¨­ç½®å®Œæˆç¢ºèª
        run: |
          echo "âœ… Background Agent ç’°å¢ƒè¨­ç½®å®Œæˆï¼"
          echo "ğŸŒ HTTP æœå‹™å™¨æº–å‚™å°±ç·’ (ç«¯å£ 8080)"
          echo "ğŸ”Œ WebSocket æœå‹™å™¨æº–å‚™å°±ç·’ (ç«¯å£ 8081)"
          echo "ğŸ“‚ æ‰€æœ‰å¿…è¦ç›®éŒ„å·²å‰µå»º"
          echo "ğŸ” æ¬Šé™è¨­ç½®å®Œæˆ"
          echo "ğŸ¤– å¯ä»¥ä½¿ç”¨ Cursor Background Agents"

  validate-background-agent-config:
    name: ğŸ” Background Agent é…ç½®é©—è­‰
    runs-on: ubuntu-latest
    needs: setup-development-environment

    steps:
      - name: ğŸ“¥ ç²å–ä»£ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ” é©—è­‰ç’°å¢ƒé…ç½®æ–‡ä»¶
        run: |
          echo "ğŸ” æª¢æŸ¥ .cursor/environment.json..."
          if [ -f ".cursor/environment.json" ]; then
            echo "âœ… ç’°å¢ƒé…ç½®æ–‡ä»¶å­˜åœ¨"
            cat .cursor/environment.json | jq . > /dev/null && echo "âœ… JSON æ ¼å¼æ­£ç¢º" || echo "âŒ JSON æ ¼å¼éŒ¯èª¤"
          else
            echo "âŒ ç’°å¢ƒé…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi

      - name: ğŸ“‹ é…ç½®å…§å®¹æª¢æŸ¥
        run: |
          echo "ğŸ“‹ æª¢æŸ¥é…ç½®å…§å®¹..."

          # æª¢æŸ¥å¿…è¦å­—æ®µ
          jq -e '.name' .cursor/environment.json && echo "âœ… åç¨±å­—æ®µå­˜åœ¨"
          jq -e '.install' .cursor/environment.json && echo "âœ… å®‰è£è…³æœ¬å­˜åœ¨"
          jq -e '.terminals' .cursor/environment.json && echo "âœ… çµ‚ç«¯é…ç½®å­˜åœ¨"
          jq -e '.env' .cursor/environment.json && echo "âœ… ç’°å¢ƒè®Šæ•¸å­˜åœ¨"
          jq -e '.ports' .cursor/environment.json && echo "âœ… ç«¯å£é…ç½®å­˜åœ¨"

          # æª¢æŸ¥ Background Agent ç‰¹å®šè¨­ç½®
          jq -e '.agentCanUpdateSnapshot' .cursor/environment.json && echo "âœ… Agent å¿«ç…§æ›´æ–°æ¬Šé™å·²å•Ÿç”¨"
          jq -e '.agentCanInstallPackages' .cursor/environment.json && echo "âœ… Agent åŒ…å®‰è£æ¬Šé™å·²å•Ÿç”¨"
          jq -e '.agentCanRunScripts' .cursor/environment.json && echo "âœ… Agent è…³æœ¬åŸ·è¡Œæ¬Šé™å·²å•Ÿç”¨"

      - name: âœ… é©—è­‰å®Œæˆ
        run: |
          echo "âœ… Background Agent é…ç½®é©—è­‰å®Œæˆï¼"
          echo "ğŸ¤– Cursor Background Agents å¯ä»¥æ­£å¸¸ä½¿ç”¨æ­¤ç’°å¢ƒ"
